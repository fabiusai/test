
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Test DOCX funzionante</title>
  <!-- Librerie necessarie -->
  <script src="https://unpkg.com/docx@7.7.0/build/index.umd.js" onload="window.docx = docx;"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    body { font-family: Arial; padding: 20px; }
    .btn { padding: 10px 20px; font-size: 16px; margin-top: 20px; cursor: pointer; }
    .preview { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; margin-top: 20px; background: #f9f9f9; }
    #status { margin-top: 20px; color: red; font-weight: bold; }
  </style>
</head>
<body>

<h1>Test esportazione DOCX</h1>

<div id="preview" class="preview">
  <p><b>Sezione 1</b></p>
  <p>Questo è un testo <b>in grassetto</b> e con un a capo.</p>
  <p><b>Sezione 2</b></p>
  <p>Secondo paragrafo con <b>altro grassetto</b>.</p>
</div>

<button class="btn" onclick="exportDocx()">Esporta DOCX</button>

<div id="status"></div>

<script>
function exportDocx() {
  const status = document.getElementById("status");
  if (!window.docx || !window.saveAs) {
    status.textContent = "❌ Le librerie non sono caricate. Controlla la connessione o l'inclusione degli script.";
    return;
  }

  try {
    const html = document.getElementById('preview').innerHTML;
    const paragraphs = html.split(/<\/p>/i).filter(p => p.trim());

    const docParagraphs = paragraphs.map(p => {
      p = p.replace(/<p[^>]*>/gi, '');
      const runs = [];
      let lastIndex = 0;
      const boldRegex = /<b>(.*?)<\/b>/gi;
      let match;
      while ((match = boldRegex.exec(p)) !== null) {
        const plainText = p.substring(lastIndex, match.index).replace(/<[^>]+>/g, '');
        if (plainText.trim()) runs.push(new window.docx.TextRun(plainText));
        runs.push(new window.docx.TextRun({ text: match[1], bold: true }));
        lastIndex = boldRegex.lastIndex;
      }
      const tail = p.substring(lastIndex).replace(/<[^>]+>/g, '');
      if (tail.trim()) runs.push(new window.docx.TextRun(tail));
      return new window.docx.Paragraph({ children: runs });
    });

    const doc = new window.docx.Document({ sections: [{ children: docParagraphs }] });

    window.docx.Packer.toBlob(doc).then(blob => {
      window.saveAs(blob, "report.docx");
      status.textContent = "✅ Documento esportato correttamente.";
      status.style.color = "green";
    });
  } catch (err) {
    console.error(err);
    status.textContent = "❌ Errore durante l'esportazione. Guarda la console.";
  }
}
</script>

</body>
</html>
