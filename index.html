<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Mensile Followers</title>
    <link rel="icon" href="favicon.ico">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:opsz,wght@6..12,400;6..12,700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Colori UI Principali (Header, Bottoni, etc) */
            --primary-ui-blue: #004282;
            --primary-ui-yellow: #ffd400;
            
            /* Colori Grafico dal UI Kit */
            --chart-title-blue: #0431AE;
            --chart-bar-blue: #bfd7fd;
            --chart-text-grey: #7b7b7a;
            
            /* Colori Generali */
            --background-color: #f4f7fa;
            --text-color: #333333;
            --card-background: #ffffff;
            --border-color: #e0e0e0;
            --font-family: 'Nunito Sans', 'Helvetica Neue', Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        header {
            background-color: var(--primary-ui-blue);
            color: white;
            padding: 1.5rem 2rem;
            text-align: center;
            border-bottom: 5px solid var(--primary-ui-yellow);
        }
        
        .main-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .upload-section {
            background-color: var(--card-background);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            text-align: center;
            margin-bottom: 2rem;
        }

        .upload-section h2 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            color: var(--primary-ui-blue);
        }

        .drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 3rem 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .drop-zone.dragover {
            background-color: #e9f5ff;
            border-color: var(--primary-ui-blue);
        }

        .drop-zone p {
            margin: 0;
            font-size: 1.1rem;
            color: #666;
        }
        
        .file-input {
            display: none;
        }
        
        .button-nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .nav-button {
            background-color: #fff;
            color: var(--primary-ui-blue);
            border: 2px solid var(--primary-ui-blue);
            padding: 0.6rem 1.2rem;
            border-radius: 9999px;
            cursor: pointer;
            font-weight: 700;
            transition: background-color 0.3s, color 0.3s;
            font-family: var(--font-family);
            font-size: 0.9rem;
        }

        .nav-button:hover, .nav-button.active {
            background-color: var(--primary-ui-blue);
            color: white;
        }

        /* Stile specifico per il tasto Executive Summary */
        .exec-summary-btn {
            background-color: var(--primary-ui-yellow);
            color: var(--primary-ui-blue);
            border: 2px solid var(--primary-ui-yellow);
        }
        .exec-summary-btn:hover {
            background-color: #e6c200; /* Giallo leggermente più scuro */
            color: var(--primary-ui-blue);
            border-color: #e6c200;
        }

        .report-section {
            background-color: var(--card-background);
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .hidden {
            display: none;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .data-item, .table-wrapper, .chart-wrapper {
            background-color: #f8f9fc;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            position: relative;
        }
        
        .data-item h3, .table-wrapper h3 {
            font-size: 1.1rem;
            color: var(--primary-ui-blue);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .data-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-ui-blue);
        }

        .data-change {
            font-size: 1rem;
            font-weight: 700;
        }

        .positive { color: #28a745; }
        .negative { color: #dc3545; }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.8rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.95rem;
        }

        th {
            background-color: #eef2f7;
            font-weight: 700;
            color: var(--primary-ui-blue);
        }

        tr:last-child td {
            border-bottom: none;
        }
        
        tr:nth-child(even) {
            background-color: #fdfdfd;
        }

        .copy-button, .export-svg-btn, .copy-svg-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            color: #495057;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .copy-button:hover, .export-svg-btn:hover, .copy-svg-btn:hover {
            background-color: #dee2e6;
        }

        .chart-controls {
            position: static;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .chart-controls .export-svg-btn, .chart-controls .copy-svg-btn {
            position: static;
            width: auto;
            height: auto;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .chart-controls .copy-svg-btn {
           background-color: var(--primary-ui-blue);
           color: white;
           border-color: var(--primary-ui-blue);
        }
        .chart-controls .copy-svg-btn:hover {
            background-color: #003366;
        }
        
        .chart-container {
            width: 100%;
        }

        /* Stili per il grafico SVG */
        .benchmark-chart, .platform-chart {
            width: 100%;
            height: auto;
        }
        .benchmark-chart .axis-label, .benchmark-chart .tick text,
        .platform-chart .axis-label, .platform-chart .tick text {
            font-family: 'Nunito Sans', sans-serif;
            font-weight: 400;
            fill: var(--chart-text-grey);
        }
        .benchmark-chart .bar-label,
        .platform-chart .bar-label {
            font-family: 'Nunito Sans', sans-serif;
            font-weight: 700;
            fill: var(--chart-title-blue);
        }
        .benchmark-chart .grid-line {
            stroke: #e0e0e0;
            stroke-dasharray: 2,2;
        }
        .platform-chart .grid-line {
            stroke: #cccccc; /* Rese più visibili */
        }

        #loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-ui-blue);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
    </div>

    <header>
        <h1 class="text-3xl font-bold">Report Mensile Followers</h1>
    </header>

    <main class="main-container">

        <section class="upload-section" id="whatsapp-input-section">
            <h2>Dati Canale WhatsApp (Opzionale)</h2>
            <div class="grid md:grid-cols-2 gap-6 max-w-lg mx-auto">
                <div>
                    <label for="whatsapp-previous" class="block text-sm font-medium text-gray-700 text-left mb-1">Iscritti mese precedente</label>
                    <input type="number" id="whatsapp-previous" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Es. 1200">
                </div>
                <div>
                    <label for="whatsapp-current" class="block text-sm font-medium text-gray-700 text-left mb-1">Iscritti mese corrente</label>
                    <input type="number" id="whatsapp-current" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Es. 1500">
                </div>
            </div>
        </section>
        <section class="upload-section">
            <h2>Carica i file Excel</h2>
            <div id="drop-zone" class="drop-zone">
                <input type="file" id="file-input" multiple class="file-input" accept=".xlsx, .xls, .csv">
                <p>Trascina i file qui o clicca per selezionarli</p>
            </div>
        </section>

        <div id="report-content" class="hidden">
            <nav id="button-nav" class="button-nav"></nav>
            <div id="sections-wrapper"></div>
        </div>
    </main>

    <script>
    // Variabile globale per immagazzinare i loghi scaricati
    let fetchedLogos = null;

    document.addEventListener('DOMContentLoaded', () => {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const reportContent = document.getElementById('report-content');
        const buttonNav = document.getElementById('button-nav');
        const sectionsWrapper = document.getElementById('sections-wrapper');
        const loader = document.getElementById('loader');

        // Fetch dei loghi all'avvio
        fetch('https://fabiusai.github.io/MensileFans/logos.json')
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                fetchedLogos = data;
                console.log("Logos caricati con successo");
            })
            .catch(error => {
                console.error('Errore nel caricamento dei loghi:', error);
                fetchedLogos = {}; // Fallback oggetto vuoto
            });

        // Gestione Drag & Drop
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length) {
                fileInput.files = files;
                handleFiles(files);
            }
        });
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                handleFiles(fileInput.files);
            }
        });

        function showLoader() { loader.style.display = 'flex'; }
        function hideLoader() { loader.style.display = 'none'; }

        async function handleFiles(files) {
            showLoader();
            
            // 1. Identifica ed elabora eventuale file WhatsApp per precompilare i campi input
            for (const file of files) {
                if (file.name.toLowerCase().includes('whatsapp') && (file.name.endsWith('.xlsx') || file.name.endsWith('.csv') || file.name.endsWith('.xls'))) {
                    try {
                        const data = await file.arrayBuffer();
                        const wb = XLSX.read(data);
                        const sheet = wb.Sheets[wb.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        
                        // Cerca righe con date valide (colonna 0)
                        const rows = json.filter(r => r && r[0] && (String(r[0]).match(/\d/) || typeof r[0] === 'number'));
                        
                        // Parsing date e valori per ordinamento
                        const parsedRows = rows.map(r => {
                            let dateVal = r[0];
                            // Gestione data manuale per formato DD/MM/YYYY
                            if(typeof dateVal === 'string' && dateVal.includes('/')) {
                                const parts = dateVal.split('/');
                                dateVal = new Date(parts[2], parts[1]-1, parts[0]);
                            } else if (typeof dateVal === 'number') {
                                // Gestione data seriale Excel
                                dateVal = new Date((dateVal - (25567 + 2))*86400*1000); 
                            } else {
                                dateVal = new Date(dateVal);
                            }

                            let numVal = r[1];
                            if (typeof numVal === 'string') {
                                // Pulisce stringhe tipo "3.330.000 " togliendo punti e spazi
                                numVal = parseInt(numVal.replace(/\./g, '').replace(/\s/g, ''), 10);
                            }
                            return { date: dateVal, val: numVal || 0 };
                        }).sort((a,b) => a.date - b.date);

                        // Se abbiamo almeno 2 record, prendiamo gli ultimi due
                        if (parsedRows.length >= 2) {
                            const prev = parsedRows[parsedRows.length - 2].val;
                            const curr = parsedRows[parsedRows.length - 1].val;
                            document.getElementById('whatsapp-previous').value = prev;
                            document.getElementById('whatsapp-current').value = curr;
                        }
                    } catch (e) {
                        console.error("Errore lettura file Whatsapp", e);
                    }
                }
            }

            // 2. Legge i valori aggiornati (o appena precompilati) dai campi input
            const whatsappCurrent = parseInt(document.getElementById('whatsapp-current').value, 10) || 0;
            const whatsappPrevious = parseInt(document.getElementById('whatsapp-previous').value, 10) || 0;
            const whatsappData = { current: whatsappCurrent, previous: whatsappPrevious };

            const fileData = {};
            for (const file of files) {
                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    fileData[file.name] = workbook;
                } catch (error) {
                    console.error(`Errore nel leggere il file ${file.name}:`, error);
                    alert(`Non è stato possibile leggere il file ${file.name}. Assicurati che sia un file Excel valido.`);
                }
            }
            if (Object.keys(fileData).length > 0) {
                processFiles(fileData, whatsappData);
            }
            hideLoader();
        }
        
        function getSheetData(workbook, sheetName) {
            if (!workbook.SheetNames.includes(sheetName)) return [];
            return XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
        }
        
        function findValueByLabel(data, label) {
            for (const row of data) {
                if (row && row[0] && typeof row[0] === 'string' && row[0].trim().toLowerCase() === label.toLowerCase()) {
                    return row[1];
                }
            }
            return null;
        }
        
        function findRowIndex(data, label) {
            return data.findIndex(row => row && row[0] && typeof row[0] === 'string' && row[0].trim().toLowerCase().startsWith(label.toLowerCase()));
        }

        function formatNumber(n) {
            if (typeof n !== 'number') return String(n).replace('.',',');

            if (n >= 1000000) {
                const millions = n / 1000000;
                let formatted = millions.toFixed(2);
                if (formatted.endsWith('.00')) {
                    formatted = formatted.substring(0, formatted.length - 3);
                }
                else if (formatted.endsWith('0')) {
                    formatted = formatted.substring(0, formatted.length - 1);
                }
                return formatted.replace('.', ',') + 'M';
            }

            if (n >= 1000) {
                return Math.round(n / 1000) + 'K';
            }
            return n.toLocaleString('it-IT');
        }

        // Funzione specifica per "Dimensione totale community" (2 decimali fissi + K/M)
        function formatTotalCommunity(n) {
            if (typeof n !== 'number') return String(n).replace('.',',');

            if (n >= 1000000) {
                // Esempio: 3.148.575 -> 3,14M (Tronca a 2 decimali senza arrotondare per eccesso)
                const millions = Math.floor((n / 1000000) * 100) / 100;
                return millions.toFixed(2).replace('.', ',') + 'M';
            }
            if (n >= 1000) {
                // Esempio: 150.500 -> 150,50K
                const thousands = Math.floor((n / 1000) * 100) / 100;
                return thousands.toFixed(2).replace('.', ',') + 'K';
            }
            return n.toLocaleString('it-IT');
        }

        // Funzione dedicata per l'Executive Summary
        function formatSmartNumber(n) {
            if (typeof n !== 'number') return "0";
            
            if (n >= 1000000) {
                // Per i milioni: mantiene logica esistente (fino a 2 decimali, rimuove zeri inutili)
                let value = n / 1000000;
                let formatted = parseFloat(value.toFixed(2));
                return String(formatted).replace('.', ',') + 'M';
            } else if (n >= 1000) {
                // Per le migliaia: arrotonda all'intero più vicino (es. 275.921 -> 276K)
                let value = n / 1000;
                let formatted = Math.round(value);
                return String(formatted) + 'K';
            }

            // Per numeri piccoli (< 1000), restituisce il numero intero
            return String(Math.round(n));
        }

        function formatNumberWithThousands(n, decimalPlaces = 0) {
            if (typeof n !== 'number') return String(n).replace('.',',');
            const options = {};
            if (decimalPlaces > 0) {
                options.minimumFractionDigits = decimalPlaces;
                options.maximumFractionDigits = decimalPlaces;
            }
            return n.toLocaleString('it-IT', options);
        }
        
        // Helper per assicurarsi che la stringa base64 abbia il prefisso corretto
        function ensureBase64Prefix(str) {
            if (!str) return '';
            if (str.startsWith('data:image')) return str;
            // Se manca, proviamo ad aggiungerlo (assumendo png per default se non specificato, ma i loghi nel json di solito sono full)
            return `data:image/png;base64,${str}`;
        }

        async function createPlatformChart(containerId, data, title) {
            const container = d3.select(containerId);
            if (container.empty()) return;
            container.selectAll("*").remove();
            
            // Usa i loghi scaricati o un oggetto vuoto se il fetch ha fallito
            const logos = fetchedLogos || {};

            const platformConfig = {
                'facebook': { logo: ensureBase64Prefix(logos.facebook), profiles: ['Poste Italiane', 'PosteMobile', 'Postepay'], label: 'Facebook' },
                'linkedin': { logo: ensureBase64Prefix(logos.linkedin), profiles: ['Poste Italiane'], label: 'Linkedin' },
                'x': { logo: ensureBase64Prefix(logos.x), profiles: ['Poste Italiane', 'PosteSpedizioni', 'WebPoste'], label: 'X' },
                'instagram': { logo: ensureBase64Prefix(logos.instagram), profiles: ['Poste Italiane', 'Postepay'], label: 'Instagram' },
                'youtube': { logo: ensureBase64Prefix(logos.youtube), profiles: ['Poste Italiane'], label: 'Youtube' },
                'whatsapp': { logo: ensureBase64Prefix(logos.whatsapp), profiles: ['Poste Italiane'], label: 'Whatsapp' }
            };

            const formattedData = data
                .map(d => {
                    const key = d[0].toLowerCase();
                    const config = platformConfig[key] || { logo: '', profiles: [], label: d[0] };
                    return { name: d[0], value: d[1], ...config };
                })
                .sort((a, b) => b.value - a.value);

            const width = 1000;
            const height = 600; // Altezza totale ridotta per compattare
            // Margine inferiore ridotto drasticamente (da 220 a 140) per avvicinare i loghi alla base
            const margin = { top: 60, right: 30, bottom: 140, left: 90 };

            const svg = container.append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("class", "platform-chart")
                .style("font-family", "'Avenir Next LT Pro', sans-serif");

            const x = d3.scaleBand()
                .domain(formattedData.map(d => d.name))
                .range([margin.left, width - margin.right])
                .padding(0.4);

            const yMax = d3.max(formattedData, d => d.value);
            const y = d3.scaleLinear()
                .domain([0, yMax * 1.2])
                .range([height - margin.bottom, margin.top]);

            const yAxis = d3.axisLeft(y)
                .ticks(5)
                .tickFormat(formatNumber)
                .tickSize(-(width - margin.left - margin.right));

            svg.append("g")
                .attr("transform", `translate(${margin.left},0)`)
                .call(yAxis)
                .call(g => g.select(".domain").remove())
                .call(g => g.selectAll(".tick line").attr("stroke", "#e0e0e0").attr("stroke-dasharray", "2,2"))
                .call(g => g.selectAll(".tick text").attr("fill", "#7b7b7a").style("font-size", "18px"));

            svg.append("g")
                .selectAll("rect")
                .data(formattedData)
                .join("rect")
                .attr("x", d => x(d.name))
                .attr("y", d => y(d.value))
                .attr("height", d => y(0) - y(d.value))
                .attr("width", x.bandwidth())
                .attr("fill", "#bfd7fd");

            svg.append("g")
                .selectAll("text.value")
                .data(formattedData)
                .join("text")
                .attr("class", "value")
                .attr("x", d => x(d.name) + x.bandwidth() / 2)
                .attr("y", d => y(d.value) - 20)
                .attr("text-anchor", "middle")
                .attr("fill", "#0431AE")
                .style("font-weight", "bold")
                .style("font-size", "26px")
                .text(d => formatNumber(d.value));

            // Translate modificato: avvicinato alla base del grafico (+10 invece di +40)
            const labels = svg.append("g")
                .selectAll("g")
                .data(formattedData)
                .join("g")
                .attr("transform", d => `translate(${x(d.name) + x.bandwidth() / 2}, ${height - margin.bottom + 10})`);

            // Aggiunta Logo
            labels.append("image")
                .attr("href", d => d.logo) // Usa href standard SVG
                .attr("x", -25) // Centrato (metà di 50)
                .attr("y", 0)
                .attr("width", 50) 
                .attr("height", 50);

            labels.append("text")
                .attr("y", 75)
                .attr("text-anchor", "middle")
                .attr("fill", "#0431AE")
                .style("font-weight", "bold")
                .style("font-size", "22px")
                .text(d => d.label);

            labels.each(function(d) {
                const group = d3.select(this);
                d.profiles.forEach((profile, i) => {
                    group.append("text")
                        .attr("y", 100 + (i * 20)) // Spaziatura ridotta per compattezza
                        .attr("text-anchor", "middle")
                        .attr("fill", "#7b7b7a")
                        .style("font-size", "14px")
                        .text(profile);
                });
            });
        }


        function createBenchmarkChart(containerId, data, title) {
            const container = d3.select(containerId);
            if (container.empty()) {
                console.error(`Container con ID ${containerId} non trovato.`);
                return;
            }
            container.selectAll("*").remove();

            const width = 2300;
            const height = 519;
            const margin = { top: 80, right: 40, bottom: 200, left: 140 };

            const svg = container.append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("class", "benchmark-chart");

            const x = d3.scaleBand()
                .domain(data.map(d => d.name))
                .range([margin.left, width - margin.right])
                .padding(0.3);

            const yMax = d3.max(data, d => d.value);
            const y = d3.scaleLinear()
                .domain([0, yMax * 1.2])
                .range([height - margin.bottom, margin.top]);

            const xAxis = d3.axisBottom(x).tickSize(0);
            const xAxisGroup = svg.append("g")
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(xAxis);
            
            xAxisGroup.selectAll("text")
                .attr("class", "axis-label")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end")
                .attr("dy", "0.8em") 
                .style("font-size", "26px");
            xAxisGroup.select(".domain").remove();

            const yTicks = y.ticks(5).filter(tick => tick > 0);
            const yAxis = d3.axisLeft(y)
                .tickValues(yTicks)
                .tickFormat(formatNumber)
                .tickSize(-(width - margin.left - margin.right));

            svg.append("g")
                .attr("transform", `translate(${margin.left},0)`)
                .call(yAxis)
                .call(g => g.select(".domain").remove())
                .call(g => g.selectAll(".tick line").attr("class", "grid-line"))
                .call(g => g.selectAll(".tick text")
                    .attr("class", "axis-label")
                    .attr("dx", "-0.5em")
                    .style("font-size", "26px")
                );

            svg.append("g")
                .selectAll("rect")
                .data(data)
                .join("rect")
                .attr("x", d => x(d.name))
                .attr("y", d => y(d.value))
                .attr("height", d => y(0) - y(d.value))
                .attr("width", x.bandwidth())
                .attr("fill", d => d.name.toLowerCase().includes('poste') ? 'var(--chart-title-blue)' : 'var(--chart-bar-blue)');

            svg.append("g")
                .selectAll("text")
                .data(data)
                .join("text")
                .attr("class", "bar-label")
                .attr("x", d => x(d.name) + x.bandwidth() / 2)
                .attr("y", d => y(d.value) - 12)
                .attr("text-anchor", "middle")
                .style("font-size", "26px")
                .text(d => formatNumber(d.value));

            svg.append("text")
                .attr("x", margin.left)
                .attr("y", margin.top - 40)
                .attr("text-anchor", "start")
                .style("font-size", "32px")
                .style("font-weight", "bold")
                .style("fill", "var(--chart-title-blue)")
                .style("font-family", "var(--font-family)")
                .text(title);

            svg.append("line")
                .attr("x1", margin.left)
                .attr("y1", margin.top - 25)
                .attr("x2", margin.left + 450) 
                .attr("y2", margin.top - 25)
                .attr("stroke", "var(--chart-title-blue)")
                .attr("stroke-width", 2);
        }

        function getStyledSvgString(svgElement) {
            const svgClone = svgElement.cloneNode(true);
            const allOriginalElements = svgElement.querySelectorAll('*');
            const allClonedElements = svgClone.querySelectorAll('*');

            allOriginalElements.forEach((origEl, index) => {
                const cloneEl = allClonedElements[index];
                const computedStyle = window.getComputedStyle(origEl);
                let inlineStyle = "";
                for (let i = 0; i < computedStyle.length; i++) {
                    const prop = computedStyle[i];
                    inlineStyle += `${prop}: ${computedStyle.getPropertyValue(prop)}; `;
                }
                cloneEl.setAttribute('style', inlineStyle);
            });
            return new XMLSerializer().serializeToString(svgClone);
        }

        async function copySvgToClipboard(svgElement, button) {
            showFeedbackOnCopyButton(button, 'Copiando...');
            try {
                const svgData = getStyledSvgString(svgElement);
                const viewBox = svgElement.getAttribute('viewBox').split(' ').map(Number);
                const width = viewBox[2];
                const height = viewBox[3];
                
                const scaleFactor = 2;
                const canvas = document.createElement("canvas");
                canvas.width = width * scaleFactor;
                canvas.height = height * scaleFactor;
                
                const ctx = canvas.getContext("2d");
                ctx.scale(scaleFactor, scaleFactor);

                const img = new Image();
                // Assicura che l'SVG data URI sia corretto
                const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
                const url = URL.createObjectURL(svgBlob);

                img.onload = async () => {
                    ctx.drawImage(img, 0, 0, width, height);
                    URL.revokeObjectURL(url);
                    canvas.toBlob(async (blob) => {
                        try {
                            await navigator.clipboard.write([
                                new ClipboardItem({ 'image/png': blob })
                            ]);
                            showFeedbackOnCopyButton(button, 'OK!');
                        } catch (err) {
                           console.error('Errore durante la scrittura negli appunti:', err);
                           showFeedbackOnCopyButton(button, 'Err!');
                        }
                    }, 'image/png');
                };
                img.onerror = (e) => {
                    URL.revokeObjectURL(url);
                    console.error('Errore nel caricare l\'immagine SVG nel canvas', e);
                    showFeedbackOnCopyButton(button, 'Err!');
                };
                img.src = url;

            } catch (err) {
                console.error('Errore durante la copia del grafico:', err);
                showFeedbackOnCopyButton(button, 'Err!');
            }
        }
        
        function exportSvg(svgElement, filename) {
            try {
                const svgData = getStyledSvgString(svgElement);
                const blob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (err) {
                console.error('Errore durante l\'esportazione del SVG:', err);
            }
        }
        
        function processFiles(fileData, whatsappData) {
            const fansGlobaleWorkbook = Object.values(fileData).find(wb => wb.SheetNames.includes('Total community size'));
            const competitorWorkbook = Object.values(fileData).find(wb => wb.SheetNames.includes('COMPETITORS'));

            if (!fansGlobaleWorkbook || !competitorWorkbook) {
                alert("Assicurati di aver caricato sia il file 'Report - Fans globale' che quello dei 'Competitor'.");
                return;
            }

            buttonNav.innerHTML = '';
            sectionsWrapper.innerHTML = '';

            const totalCommunitySheet = getSheetData(fansGlobaleWorkbook, 'Total community size');
            
            let totalCommunitySize = 0, previousTotal = 0, totalGrowth = 0, relativeChange = '0.00%';

            const headerRowIndex = totalCommunitySheet.findIndex(row => row && String(row[2]).toLowerCase().includes('relative change'));
            if (headerRowIndex > -1 && totalCommunitySheet.length > headerRowIndex + 1) {
                const dataRow = totalCommunitySheet[headerRowIndex + 1];
                totalCommunitySize = Number(dataRow[0]) || 0;
                previousTotal = Number(dataRow[1]) || 0;
                totalGrowth = totalCommunitySize - previousTotal;
            }
            
            // --- INIZIO LOGICA WHATSAPP ---
            const whatsappGrowth = whatsappData.current - whatsappData.previous;

            // Aggiorna i totali con i dati di WhatsApp
            const finalTotalCommunitySize = totalCommunitySize + whatsappData.current;
            const finalTotalGrowth = totalGrowth + whatsappGrowth;
            const finalPreviousTotal = previousTotal + whatsappData.previous;

            // Ricalcola la variazione percentuale complessiva
            if (finalPreviousTotal > 0) {
                const newRelativeChange = (finalTotalGrowth / finalPreviousTotal) * 100;
                relativeChange = newRelativeChange.toFixed(2) + '%';
            } else if (finalTotalCommunitySize > 0) {
                relativeChange = '100.00%';
            }
            // --- FINE LOGICA WHATSAPP ---
            
            const perPiattaformaSheet = getSheetData(fansGlobaleWorkbook, 'Fans Poste per piattaforma');
            const platformData = perPiattaformaSheet.slice(findRowIndex(perPiattaformaSheet, 'facebook'));
            
            // Aggiungi WhatsApp ai dati della piattaforma se il valore è maggiore di zero
            if(whatsappData.current > 0) {
                platformData.push(['Whatsapp', whatsappData.current]);
            }
            
            const fansPosteCrescitaSheet = getSheetData(fansGlobaleWorkbook, 'Fans Poste Crescita');
            
            // Strutture dati
            let dailyGrowthData = []; 
            let currentMonthDetailed = []; 

            if(fansPosteCrescitaSheet.length > 13) {
                 const rawRows = fansPosteCrescitaSheet
                    .slice(12, 43)
                    .filter(row => row && row[0] && (row[1] !== null && row[1] !== undefined));

                 currentMonthDetailed = rawRows.map(row => {
                     let dateObj;
                     if (typeof row[0] === 'number') {
                         const d = XLSX.SSF.parse_date_code(row[0]);
                         dateObj = new Date(d.y, d.m - 1, d.d);
                     } else {
                         dateObj = new Date(row[0]);
                     }
                     if (isNaN(dateObj)) dateObj = new Date();

                     const dStr = String(dateObj.getDate()).padStart(2, '0');
                     const mStr = String(dateObj.getMonth() + 1).padStart(2, '0');
                     
                     return {
                         date: dateObj,
                         formattedDate: `${dStr}/${mStr}`,
                         val: row[1],
                         monthKey: `${dateObj.getFullYear()}_${mStr}`
                     };
                 });

                 dailyGrowthData = currentMonthDetailed.map(item => [item.formattedDate, item.val]);
            }

            // Logica distribuzione WhatsApp: Distribuzione uniforme con gestione resto finale
            if (dailyGrowthData.length > 0 && (whatsappData.current > 0 || whatsappData.previous > 0)) {
                const waGrowth = whatsappData.current - whatsappData.previous;
                const waBase = whatsappData.previous;
                const daysCount = dailyGrowthData.length;
                
                // Calcolo quota giornaliera intera e residuo
                const dailyQuota = Math.floor(waGrowth / daysCount);
                const remainder = waGrowth % daysCount;

                dailyGrowthData = dailyGrowthData.map((row, index) => {
                    // La crescita accumulata è la quota giornaliera * numero giorni trascorsi
                    let accumulatedGrowth = dailyQuota * (index + 1);
                    
                    // Il residuo viene aggiunto interamente all'ultimo giorno
                    if (index === daysCount - 1) {
                        accumulatedGrowth += remainder;
                    }
                    
                    // Il valore del giorno è: Valore Originale Excel + Base WhatsApp (mese prec) + Crescita WhatsApp accumulata fino a oggi
                    const newVal = row[1] + waBase + accumulatedGrowth;

                    return [row[0], newVal];
                });

                // Sincronizza currentMonthDetailed con i nuovi valori (Excel + WhatsApp)
                currentMonthDetailed.forEach((item, i) => {
                    if (dailyGrowthData[i]) {
                        item.val = dailyGrowthData[i][1];
                    }
                });
            }
            
            // Preparazione dati per tabella con calcolo differenziale rispetto al giorno precedente
            let tableDataWithDelta = [];
            if (dailyGrowthData.length > 0) {
                tableDataWithDelta = dailyGrowthData.map((row, index) => {
                    const currentVal = row[1];
                    let deltaStr = "";
                    
                    if (index === 0) {
                        // Primo giorno: vuoto come richiesto per evitare loop o calcoli incerti
                        deltaStr = "-";
                    } else {
                        const delta = currentVal - dailyGrowthData[index - 1][1];
                        deltaStr = delta > 0 ? '+' + formatNumberWithThousands(delta) : formatNumberWithThousands(delta);
                    }
                    
                    return [row[0], currentVal, deltaStr];
                });
            }
            
            let dailyGrowthTableHTML = dailyGrowthData.length > 0 ? createTableHTML(tableDataWithDelta, ['Giorno', 'Iscritti Totali', 'Incremento Giornaliero'], 'Crescita giornaliera Fans') : '';

            // --- LOGICA TABELLA ANNUALE ---
            if (!window.exportExcelData) {
                window.exportExcelData = function(filename, jsonDataEncoded) {
                    try {
                        const data = JSON.parse(decodeURIComponent(jsonDataEncoded));
                        const ws = XLSX.utils.aoa_to_sheet(data);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "Dati");
                        XLSX.writeFile(wb, filename + ".xlsx");
                    } catch(e) { alert("Errore export."); }
                };
            }

            let monthlyTrendData = [];

            if (currentMonthDetailed.length > 0) {
                const annualFileKey = Object.keys(fileData).find(k => k.toLowerCase().startsWith('annuale') && (k.endsWith('.xlsx') || k.endsWith('.xls')));
                let historicalRows = [];

                if (annualFileKey) {
                    const annualSheetName = fileData[annualFileKey].SheetNames[0];
                    const rawAnnual = XLSX.utils.sheet_to_json(fileData[annualFileKey].Sheets[annualSheetName], { header: 1 });
                    
                    rawAnnual.forEach(row => {
                        if (!row || row.length < 2) return;
                        let dObj = null;
                        if (typeof row[0] === 'number') {
                            const di = XLSX.SSF.parse_date_code(row[0]);
                            dObj = new Date(di.y, di.m - 1, di.d);
                        } else if (typeof row[0] === 'string') {
                            const parts = row[0].split('/');
                            if (parts.length === 3) dObj = new Date(parts[2], parts[1] - 1, parts[0]);
                        }
                        
                        if (dObj && !isNaN(dObj.getTime())) {
                             historicalRows.push({
                                 date: dObj,
                                 val: row[1],
                                 monthKey: `${dObj.getFullYear()}_${String(dObj.getMonth() + 1).padStart(2, '0')}`
                             });
                        }
                    });
                }

                const firstCurrentDate = currentMonthDetailed[0].date;
                const refDateStartOfMonth = new Date(firstCurrentDate.getFullYear(), firstCurrentDate.getMonth(), 1);
                const cutoffDate = new Date(refDateStartOfMonth);
                cutoffDate.setMonth(cutoffDate.getMonth() - 11);

                const validHistorical = historicalRows.filter(r => r.date >= cutoffDate && r.date < refDateStartOfMonth);
                validHistorical.sort((a,b) => a.date - b.date);
                
                const fullYearData = [...validHistorical, ...currentMonthDetailed];
                const groupedByMonth = {};
                fullYearData.forEach(item => {
                    if (!groupedByMonth[item.monthKey]) groupedByMonth[item.monthKey] = [];
                    groupedByMonth[item.monthKey].push(item);
                });

                const sortedKeys = Object.keys(groupedByMonth).sort();
                let totalFilename = "annuale_export";
                if (sortedKeys.length > 0) totalFilename = `annuale_${sortedKeys[0]}-${sortedKeys[sortedKeys.length-1]}`;

                const totalExportData = [['Data', 'Numero iscritti']];
                fullYearData.forEach(d => {
                     totalExportData.push([`${String(d.date.getDate()).padStart(2,'0')}/${String(d.date.getMonth()+1).padStart(2,'0')}/${d.date.getFullYear()}`, d.val]);
                });

                let innerAccordions = '';
                sortedKeys.forEach(key => {
                    const monthRows = groupedByMonth[key];
                    
                    // Prepara dati per il grafico annuale (prendi l'ultimo valore del mese)
                    if (monthRows.length > 0) {
                        const lastRow = monthRows[monthRows.length - 1];
                        const d = lastRow.date;
                        const mNames = ["gen", "feb", "mar", "apr", "mag", "giu", "lug", "ago", "set", "ott", "nov", "dic"];
                        const label = `${mNames[d.getMonth()]}-${String(d.getFullYear()).slice(-2)}`;
                        monthlyTrendData.push([label, lastRow.val]);
                    }

                    const monthFilename = `followers_${key}`;
                    const monthExportData = [['Data', 'Numero iscritti']];
                    const tableRowsHTML = monthRows.map(r => {
                        const fmt = `${String(r.date.getDate()).padStart(2,'0')}/${String(r.date.getMonth()+1).padStart(2,'0')}/${r.date.getFullYear()}`;
                        monthExportData.push([fmt, r.val]);
                        return `<tr><td>${fmt}</td><td>${formatNumberWithThousands(r.val)}</td></tr>`;
                    }).join('');
                    
                    innerAccordions += `
                        <details style="margin-bottom: 1rem; border-left: 4px solid var(--chart-bar-blue); padding-left: 1rem; background: #fff;">
                            <summary style="cursor: pointer; font-weight: 600; color: #444; padding: 0.5rem 0;">${key.replace('_', '/')}</summary>
                            <div style="margin-top: 0.5rem; padding-bottom: 0.5rem;">
                                <button class="nav-button" style="font-size: 0.8rem; padding: 0.4rem 1rem; margin-bottom: 1rem;" 
                                    onclick="window.exportExcelData('${monthFilename}', '${encodeURIComponent(JSON.stringify(monthExportData))}')">
                                    Copia/Scarica Mese
                                </button>
                                <table><thead><tr><th>Data</th><th>Iscritti</th></tr></thead><tbody>${tableRowsHTML}</tbody></table>
                            </div>
                        </details>
                    `;
                });

                // Trucco HTML per chiudere il container precedente e aprirne uno nuovo visibile
                dailyGrowthTableHTML += `
                    </div>
                    </details>
                    
                    <details style="background: #f8f9fc; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 2rem; margin-top: 1rem;">
                        <summary style="cursor: pointer; font-weight: 700; color: var(--primary-ui-blue); outline: none;">Visualizza Crescita iscritti annuale</summary>
                        <div style="margin-top: 1rem;">
                            <div style="margin-bottom: 1.5rem; display: flex; justify-content: flex-end;">
                                <button class="nav-button" style="background-color: var(--primary-ui-yellow); border-color: var(--primary-ui-yellow); color: var(--primary-ui-blue);" 
                                    onclick="window.exportExcelData('${totalFilename}', '${encodeURIComponent(JSON.stringify(totalExportData))}')">
                                    Scarica Excel Annuale
                                </button>
                            </div>
                            ${innerAccordions}
                        </div>
                    </details>
                    
                    <details style="display:none"><div>
                `;
            }

            const nameMaps = {            
                fb: { 'Vodafone it (https://www.facebook.com/vodafoneit)': 'Vodafone', 'TIM (https://www.facebook.com/TimOfficialPage)': 'Tim', 'WINDTRE (https://www.facebook.com/WINDTRE)': 'WindTre', 'PosteMobile (https://www.facebook.com/postemobile)': 'PosteMobile', 'Poste Italiane (https://www.facebook.com/PosteItaliane)': 'Poste Italiane', 'Frecciarossa (https://www.facebook.com/FrecciarossaOfficial)': 'Frecciarossa', 'Intesa Sanpaolo (https://www.facebook.com/intesasanpaolo)': 'Intesa Sanpaolo', 'Revolut (https://www.facebook.com/revolutapp)': 'Revolut', 'Fastweb (https://www.facebook.com/Fastweb)': 'Fastweb', 'Deutsche Post und DHL (https://www.facebook.com/deutschepost)': 'Deutsche Post', 'iliad (https://www.facebook.com/iliadItalia)': 'Iliad', 'Eni (https://www.facebook.com/EniItalia)': 'Eni', 'Enel Group (https://www.facebook.com/EnelGroup)': 'Enel', 'Postepay (https://www.facebook.com/Postepay)': 'Postepay', 'Mooney Group (https://www.facebook.com/mooneygroup)': 'Mooney', 'DHL Express Italy (https://www.facebook.com/DHLExpressItaly)': 'DHL Italia', 'Royal Mail Stamps & Collectibles (https://www.facebook.com/RoyalMailStamps)': 'Royal Mail', 'HYPE (https://www.facebook.com/Hype.MoneyIsJustaTool)': 'Hype', 'ho. Mobile (https://www.facebook.com/homobile)': 'ho. Mobile', 'Banca Monte dei Paschi di Siena (https://www.facebook.com/bancamps)': 'Banca MPS', 'NeN (https://www.facebook.com/nen.energia)': 'NeN' },
                x: { 'Royal Mail (https://twitter.com/RoyalMail)': 'Royal Mail', 'Poste Italiane (https://twitter.com/PosteItaliane)': 'Poste Italiane', 'Frecciarossa_IT (https://twitter.com/Frecciarossa_IT)': 'Frecciarossa', 'PosteSpedizioni (https://twitter.com/PosteSpedizioni)': 'PosteSpedizioni', 'eni (https://twitter.com/eni)': 'Eni', 'WebPoste (https://twitter.com/WebPoste)': 'WebPoste', 'Deutsche Post und DHL News (https://twitter.com/DeutschePostDHL)': 'Deutsche Post', 'UniCredit Italia (https://twitter.com/UniCredit_IT)': 'UniCredit', 'Enel Group (https://twitter.com/EnelGroupIT)': 'Enel', 'Intesa Sanpaolo (https://twitter.com/intesasanpaolo)': 'Intesa Sanpaolo', 'Banca MPS (https://twitter.com/Banca_MPS)': 'Banca MPS', 'revolut (https://twitter.com/revolut)': 'Revolut' },
                li: { 'Poste Italiane': 'Poste Italiane', 'Intesa Sanpaolo': 'Intesa Sanpaolo', 'Eni': 'Eni', 'Trenitalia': 'Trenitalia', 'INPS_official': 'INPS', 'CDP Cassa Depositi e Prestiti': 'CDP', 'BNL BNP Paribas': 'BNL BNP Paribas', 'UniCredit': 'UniCredit', 'Enel Group': 'Enel', 'Gruppo Ferrovie dello Stato Italiane': 'Gruppo FS' },
                ig: { 'Vodafone It (https://instagram.com/vodafoneit)': 'Vodafone', 'TIM (https://instagram.com/timofficial)': 'Tim', 'Royal Mail 📮 (https://instagram.com/royalmailofficial)': 'Royal Mail', 'Poste Italiane (https://instagram.com/posteitaliane)': 'Poste Italiane', 'WINDTRE (https://instagram.com/windtre)': 'WindTre', 'Intesa Sanpaolo (https://instagram.com/intesasanpaolo)': 'Intesa Sanpaolo', 'Eni (https://instagram.com/eni)': 'Eni', 'Enel Group (https://instagram.com/enelgroup)': 'Enel', 'DHL Express Italy (https://instagram.com/dhlexpressitaly)': 'DHL Italia', 'Postepay (https://instagram.com/postepay)': 'Postepay', 'Banca Monte dei Paschi di Siena (https://instagram.com/banca_mps)': 'Banca MPS' }
            };

            const cleanName = (row, platform) => {
                const originalName = String(row[0]).trim();
                const platformMap = nameMaps[platform] || {};
                const rewrittenName = platformMap[originalName] || originalName.split('(')[0].trim();
                return { name: rewrittenName, value: row[1] };
            };

            const fbFollowersSheet = getSheetData(fansGlobaleWorkbook, 'FB Followers');
            const fbData = fbFollowersSheet.slice(findRowIndex(fbFollowersSheet, 'vodafone')).map(r => cleanName(r, 'fb')).sort((a,b) => b.value - a.value);

            const igFollowersSheet = getSheetData(fansGlobaleWorkbook, 'IG followers');
            const igData = igFollowersSheet.slice(findRowIndex(igFollowersSheet, 'tim')).map(r => cleanName(r, 'ig')).sort((a,b) => b.value - a.value);

            const xFollowersSheet = getSheetData(fansGlobaleWorkbook, 'X followers');
            const xData = xFollowersSheet.slice(findRowIndex(xFollowersSheet, 'royal mail')).map(r => cleanName(r, 'x')).sort((a,b) => b.value - a.value);

            const competitorSheet = getSheetData(competitorWorkbook, 'COMPETITORS');
            const linkedInData = competitorSheet.slice(2).map(r => cleanName(r, 'li')).sort((a,b) => b.value - a.value);

            function createTrendChart(containerId, data, title) {
                const container = d3.select(containerId);
                if (container.empty() || !data || data.length === 0) return;
                container.selectAll("*").remove();

                const width = 1580;
                const height = 718;
                const margin = { top: 120, right: 60, bottom: 200, left: 120 };

                const svg = container.append("svg")
                    .attr("width", "100%")
                    .attr("height", "100%")
                    .attr("viewBox", `0 0 ${width} ${height}`)
                    .style("background", "#fff")
                    .attr("class", "trend-chart");

                const headerGroup = svg.append("g");
                
                headerGroup.append("text")
                    .attr("x", 170)
                    .attr("y", 95)
                    .text(title || "ANDAMENTO CRESCITA")
                    .attr("font-family", "var(--font-family)")
                    .attr("font-size", "62px") 
                    .attr("fill", "var(--chart-title-blue)")
                    .style("text-transform", "uppercase");

                headerGroup.append("line")
                    .attr("x1", 165)
                    .attr("y1", 110)
                    .attr("x2", width - margin.right)
                    .attr("y2", 110)
                    .attr("stroke", "var(--chart-title-blue)")
                    .attr("stroke-width", 3);

                const xDomain = data.map(d => d[0]);
                const yValues = data.map(d => d[1]);
                const yMin = d3.min(yValues);
                const yMax = d3.max(yValues);
                const yPadding = (yMax - yMin) * 0.2;

                // Modifica: Aggiunto padding(0.5) per distanziare la prima etichetta dall'asse
                const x = d3.scalePoint()
                    .domain(xDomain)
                    .range([margin.left, width - margin.right])
                    .padding(0.5);

                const y = d3.scaleLinear()
                    .domain([yMin - yPadding, yMax + yPadding])
                    .range([height - margin.bottom, margin.top + 40]);

                // Modifica: Formattazione asse Y in "K" con separatore e spazio (es. 3.150 K)
                const yAxis = d3.axisLeft(y)
                    .ticks(6)
                    .tickFormat(d => {
                        const val = Math.round(d / 1000);
                        return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + ' K';
                    })
                    .tickSize(-(width - margin.left - margin.right));

                const yAxisGroup = svg.append("g")
                    .attr("transform", `translate(${margin.left},0)`)
                    .call(yAxis);
                
                yAxisGroup.select(".domain").remove();
                yAxisGroup.selectAll(".tick line").attr("stroke", "#e0e0e0").attr("stroke-width", 2);
                yAxisGroup.selectAll(".tick text").attr("fill", "#7b7b7a").attr("font-size", "30px").attr("dx", "-10");

                // Rileva se i dati sono giornalieri (contengono /) o mensili
                const isDaily = xDomain[0] && xDomain[0].includes('/');
                const monthNames = ["gen", "feb", "mar", "apr", "mag", "giu", "lug", "ago", "set", "ott", "nov", "dic"];

                let xAxisObj = d3.axisBottom(x);
                
                if (isDaily) {
                    const oddDays = xDomain.filter(d => parseInt(d.split('/')[0]) % 2 !== 0);
                    xAxisObj = xAxisObj.tickValues(oddDays).tickFormat(d => {
                        const parts = d.split('/');
                        const day = parseInt(parts[0], 10);
                        const month = monthNames[parseInt(parts[1], 10) - 1];
                        return `${day}-${month}`;
                    });
                } else {
                    // Per dati mensili (es. gen-25) mostra tutto
                    xAxisObj = xAxisObj.tickFormat(d => d);
                }

                const xAxisGroup = svg.append("g")
                    .attr("transform", `translate(0,${height - margin.bottom})`)
                    .call(xAxisObj);

                xAxisGroup.select(".domain").attr("stroke", "#e0e0e0").attr("stroke-width", 2);
                xAxisGroup.selectAll(".tick line").remove();
                
                const xLabels = xAxisGroup.selectAll(".tick text")
                    .attr("fill", "#7b7b7a")
                    .attr("font-size", "39px");

                // Modifica: Rotazione verticale applicata a TUTTE le etichette (giornaliere e annuali)
                xLabels
                    .attr("transform", "rotate(-90)")
                    .attr("text-anchor", "end")
                    .attr("dx", "-10")
                    .attr("dy", "-5");

                const line = d3.line()
                    .x(d => x(d[0]))
                    .y(d => y(d[1]))
                    .curve(d3.curveMonotoneX);

                svg.append("path")
                    .datum(data)
                    .attr("fill", "none")
                    .attr("stroke", "var(--chart-bar-blue)") 
                    .attr("stroke-width", 10)
                    .attr("d", line);
            }

            // Funzione per ricalcolare il report usando i dati WhatsApp attuali (chiusura su fileData corrente)
            window.recalcWithWhatsapp = () => {
                const wc = parseInt(document.getElementById('whatsapp-current').value, 10) || 0;
                const wp = parseInt(document.getElementById('whatsapp-previous').value, 10) || 0;
                processFiles(fileData, { current: wc, previous: wp });
            };

            const sections = {
                'dati-generali': { title: 'Dati Generali Poste', content: `
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                        <button class="nav-button" onclick="window.recalcWithWhatsapp()" style="background-color: #fff; color: var(--primary-ui-blue); border: 2px solid var(--primary-ui-blue); display: flex; align-items: center; gap: 0.5rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
                            Aggiorna con dati WhatsApp
                        </button>
                    </div>
                    <div class="data-grid">
                        <div class="data-item">
                            <h3>Dimensione totale community</h3>
                            <button class="copy-button" title="Copia valore"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3z"/></svg></button>
                            <p class="data-value" data-copy-target>${formatTotalCommunity(finalTotalCommunitySize)}</p>
                        </div>
                        <div class="data-item">
                             <h3>Variazione vs Mese Prec.</h3>
                             <button class="copy-button" title="Copia valore"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3z"/></svg></button>
                            <p class="data-value ${String(relativeChange).includes('-') ? 'negative' : 'positive'}" data-copy-target>${String(relativeChange).replace('.', ',')}</p>
                        </div>
                        <div class="data-item">
                             <h3>Crescita Totale nel Mese</h3>
                             <button class="copy-button" title="Copia valore"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5h3z"/></svg></button>
                            <p class="data-value positive" data-copy-target>+${formatNumber(finalTotalGrowth)}</p>
                        </div>
                    </div>
                    
                    <details style="background: #f8f9fc; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
                        <summary style="cursor: pointer; font-weight: 700; color: var(--primary-ui-blue); outline: none;">Visualizza tabella Crescita giornaliera</summary>
                        <div style="margin-top: 1rem;">
                            ${dailyGrowthTableHTML}
                        </div>
                    </details>

                    <div class="chart-wrapper">
                         <div class="chart-controls">
                             <button class="export-svg-btn" data-chart-id="trend-chart-container" title="Esporta SVG">Esporta SVG</button>
                             <button class="copy-svg-btn" data-chart-id="trend-chart-container" title="Copia Grafico">Copia Grafico</button>
                         </div>
                         <div class="chart-container" id="trend-chart-container"></div>
                    </div>

                    <div class="chart-wrapper" style="margin-top: 2rem;">
                         <div class="chart-controls">
                             <button class="export-svg-btn" data-chart-id="annual-trend-chart-container" title="Esporta SVG">Esporta SVG</button>
                             <button class="copy-svg-btn" data-chart-id="annual-trend-chart-container" title="Copia Grafico">Copia Grafico</button>
                         </div>
                         <div class="chart-container" id="annual-trend-chart-container"></div>
                    </div>
                ` },
                'dati-piattaforma': { title: 'Dati per Piattaforma', content: `
                    <div class="chart-wrapper" style="margin-bottom: 1.5rem;">
                         <div class="chart-controls">
                             <button class="export-svg-btn" data-chart-id="piattaforma-chart-container" title="Esporta SVG">Esporta SVG</button>
                             <button class="copy-svg-btn" data-chart-id="piattaforma-chart-container" title="Copia Grafico">Copia Grafico</button>
                         </div>
                         <div class="chart-container" id="piattaforma-chart-container"></div>
                    </div>
                    ${createTableHTML(platformData, ['Piattaforma', 'Followers'], 'Followers per Piattaforma')}
                ` },
                'benchmark-fb': { title: 'Benchmark Facebook', data: fbData, chartTitle: 'FACEBOOK' },
                'benchmark-ig': { title: 'Benchmark Instagram', data: igData, chartTitle: 'INSTAGRAM' },
                'benchmark-x': { title: 'Benchmark X', data: xData, chartTitle: 'X' },
                'benchmark-linkedin': { title: 'Benchmark LinkedIn', data: linkedInData, chartTitle: 'LINKEDIN' },
            };

            let isFirst = true;
            for (const [id, section] of Object.entries(sections)) {
                const button = document.createElement('button');
                button.className = `nav-button ${isFirst ? 'active' : ''}`;
                button.textContent = section.title;
                button.dataset.section = id;
                buttonNav.appendChild(button);

                const sectionDiv = document.createElement('div');
                sectionDiv.id = id;
                sectionDiv.className = `report-section ${!isFirst ? 'hidden' : ''}`;
                
                if (id.startsWith('benchmark-')) {
                   sectionDiv.innerHTML = `
                     <div class="chart-wrapper">
                         <div class="chart-controls">
                             <button class="export-svg-btn" data-chart-id="${id}-chart-container" title="Esporta SVG">Esporta SVG</button>
                             <button class="copy-svg-btn" data-chart-id="${id}-chart-container" title="Copia Grafico">Copia Grafico</button>
                         </div>
                         <div class="chart-container" id="${id}-chart-container"></div>
                     </div>
                     ${createTableHTML(section.data.map(d => [d.name, d.value]), ['Pagina', 'Followers'], section.title)}
                   `;
                } else {
                    sectionDiv.innerHTML = section.content;
                }
                sectionsWrapper.appendChild(sectionDiv);
                
                if (id.startsWith('benchmark-')) {
                   createBenchmarkChart(`#${id}-chart-container`, section.data, section.chartTitle);
                } else if (id === 'dati-generali') {
                    createTrendChart('#trend-chart-container', dailyGrowthData, "ANDAMENTO CRESCITA ULTIMO MESE");
                    if (monthlyTrendData.length > 0) {
                        createTrendChart('#annual-trend-chart-container', monthlyTrendData, "ANDAMENTO CRESCITA ULTIMI 12 MESI");
                    }
                }
                isFirst = false;
            }
            
            // --- INIZIO NUOVA FUNZIONALITÀ EXECUTIVE SUMMARY ---
            const execSummaryBtn = document.createElement('button');
            execSummaryBtn.textContent = 'Executive Summary';
            execSummaryBtn.className = 'nav-button exec-summary-btn'; 
            execSummaryBtn.onclick = () => {
                const now = new Date();
                const pad = n => String(n).padStart(2, '0');
                const timestamp = `${now.getFullYear()}_${pad(now.getMonth()+1)}_${pad(now.getDate())}_${pad(now.getHours())}_${pad(now.getMinutes())}`;
                const filename = `ES1_${timestamp}.json`;

                // Helper per cercare il valore di una piattaforma in modo flessibile
                const findVal = (keyword) => {
                    // Cerca nelle righe di platformData se la prima colonna contiene la keyword
                    const row = platformData.find(r => r[0] && String(r[0]).toLowerCase().includes(keyword.toLowerCase()));
                    return row ? row[1] : 0;
                };

                // Helper specifico per trovare X / Twitter in modo più robusto
                const findXValue = () => {
                    const row = platformData.find(r => {
                         if (!r[0]) return false;
                         const name = String(r[0]).toLowerCase().trim();
                         // Cerca 'twitter', oppure 'x' esatto, oppure 'x' seguito da spazio (es. 'X (Twitter)')
                         return name.includes('twitter') || name === 'x' || name.startsWith('x ');
                    });
                    return row ? row[1] : 0;
                };

                // Costruzione dell'oggetto JSON secondo le specifiche
                const exportData = {
                    "Numero Complessivo Iscritti": formatSmartNumber(finalTotalCommunitySize),
                    "Iscritti Facebook": formatSmartNumber(findVal('facebook')),
                    "Iscritti X (Twitter)": formatSmartNumber(findXValue()), 
                    "Iscritti Linkedin": formatSmartNumber(findVal('linkedin')),
                    "Iscritti Instagram": formatSmartNumber(findVal('instagram')),
                    "Iscritti Whatsapp": formatSmartNumber(findVal('whatsapp')),
                    "Iscritti YouTube": formatSmartNumber(findVal('youtube'))
                };

                // Creazione e download del file
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            buttonNav.appendChild(execSummaryBtn);
            // --- FINE NUOVA FUNZIONALITÀ ---
            
            // Rendering del grafico con i loghi caricati
            createPlatformChart('#piattaforma-chart-container', platformData, 'FOLLOWERS PER PIATTAFORMA');

            reportContent.classList.remove('hidden');
        }

        function createTableHTML(data, headers, title) {
            let tableRows = data.map(row => `<tr>${row.map(cell => {
                const isNumeric = typeof cell === 'number';
                const formattedCell = isNumeric ? formatNumberWithThousands(cell) : cell;
                const rawValueAttr = isNumeric ? `data-raw-value="${cell}"` : '';
                return `<td ${rawValueAttr}>${formattedCell}</td>`;
            }).join('')}</tr>`).join('');
            return `
                <div class="table-wrapper">
                    <button class="copy-button" title="Copia tabella"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3z"/></svg></button>
                    <h3>${title}</h3>
                    <table data-copy-target>
                        <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>
            `;
        }

        function showFeedbackOnCopyButton(button, message) {
            const originalContent = button.innerHTML;
            button.innerHTML = message;
            setTimeout(() => {
                button.innerHTML = originalContent;
            }, 1500);
        }
        
        buttonNav.addEventListener('click', (e) => {
            const clickedButton = e.target.closest('.nav-button');
            if (!clickedButton) return;
            // Se è il tasto executive summary non fare tab switching
            if (clickedButton.classList.contains('exec-summary-btn')) return;
            
            const sectionId = clickedButton.dataset.section;
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');
            document.querySelectorAll('.report-section').forEach(section => section.classList.toggle('hidden', section.id !== sectionId));
        });

        sectionsWrapper.addEventListener('click', (e) => {
            const copyBtn = e.target.closest('.copy-button');
            const exportBtn = e.target.closest('.export-svg-btn');
            const copyChartBtn = e.target.closest('.copy-svg-btn');
            
            if (copyBtn) {
                const parentWrapper = copyBtn.closest('.data-item, .table-wrapper');
                const target = parentWrapper.querySelector('[data-copy-target]');
                if (!target) return;
                
                let textToCopy = '';
                if (target.tagName === 'TABLE') {
                    const rows = target.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('th, td');
                        const rowText = Array.from(cells).map(cell => {
                            return cell.dataset.rawValue || cell.innerText.trim();
                        }).join('\t');
                        textToCopy += rowText + '\n';
                    });
                } else {
                    textToCopy = target.innerText.trim();
                }
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showFeedbackOnCopyButton(copyBtn, 'OK!');
                }).catch(err => {
                    console.error('Errore durante la copia:', err);
                    showFeedbackOnCopyButton(copyBtn, 'Err');
                });
            } else if (exportBtn) {
                const chartContainerId = exportBtn.dataset.chartId;
                const svgElement = document.querySelector(`#${chartContainerId} svg`);
                if(svgElement) {
                    exportSvg(svgElement, `${chartContainerId}.svg`);
                    showFeedbackOnCopyButton(exportBtn, 'OK!');
                } else {
                    showFeedbackOnCopyButton(exportBtn, 'Err!');
                }
            } else if (copyChartBtn) {
                 const chartContainerId = copyChartBtn.dataset.chartId;
                 const svgElement = document.querySelector(`#${chartContainerId} svg`);
                 if(svgElement) {
                    copySvgToClipboard(svgElement, copyChartBtn);
                 } else {
                    showFeedbackOnCopyButton(copyChartBtn, 'Err!');
                 }
            }
        });
    });
    </script>
</body>
</html>
