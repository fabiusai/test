<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Grafiche Social</title>
    <style>
        :root {
            --primary: #0033A0; /* Blu Poste */
            --yellow: #ecdd49;  /* Giallo Poste */
            --bg-gray: #f4f4f9;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            background-color: var(--bg-gray);
            overflow: hidden;
        }

        /* Sidebar Controlli */
        .sidebar {
            width: 400px;
            background: white;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 10;
        }

        .sidebar h2 {
            margin-top: 0;
            color: var(--primary);
            font-size: 1.5rem;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        /* Tab Styles */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }
        .tab-btn {
            flex: 1;
            padding: 10px;
            background: #eee;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
        }
        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .tab-content {
            display: none;
            flex-direction: column;
            gap: 20px;
        }
        .tab-content.active {
            display: flex;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: bold;
            font-size: 0.9rem;
            color: #333;
        }

        input[type="text"], input[type="date"], input[type="number"], select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }

        /* Gestione Canali */
        .channel-adder {
            display: flex;
            gap: 10px;
        }
        .channel-adder select { flex: 2; }
        .channel-adder input { flex: 1; }
        
        button {
            padding: 10px 15px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        button:hover { background-color: #002277; }
        
        button.btn-add { background-color: #28a745; }
        button.btn-add:hover { background-color: #218838; }

        .channels-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .channels-list li {
            display: flex;
            justify-content: space-between;
            background: #eee;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .channels-list li span.remove {
            color: red;
            cursor: pointer;
            font-weight: bold;
        }

        /* Area Istruzioni Immagine */
        .paste-instruction {
            background: #e9f5ff;
            border: 2px dashed var(--primary);
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            color: var(--primary);
            font-size: 0.9rem;
        }

        /* Area Preview */
        .preview-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: auto;
        }

        /* Il contenitore SVG scala per adattarsi allo schermo, ma mantiene proporzioni 1200x1185 */
        .svg-container {
            width: 100%;
            max-width: 800px; /* Limite visivo per il browser */
            aspect-ratio: 1200 / 1185;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            /* Sfondo bianco solo per la preview web. Non verrÃ  esportato nell'SVG */
            background-color: #ffffff; 
        }

        svg {
            width: 100%;
            height: 100%;
            display: block;
        }

    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Editor Grafiche</h2>

        <div class="tabs">
            <div id="btn-editoriale" class="tab-btn active" onclick="switchTab('editoriale')">Editoriale</div>
            <div id="btn-influencer" class="tab-btn" onclick="switchTab('influencer')">Influencer</div>
        </div>

        <div id="tab-editoriale" class="tab-content active">
            <div class="form-group">
                <label for="brand">1. Nome Pagina</label>
                <select id="brand">
                    <option value="Poste Italiane">Poste Italiane</option>
                    <option value="Postepay">Postepay</option>
                    <option value="PosteMobile">PosteMobile</option>
                </select>
            </div>

            <div class="form-group">
                <label for="date">2. Data</label>
                <input type="date" id="date">
            </div>

            <div class="form-group">
                <label for="topic">3. Argomento</label>
                <input type="text" id="topic" value="Notizie dal territorio" placeholder="Inserisci l'argomento">
            </div>

            <div class="form-group">
                <label>4. Elenco Canali</label>
                <div class="channel-adder">
                    <select id="channel-name">
                        <option value="Facebook">Facebook</option>
                        <option value="Linkedin">Linkedin</option>
                        <option value="Instagram">Instagram</option>
                        <option value="X">X</option>
                        <option value="YouTube">YouTube</option>
                        <option value="WhatsApp">WhatsApp</option>
                    </select>
                    <input type="number" id="channel-count" min="1" value="1">
                    <button type="button" class="btn-add" onclick="addChannel()">Aggiungi</button>
                </div>
                <ul class="channels-list" id="active-channels"></ul>
            </div>
        </div>

        <div id="tab-influencer" class="tab-content">
            <div class="form-group">
                <label for="inf-brand">1. Nome Pagina</label>
                <input type="text" id="inf-brand" value="" placeholder="Es. Mario Rossi">
            </div>

            <div class="form-group">
                <label for="inf-date">2. Data</label>
                <input type="date" id="inf-date">
            </div>

            <div class="form-group">
                <label for="inf-channel">3. Canale e Followers</label>
                <div style="display: flex; gap: 10px;">
                    <select id="inf-channel" style="flex: 1;">
                        <option value="Facebook">Facebook</option>
                        <option value="Linkedin">Linkedin</option>
                        <option value="X">X</option>
                        <option value="Instagram">Instagram</option>
                        <option value="YouTube">YouTube</option>
                        <option value="TikTok">TikTok</option>
                    </select>
                    <input type="text" id="inf-followers" style="flex: 1;" placeholder="es. 3,3K">
                </div>
            </div>

            <div class="form-group">
                <label for="inf-source">4. Tipo di fonte</label>
                <select id="inf-source" onchange="toggleInfSourceOther()">
                    <option value="News online">News online</option>
                    <option value="News locali online">News locali online</option>
                    <option value="Account ufficiale">Account ufficiale</option>
                    <option value="Politico">Politico</option>
                    <option value="Giornalista">Giornalista</option>
                    <option value="Influencer/blogger">Influencer/blogger</option>
                    <option value="Altro">Altro</option>
                </select>
                <input type="text" id="inf-source-other" style="display: none; margin-top: 10px;" placeholder="Specifica fonte">
            </div>
        </div>

        <div class="form-group" style="margin-top: 10px;">
            <label>5. Immagine</label>
            <div class="paste-instruction">
                <strong>CTRL+V (o CMD+V)</strong><br>
                Fai click qui e incolla un'immagine copiata. VerrÃ  adattata senza tagli.
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="saveJSON()" style="flex: 1; background-color: #ffc107; color: #333;">ðŸ’¾ Salva JSON</button>
            <button onclick="document.getElementById('file-input').click()" style="flex: 1; background-color: #17a2b8;">ðŸ“‚ Carica JSON</button>
            <input type="file" id="file-input" style="display: none;" accept=".json" onchange="loadJSON(event)">
        </div>

        <button onclick="downloadSVG()" style="margin-top: auto; font-size: 1.1rem; padding: 15px;">ðŸ“¥ Scarica SVG</button>
    </div>

    <div class="preview-area">
        <style>
            #placeholder-bg { fill: #d3d3d3 !important; }
        </style>
        <div class="svg-container">
            <svg id="canvas" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1185">
                
                <rect x="0" y="0" width="63" height="150" fill="#ecdd49" />
                
                <rect x="0" y="150" width="1200" height="2" fill="#0033A0" />

                <rect x="1000" y="0" width="200" height="40" fill="#f0f4f8" rx="0"/>
                <text id="svg-date" x="1180" y="28" font-family="Avenir Next LT Pro, Arial, sans-serif" font-size="28" font-weight="900" fill="#0033A0" text-anchor="end" letter-spacing="1">DD/MM/YYYY</text>

                <text id="svg-brand" x="82" y="45" font-family="Avenir Next LT Pro, Arial, sans-serif" font-size="38" font-weight="900" fill="#0033A0" letter-spacing="-0.5">Poste Italiane</text>
                
                <text id="svg-topic" x="82" y="90" font-family="Avenir Next LT Pro, Arial, sans-serif" font-size="36" font-weight="normal" fill="#0033A0">Notizie dal territorio</text>
                
                <text id="svg-channels" x="82" y="132" font-family="Avenir Next LT Pro, Arial, sans-serif" font-size="30" font-weight="normal" fill="#757575">Aggiungi canali dal menu a sinistra...</text>

                <rect id="placeholder-bg" x="0" y="154" width="1200" height="1031" fill="#00FF00" />
                
                <image id="svg-image" x="0" y="154" width="1200" height="1031" preserveAspectRatio="xMidYMid meet" href="" />
            </svg>
        </div>
    </div>

    <script>
        let currentTab = 'editoriale';

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('btn-' + tab).classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
            updateSVGText();
        }

        function toggleInfSourceOther() {
            const select = document.getElementById('inf-source');
            const otherInput = document.getElementById('inf-source-other');
            otherInput.style.display = select.value === 'Altro' ? 'block' : 'none';
            updateSVGText();
        }

        function updateSVGText() {
            if (currentTab === 'editoriale') {
                document.getElementById('svg-brand').textContent = document.getElementById('brand').value || '';
                document.getElementById('svg-topic').textContent = document.getElementById('topic').value || '';
                updateChannelString(); 
            } else {
                document.getElementById('svg-brand').textContent = document.getElementById('inf-brand').value || '';
                
                const channel = document.getElementById('inf-channel').value;
                const followers = document.getElementById('inf-followers').value;
                let topicText = channel;
                if(followers) topicText += ` (${followers} Followers)`;
                document.getElementById('svg-topic').textContent = topicText;

                const sourceSelect = document.getElementById('inf-source').value;
                const sourceOther = document.getElementById('inf-source-other').value;
                document.getElementById('svg-channels').textContent = sourceSelect === 'Altro' ? sourceOther : sourceSelect;
            }
        }

        // --- GESTIONE STATO CANALI EDITORIALE ---
        let channelsData = [];
        const AVAILABLE_CHANNELS = ["Facebook", "Linkedin", "Instagram", "X", "YouTube", "WhatsApp"];

        function initChannelsUI() {
            const adder = document.querySelector('.channel-adder');
            const activeList = document.getElementById('active-channels');
            if(adder) adder.style.display = 'none';
            if(activeList) activeList.style.display = 'none';
            
            if (!document.getElementById('channels-container')) {
                const newContainer = document.createElement('div');
                newContainer.id = 'channels-container';
                newContainer.style.display = 'flex';
                newContainer.style.flexDirection = 'column';
                newContainer.style.gap = '8px';
                if(adder) adder.parentElement.insertBefore(newContainer, activeList);
            }
        }
        
        initChannelsUI();

        function updateChannelString() {
            if (currentTab !== 'editoriale') return;
            const svgChannels = document.getElementById('svg-channels');
            const active = channelsData.filter(c => c.count > 0);
            if (active.length === 0) {
                svgChannels.textContent = "";
                return;
            }
            const str = active.map(c => `${c.name} ${c.count}`).join(', ');
            svgChannels.textContent = str;
        }

        function renderChannelList() {
            initChannelsUI(); 
            const container = document.getElementById('channels-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            AVAILABLE_CHANNELS.forEach(channelName => {
                const data = channelsData.find(c => c.name === channelName);
                const count = data ? parseInt(data.count) : 0;
                
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.alignItems = 'center';
                row.style.gap = '5px';
                row.style.background = count > 0 ? '#eef4ff' : '#eee';
                row.style.padding = '6px';
                row.style.borderRadius = '4px';

                const nameLabel = document.createElement('span');
                nameLabel.style.width = '75px';
                nameLabel.style.fontWeight = count > 0 ? 'bold' : 'normal';
                nameLabel.style.fontSize = '0.85rem';
                nameLabel.style.color = '#333';
                nameLabel.textContent = channelName;
                row.appendChild(nameLabel);

                for(let i=1; i<=5; i++) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = i;
                    btn.style.padding = '4px 8px';
                    btn.style.fontSize = '0.9rem';
                    btn.style.border = '1px solid #ccc';
                    btn.style.borderRadius = '3px';
                    btn.style.cursor = 'pointer';
                    btn.style.fontWeight = 'normal';
                    btn.style.backgroundColor = (count === i) ? '#0033A0' : 'white';
                    btn.style.color = (count === i) ? 'white' : '#333';
                    btn.onclick = () => setChannelCount(channelName, i);
                    row.appendChild(btn);
                }

                const customInput = document.createElement('input');
                customInput.type = 'number';
                customInput.min = '1';
                customInput.style.width = '45px';
                customInput.style.padding = '4px';
                customInput.style.fontSize = '0.9rem';
                customInput.style.border = '1px solid #ccc';
                customInput.style.borderRadius = '3px';
                customInput.style.textAlign = 'center';
                customInput.value = (count > 5 || (count > 0 && count < 1)) ? count : '';
                customInput.placeholder = '#';
                customInput.oninput = (e) => {
                    const val = parseInt(e.target.value);
                    if(val > 0) setChannelCount(channelName, val);
                    else if(e.target.value === '') setChannelCount(channelName, 0);
                };
                row.appendChild(customInput);

                const removeBtn = document.createElement('span');
                removeBtn.textContent = 'X';
                removeBtn.style.color = 'red';
                removeBtn.style.fontWeight = 'bold';
                removeBtn.style.cursor = 'pointer';
                removeBtn.style.marginLeft = 'auto';
                removeBtn.style.padding = '0 5px';
                removeBtn.onclick = () => setChannelCount(channelName, 0);
                row.appendChild(removeBtn);

                container.appendChild(row);
            });
            updateChannelString();
        }

        function setChannelCount(name, count) {
            const index = channelsData.findIndex(c => c.name === name);
            if (count > 0) {
                if (index > -1) channelsData[index].count = count;
                else channelsData.push({ name, count });
            } else {
                if (index > -1) channelsData.splice(index, 1);
            }
            renderChannelList();
        }

        window.removeChannel = function(index) {
            channelsData.splice(index, 1);
            renderChannelList();
        }
        
        renderChannelList();

        // --- BINDING EVENTI INPUT ---
        
        // Editoriale
        document.getElementById('brand').addEventListener('change', updateSVGText);
        document.getElementById('topic').addEventListener('input', updateSVGText);
        
        // Influencer
        document.getElementById('inf-brand').addEventListener('input', updateSVGText);
        document.getElementById('inf-channel').addEventListener('change', updateSVGText);
        document.getElementById('inf-followers').addEventListener('input', updateSVGText);
        document.getElementById('inf-source').addEventListener('change', updateSVGText);
        document.getElementById('inf-source-other').addEventListener('input', updateSVGText);

        // Date Handling
        function handleDateChange(val) {
            if(!val) return;
            const parts = val.split('-');
            const formatted = `${parts[2]}/${parts[1]}/${parts[0]}`;
            document.getElementById('svg-date').textContent = formatted;
        }

        document.getElementById('date').addEventListener('change', function(e) {
            document.getElementById('inf-date').value = e.target.value;
            handleDateChange(e.target.value);
        });
        document.getElementById('inf-date').addEventListener('change', function(e) {
            document.getElementById('date').value = e.target.value;
            handleDateChange(e.target.value);
        });

        const today = new Date();
        const dd = String(today.getDate()).padStart(2, '0');
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const yyyy = today.getFullYear();
        const todayStr = `${yyyy}-${mm}-${dd}`;
        
        document.getElementById('date').value = todayStr;
        document.getElementById('inf-date').value = todayStr;
        document.getElementById('svg-date').textContent = `${dd}/${mm}/${yyyy}`;


        // --- GESTIONE COPIA/INCOLLA IMMAGINE ---
        document.addEventListener('paste', function(e) {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.includes('image/')) {
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const base64data = event.target.result;
                        document.getElementById('svg-image').setAttribute('href', base64data);
                        document.getElementById('placeholder-bg').style.display = 'none';
                    };
                    reader.readAsDataURL(blob);
                }
            }
        });

        // --- ESPORTAZIONE SVG ---
        function downloadSVG() {
            const svgElement = document.getElementById('canvas');
            
            const serializer = new XMLSerializer();
            let source = serializer.serializeToString(svgElement);

            if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
                source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
            }
            if(!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)){
                source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
            }

            source = '<?xml version="1.0" standalone="no"?>\r\n' + source;

            const blob = new Blob([source], {type: 'image/svg+xml;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const downloadLink = document.createElement("a");
            
            const dateStr = document.getElementById('svg-date').textContent.replace(/\//g, '-');
            downloadLink.href = url;
            downloadLink.download = `Grafica_${dateStr}.svg`;
            
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
        }

        // --- SALVATAGGIO E CARICAMENTO JSON ---
        window.saveJSON = function() {
            const projectData = {
                tab: currentTab,
                editoriale: {
                    brand: document.getElementById('brand').value,
                    date: document.getElementById('date').value,
                    topic: document.getElementById('topic').value,
                    channels: channelsData
                },
                influencer: {
                    brand: document.getElementById('inf-brand').value,
                    date: document.getElementById('inf-date').value,
                    channel: document.getElementById('inf-channel').value,
                    followers: document.getElementById('inf-followers').value,
                    source: document.getElementById('inf-source').value,
                    sourceOther: document.getElementById('inf-source-other').value
                },
                image: document.getElementById('svg-image').getAttribute('href') || ''
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "progetto_grafica.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        window.loadJSON = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const pd = JSON.parse(e.target.result);
                    
                    if (pd.tab) switchTab(pd.tab);
                    
                    if (pd.editoriale || pd.brand) { // Supporto retroattivo per vecchi salvataggi
                        const ed = pd.editoriale || pd;
                        if (ed.brand) document.getElementById('brand').value = ed.brand;
                        if (ed.date) {
                            document.getElementById('date').value = ed.date;
                            document.getElementById('inf-date').value = ed.date;
                            handleDateChange(ed.date);
                        }
                        if (ed.topic) document.getElementById('topic').value = ed.topic;
                        if (ed.channels) {
                            channelsData = ed.channels;
                            renderChannelList();
                        }
                    }
                    
                    if (pd.influencer) {
                        const inf = pd.influencer;
                        if (inf.brand) document.getElementById('inf-brand').value = inf.brand;
                        if (inf.date) {
                            document.getElementById('date').value = inf.date;
                            document.getElementById('inf-date').value = inf.date;
                            handleDateChange(inf.date);
                        }
                        if (inf.channel) document.getElementById('inf-channel').value = inf.channel;
                        if (inf.followers) document.getElementById('inf-followers').value = inf.followers;
                        if (inf.source) document.getElementById('inf-source').value = inf.source;
                        if (inf.sourceOther) document.getElementById('inf-source-other').value = inf.sourceOther;
                        toggleInfSourceOther();
                    }
                    
                    if (pd.image) {
                        document.getElementById('svg-image').setAttribute('href', pd.image);
                        document.getElementById('placeholder-bg').style.display = 'none';
                    }
                    
                    updateSVGText();
                    
                } catch (err) {
                    alert("Errore nel caricamento del file JSON.");
                }
            };
            reader.readAsText(file);
            event.target.value = ''; 
        };
        
        // Init visualizzazione Testi
        updateSVGText();
    </script>
</body>
</html>
