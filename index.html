<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Social Mockup</title>
  <link rel="icon" href="favicon.png" />
  <!-- Librerie -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 20px; font-family: Arial, sans-serif; background: #f5f5f5; }
    h1 { text-align: center; color: #0033A0; margin-bottom: 20px; }
    .global-controls { text-align: center; margin-bottom: 20px; }
    .global-controls button { margin: 0 10px; padding: 10px 20px; border: none; border-radius: 4px; background: #0033A0; color: #fff; cursor: pointer; }
    .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
    .tabs button { padding: 8px 16px; border: none; border-radius: 4px; background: #FFD700; color: #0033A0; cursor: pointer; }
    .tabs button.active { background: #fff; border: 2px solid #0033A0; }
    .tab-content, .social-section { display: none; }
    .tab-content.active, .social-section.active { display: block; }
    .mockup-container { background: #fff; width: 520px; margin: 20px auto; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .mockup-header img, .mockup-footer img, .mockup-image { width: 100%; display: block; }
    .mockup-text { padding: 10px 15px; font-size: 15px; white-space: pre-wrap; color: #050505; }
    .mockup-text .link { color: #1877f2; }
    .controls { text-align: center; margin: 15px 0; }
    .controls textarea { width: 520px; height: 80px; padding: 10px; font-size: 14px; margin-bottom: 10px; }
    .controls input[type="file"] { margin-bottom: 10px; }
    .controls button { margin: 0 10px; padding: 8px 16px; border: none; border-radius: 4px; background: #0033A0; color: #fff; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Social Mockup</h1>
  <div class="global-controls">
    <button id="btn-reset">Cancella tutto</button>
    <button id="btn-download">Scarica tutti (ZIP)</button>
  </div>

  <!-- News Tabs -->
  <div class="tabs" id="news-tabs">
    <button class="active">News 1</button>
    <button>News 2</button>
    <button>News 3</button>
    <button>News 4</button>
    <button>News 5</button>
  </div>

  <!-- Contents -->
  <!-- Generate News 1 to 5 -->
  <script>
    const newsCount = 5;
    const platforms = ['facebook','linkedin','x','instagram'];

    // Create content sections
    const newsTabs = document.getElementById('news-tabs');
    newsTabs.addEventListener('click', e => {
      if (e.target.tagName !== 'BUTTON') return;
      selectNews(Array.from(newsTabs.children).indexOf(e.target) + 1);
    });

    const contentContainer = document.createDocumentFragment();
    for (let i = 1; i <= newsCount; i++) {
      const tab = document.createElement('div');
      tab.id = `news${i}`;
      tab.className = 'tab-content' + (i === 1 ? ' active' : '');
      // social tabs
      const socialTabs = document.createElement('div');
      socialTabs.className = 'tabs social-tabs';
      platforms.forEach((plat, idx) => {
        const btn = document.createElement('button');
        btn.textContent = plat.charAt(0).toUpperCase() + plat.slice(1);
        if (idx === 0) btn.classList.add('active');
        socialTabs.appendChild(btn);
      });
      socialTabs.addEventListener('click', e => {
        if (e.target.tagName !== 'BUTTON') return;
        selectSocial(i, platforms[Array.from(socialTabs.children).indexOf(e.target)]);
      });
      tab.appendChild(socialTabs);
      // social sections
      platforms.forEach((plat, idx) => {
        const sec = document.createElement('div');
        sec.id = `news${i}-${plat}`;
        sec.className = 'social-section' + (idx === 0 ? ' active' : '');
        sec.innerHTML = `
          <div class="mockup-container">
            <div class="mockup-header"><img src="Alto${plat.charAt(0).toUpperCase()+plat.slice(1)}.png" alt="header"></div>
            <div class="mockup-text" id="text${i}-${plat}"></div>
            <img class="mockup-image" id="img${i}-${plat}" style="display:none" alt="image">
            <div class="mockup-footer"><img src="Basso${plat.charAt(0).toUpperCase()+plat.slice(1)}.png" alt="footer"></div>
          </div>
        `;
        tab.appendChild(sec);
      });
      // controls
      const ctrl = document.createElement('div');
      ctrl.className = 'controls';
      ctrl.innerHTML = `
        <textarea id="input${i}" placeholder="Scrivi il testo del post..."></textarea><br>
        <input type="file" id="file${i}"><br>
        <button onclick="saveNews(${i})">Salva</button>
        <button onclick="resetNews(${i})">Cancella</button>
      `;
      tab.appendChild(ctrl);
      contentContainer.appendChild(tab);
    }
    document.body.appendChild(contentContainer);

    // Global buttons
    document.getElementById('btn-reset').onclick = () => { for (let i=1; i<=newsCount; i++) resetNews(i); };
    document.getElementById('btn-download').onclick = downloadAll;

    let currentNews = 1;
    let currentPlat = 'facebook';

    function selectNews(i) {
      currentNews = i;
      // tabs
      document.querySelectorAll('#news-tabs button').forEach((b, idx) => b.classList.toggle('active', idx+1 === i));
      // contents
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`news${i}`).classList.add('active');
      // reset social
      selectSocial(i, 'facebook');
    }

    function selectSocial(newsIdx, plat) {
      currentPlat = plat;
      const tab = document.getElementById(`news${newsIdx}`);
      // social tabs
      tab.querySelectorAll('.social-tabs button').forEach((b, idx) => b.classList.toggle('active', platforms[idx] === plat));
      // sections
      tab.querySelectorAll('.social-section').forEach(s => s.classList.remove('active'));
      tab.querySelector(`#news${newsIdx}-${plat}`).classList.add('active');
    }

    function formatText(t) {
      return t.replace(/(#[\w\d]+|@[\w\d]+|https?:\/\/\S+)/g, '<span class="link">$1</span>');
    }

    function saveNews(i) {
      const raw = document.getElementById(`input${i}`).value;
      const formatted = formatText(raw);
      if (currentPlat === 'facebook') {
        platforms.forEach(p => {
          document.getElementById(`text${i}-${p}`).innerHTML = formatted;
          localStorage.setItem(`text${i}-${p}`, raw);
        });
      } else {
        document.getElementById(`text${i}-${currentPlat}`).innerHTML = formatted;
        localStorage.setItem(`text${i}-${currentPlat}`, raw);
      }
      const fileInput = document.getElementById(`file${i}`);
      if (fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = () => {
          platforms.forEach(p => {
            if (currentPlat === 'facebook' || p === currentPlat) {
              const imgE = document.getElementById(`img${i}-${p}`);
              imgE.src = reader.result;
              imgE.style.display = 'block';
              localStorage.setItem(`img${i}-${p}`, reader.result);
            }
          });
        };
        reader.readAsDataURL(fileInput.files[0]);
      }
    }

    function resetNews(i) {
      platforms.forEach(p => {
        localStorage.removeItem(`text${i}-${p}`);
        localStorage.removeItem(`img${i}-${p}`);
        document.getElementById(`text${i}-${p}`).innerHTML = '';
        const imgE = document.getElementById(`img${i}-${p}`);
        imgE.src = '';
        imgE.style.display = 'none';
      });
      document.getElementById(`input${i}`).value = '';
      document.getElementById(`file${i}`).value = null;
    }

    function downloadAll() {
      const zip = new JSZip();
      const promises = platforms.map(p => {
        const sec = document.getElementById(`news${currentNews}-${p}`);
        const wasHidden = !sec.classList.contains('active');
        if (wasHidden) sec.classList.add('active');
        return html2canvas(sec.querySelector('.mockup-container'), { backgroundColor: '#ffffff' })
          .then(canvas => new Promise(res => canvas.toBlob(blob => {
            zip.file(`news${currentNews}-${p}.jpg`, blob);
            res();
          }, 'image/jpeg', 1.0)))
          .finally(() => { if (wasHidden) sec.classList.remove('active'); });
      });
      Promise.all(promises).then(() => {
        zip.generateAsync({ type: 'blob' }).then(content => saveAs(content, `news${currentNews}.zip`));
      });
    }

    window.onload = () => {
      // load storage
      for (let i=1; i<=newsCount; i++) {
        platforms.forEach(p => {
          const txt = localStorage.getItem(`text${i}-${p}`);
          const img = localStorage.getItem(`img${i}-${p}`);
          if (txt) document.getElementById(`text${i}-${p}`).innerHTML = formatText(txt);
          if (img) { const el = document.getElementById(`img${i}-${p}`); el.src = img; el.style.display = 'block'; }
        });
      }
    };
  </script>
</body>
</html>
