<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Grafiche Social</title>
    <style>
        :root {
            --primary: #0066CC; /* Accent Color Apple-like */
            --bg-gray: #F5F5F7;
            --surface: #FFFFFF;
            --text-main: #1D1D1F;
            --text-muted: #86868B;
            --border-color: #D2D2D7;
            --radius-lg: 12px;
            --radius-md: 8px;
            --shadow-soft: 0 4px 14px rgba(0,0,0,0.04), 0 1px 4px rgba(0,0,0,0.02);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: var(--bg-gray);
            color: var(--text-main);
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Header Trasversale */
        .app-header {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
        }
        
        .app-header h1 {
            margin: 0;
            color: var(--text-main);
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.01em;
        }
        
        .app-header-tools {
            display: flex;
            gap: 12px;
        }

        /* Layout Principale */
        .main-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar Controlli */
        .sidebar {
            width: 420px;
            background: var(--surface);
            padding: 24px;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
            z-index: 10;
        }

        .sidebar h2 {
            margin-top: 0;
            color: var(--text-main);
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 20px;
            letter-spacing: -0.01em;
        }

        /* Tab Styles (Segmented Control Apple style) */
        .tabs {
            display: flex;
            background: rgba(118, 118, 128, 0.12);
            padding: 3px;
            border-radius: 9px;
            margin-bottom: 8px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 6px 0;
            background: transparent !important;
            color: var(--text-main) !important;
            border: none !important;
            border-radius: 7px !important;
            cursor: pointer;
            font-weight: 500 !important;
            font-size: 0.85rem !important;
            text-align: center;
            box-shadow: none !important;
            transition: background 0.2s, box-shadow 0.2s;
        }
        
        .tab-btn.active {
            background: var(--surface) !important;
            box-shadow: 0 3px 8px rgba(0,0,0,0.12), 0 3px 1px rgba(0,0,0,0.04) !important;
            font-weight: 600 !important;
        }
        
        .tab-content {
            display: none;
            flex-direction: column;
            gap: 20px;
        }
        
        .tab-content.active {
            display: flex;
        }

        /* Forms & Inputs */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--text-main);
            letter-spacing: -0.01em;
        }

        input[type="text"], input[type="date"], input[type="number"], select {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            background-color: var(--surface);
            color: var(--text-main);
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
            -webkit-appearance: none;
            appearance: none;
            font-family: inherit;
        }

        select {
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2386868B%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 12px top 50%;
            background-size: 10px auto;
            padding-right: 30px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2);
        }

        /* Override stili inline dei Bottoni e pulizia colori */
        button {
            background: var(--surface) !important;
            color: var(--text-main) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: var(--radius-md) !important;
            padding: 8px 14px !important;
            font-size: 0.9rem !important;
            font-weight: 500 !important;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04) !important;
            transition: all 0.2s ease !important;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        button:hover {
            background: var(--bg-gray) !important;
        }
        
        /* Primary Actions */
        button[onclick="downloadSVG()"], 
        button[onclick="downloadAllSVGs()"] {
            background: var(--primary) !important;
            color: white !important;
            border-color: var(--primary) !important;
            font-weight: 600 !important;
        }
        
        button[onclick="downloadSVG()"]:hover, 
        button[onclick="downloadAllSVGs()"]:hover {
            background: #005bb5 !important;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3) !important;
        }

        /* Override stili inline di Card Controls */
        .card-controls {
            background: var(--surface) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: var(--radius-lg) !important;
            padding: 12px 16px !important;
            box-shadow: var(--shadow-soft) !important;
            margin-bottom: 20px !important;
        }
        
        .card-controls span#card-indicator,
        .card-controls span[style*="font-weight: bold"] {
            color: var(--text-main) !important;
            font-weight: 600 !important;
            font-size: 0.9rem !important;
        }

        /* Override stili inline della Lista Canali */
        #channels-container > div {
            background: var(--surface) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: var(--radius-md) !important;
            padding: 8px 12px !important;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02) !important;
            margin-bottom: 6px !important;
        }
        
        #channels-container span {
            color: var(--text-main) !important;
            font-weight: 500 !important;
        }
        
        #channels-container span[style*="font-weight: bold"] {
            font-weight: 600 !important;
        }
        
        #channels-container span.remove, 
        #channels-container span[onclick*="setChannelCount"] {
            color: #FF3B30 !important; /* System Red */
            font-weight: 500 !important;
            font-size: 0.85rem !important;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        #channels-container span.remove:hover {
            opacity: 1;
        }
        
        #channels-container button {
            border-radius: 6px !important;
            padding: 4px 10px !important;
            font-size: 0.85rem !important;
            box-shadow: none !important;
        }
        
        #channels-container button[style*="0, 51, 160"],
        #channels-container button[style*="#0033A0"],
        #channels-container button[style*="#0033a0"] {
            background: var(--text-main) !important; 
            color: white !important;
            border-color: var(--text-main) !important;
        }

        /* Area Istruzioni Immagine */
        .paste-instruction {
            background: rgba(118, 118, 128, 0.05);
            border: 1px dashed var(--border-color);
            padding: 20px;
            text-align: center;
            border-radius: var(--radius-lg);
            color: var(--text-muted);
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .paste-instruction strong {
            color: var(--text-main);
            font-weight: 600;
            display: block;
            margin-bottom: 4px;
            font-size: 0.95rem;
        }

        /* Area Preview */
        .preview-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            overflow: auto;
            background: var(--bg-gray);
        }

        /* Contenitore SVG con shadow soft e transizioni fluide */
        .svg-container {
            width: 100%;
            max-width: 800px;
            aspect-ratio: 1200 / 1185;
            border-radius: var(--radius-lg);
            overflow: hidden;
            background-color: #ffffff; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.04) !important;
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
        }
        
        /* Intercetta l'inline style JS per lo stato attivo */
        .svg-container[style*="box-shadow: 0 0 0 4px"] {
            box-shadow: 0 0 0 4px var(--primary), 0 20px 50px rgba(0,0,0,0.12) !important;
            transform: scale(1.01);
        }

        svg {
            width: 100%;
            height: 100%;
            display: block;
            border-radius: var(--radius-lg);
        }

    </style>
</head>
<body>

    <header class="app-header">
        <h1>Generatore Grafiche Social</h1>
        <div class="app-header-tools">
            <button onclick="saveJSON()" style="background-color: #ffc107; color: #333;">ðŸ’¾ Esporta JSON</button>
            <button onclick="document.getElementById('file-input').click()" style="background-color: #17a2b8;">ðŸ“‚ Importa JSON</button>
            <input type="file" id="file-input" style="display: none;" accept=".json" onchange="loadJSON(event)">
            <button onclick="downloadAllSVGs()" style="background-color: #28a745;">ðŸ“¥ Scarica Tutti gli SVG</button>
        </div>
    </header>

    <div class="main-wrapper">
        <div class="sidebar">
            <div class="tabs">
                <div id="btn-editoriale" class="tab-btn active" onclick="switchTab('editoriale')">Editoriale</div>
                <div id="btn-influencer" class="tab-btn" onclick="switchTab('influencer')">Influencer</div>
                <div id="btn-people" class="tab-btn" onclick="switchTab('people')">People</div>
            </div>

            <div class="card-controls" style="display: flex; justify-content: space-between; align-items: center; background: #e9f5ff; padding: 10px; border-radius: 4px; border: 1px solid var(--primary); margin-bottom: 15px;">
                <button onclick="prevCard()" style="padding: 5px 15px; background-color: var(--primary);">&lt;</button>
                <span id="card-indicator" style="font-weight: bold; color: var(--primary);">Card 1 / 1</span>
                <button onclick="nextCard()" style="padding: 5px 15px; background-color: var(--primary);">&gt;</button>
                <button onclick="addCard()" class="btn-add" style="padding: 5px 15px; margin-left: 10px;">+</button>
                <button onclick="removeCard()" style="padding: 5px 15px; background-color: #dc3545;">-</button>
            </div>

            <div id="tab-editoriale" class="tab-content active">
                <button onclick="openSummaryModal()" style="background: #e9f5ff !important; border: 1px dashed var(--primary) !important; color: var(--primary) !important; width: 100%; justify-content: center; margin-bottom: 15px; font-weight: 600 !important; padding: 12px !important; box-shadow: none !important;">ðŸ“Š Mostra Dati di Sintesi</button>
                
                <div id="summaryModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); backdrop-filter:blur(3px); z-index:999; justify-content:center; align-items:center;">
                    <div style="background:var(--surface); padding:24px; border-radius:var(--radius-lg); width:450px; max-width:90%; box-shadow:0 20px 50px rgba(0,0,0,0.2);">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <h3 style="margin:0; font-size:1.2rem; color:var(--text-main);">Dati di Sintesi Editoriale</h3>
                            <button onclick="closeSummaryModal()" style="padding:4px 8px!important; border:none!important; box-shadow:none!important; font-size:1.2rem!important; background:transparent!important; color:var(--text-muted)!important; cursor:pointer;">âœ–</button>
                        </div>
                        
                        <div style="margin-bottom:16px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <strong style="font-size:0.95rem;">1) Numero totale di post:</strong>
                                <button onclick="copySummary('totPost', this)" style="padding:4px 10px!important; font-size:0.8rem!important; border:1px solid #ddd!important; box-shadow:none!important;">ðŸ“‹ Copia</button>
                            </div>
                            <div id="sum-totPost" style="margin-top:8px; padding:12px; background:var(--bg-gray); border-radius:var(--radius-md); font-size:0.95rem; border:1px solid var(--border-color);"></div>
                        </div>

                        <div style="margin-bottom:16px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <strong style="font-size:0.95rem;">2) Numero di post per canale:</strong>
                                <button onclick="copySummary('totChannels', this)" style="padding:4px 10px!important; font-size:0.8rem!important; border:1px solid #ddd!important; box-shadow:none!important;">ðŸ“‹ Copia</button>
                            </div>
                            <div id="sum-totChannels" style="margin-top:8px; padding:12px; background:var(--bg-gray); border-radius:var(--radius-md); font-size:0.95rem; white-space:pre-wrap; line-height:1.5; border:1px solid var(--border-color);"></div>
                        </div>

                        <div style="margin-bottom:16px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <strong style="font-size:0.95rem;">3) Elenco argomenti:</strong>
                                <button onclick="copySummary('totTopics', this)" style="padding:4px 10px!important; font-size:0.8rem!important; border:1px solid #ddd!important; box-shadow:none!important;">ðŸ“‹ Copia</button>
                            </div>
                            <div id="sum-totTopics" style="margin-top:8px; padding:12px; background:var(--bg-gray); border-radius:var(--radius-md); font-size:0.95rem; white-space:pre-wrap; line-height:1.5; max-height:150px; overflow-y:auto; border:1px solid var(--border-color);"></div>
                        </div>
                    </div>
                </div>

                <script>
                function openSummaryModal() {
                    const cards = appState['editoriale'];
                    let totPosts = 0;
                    let channelCounts = { 'Facebook': 0, 'Instagram': 0, 'Linkedin': 0, 'X': 0, 'YouTube': 0, 'WhatsApp': 0 };
                    let topics = [];

                    cards.forEach(card => {
                        if(card.topic && card.topic.trim() !== '') {
                            topics.push(card.topic);
                        }
                        if(card.channels) {
                            card.channels.forEach(c => {
                                let cnt = parseInt(c.count) || 0;
                                if(cnt > 0) {
                                    totPosts += cnt;
                                    if(channelCounts[c.name] !== undefined) {
                                        channelCounts[c.name] += cnt;
                                    } else {
                                        channelCounts[c.name] = cnt;
                                    }
                                }
                            });
                        }
                    });

                    document.getElementById('sum-totPost').innerText = totPosts;
                    
                    let chArray = [];
                    ["Facebook", "Instagram", "Linkedin", "X", "YouTube", "WhatsApp"].forEach(ch => {
                        if (channelCounts[ch] > 0) {
                            chArray.push(ch + " " + channelCounts[ch]);
                        }
                    });
                    document.getElementById('sum-totChannels').innerText = chArray.length > 0 ? chArray.join(", ") : "Nessun post nei canali";
                    
                    document.getElementById('sum-totTopics').innerText = topics.length > 0 ? topics.join("\n") : "Nessun argomento inserito";
                    
                    document.getElementById('summaryModal').style.display = 'flex';
                }

                function closeSummaryModal() {
                    document.getElementById('summaryModal').style.display = 'none';
                }

                function copySummary(id, btn) {
                    const text = document.getElementById('sum-' + id).innerText;
                    navigator.clipboard.writeText(text).then(() => {
                        const originalText = btn.innerHTML;
                        btn.innerHTML = 'âœ… Copiato';
                        setTimeout(() => btn.innerHTML = originalText, 1500);
                    }).catch(err => {
                        alert('Errore durante la copia');
                    });
                }
                </script>

                <div class="form-group">
                    <label for="brand">1. Nome Pagina</label>
                    <select id="brand" onchange="syncFormToState()">
                        <option value="Poste Italiane">Poste Italiane</option>
                        <option value="Postepay">Postepay</option>
                        <option value="PosteMobile">PosteMobile</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="date">2. Data</label>
                    <input type="date" id="date" onchange="syncFormToState()">
                </div>

                <div class="form-group">
                    <label for="topic">3. Argomento</label>
                    <input type="text" id="topic" oninput="syncFormToState()" placeholder="Inserisci l'argomento">
                </div>

                <div class="form-group">
                    <label>4. Elenco Canali</label>
                    <div id="channels-container" style="display: flex; flex-direction: column; gap: 8px;"></div>
                </div>
            </div>

            <div id="tab-influencer" class="tab-content">
                <div class="form-group">
                    <label for="inf-brand">1. Nome Pagina</label>
                    <input type="text" id="inf-brand" oninput="syncFormToState()" placeholder="Es. Mario Rossi">
                </div>

                <div class="form-group">
                    <label for="inf-date">2. Data</label>
                    <input type="date" id="inf-date" onchange="syncFormToState()">
                </div>

                <div class="form-group">
                    <label for="inf-channel">3. Canale e Followers</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="inf-channel" style="flex: 1;" onchange="syncFormToState()">
                            <option value="Facebook">Facebook</option>
                            <option value="Linkedin">Linkedin</option>
                            <option value="X">X</option>
                            <option value="Instagram">Instagram</option>
                            <option value="YouTube">YouTube</option>
                            <option value="TikTok">TikTok</option>
                        </select>
                        <input type="text" id="inf-followers" style="flex: 1;" oninput="syncFormToState()" placeholder="es. 3,3K">
                    </div>
                </div>

                <div class="form-group">
                    <label for="inf-source">4. Tipo di fonte</label>
                    <select id="inf-source" onchange="toggleInfSourceOther(); syncFormToState();">
                        <option value="News online">News online</option>
                        <option value="News locali online">News locali online</option>
                        <option value="Account ufficiale">Account ufficiale</option>
                        <option value="Politico">Politico</option>
                        <option value="Giornalista">Giornalista</option>
                        <option value="Influencer/blogger">Influencer/blogger</option>
                        <option value="Altro">Altro</option>
                    </select>
                    <input type="text" id="inf-source-other" style="display: none; margin-top: 10px;" oninput="syncFormToState()" placeholder="Specifica fonte">
                </div>
            </div>

            <div id="tab-people" class="tab-content">
                <div class="form-group">
                    <label for="people-channel">1. Canale Social</label>
                    <select id="people-channel" onchange="syncFormToState()">
                        <option value="X">X</option>
                        <option value="Facebook">Facebook</option>
                        <option value="Linkedin">Linkedin</option>
                        <option value="Instagram">Instagram</option>
                        <option value="YouTube">YouTube</option>
                        <option value="TikTok">TikTok</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="people-date">2. Data</label>
                    <input type="date" id="people-date" onchange="syncFormToState()">
                </div>
            </div>

            <div class="form-group" style="margin-top: 10px;">
                <label>Immagine</label>
                <div class="paste-instruction">
                    <strong>CTRL+V (o CMD+V)</strong><br>
                    Incolla un'immagine. L'immagine Ã¨ indipendente per ogni card.
                </div>
            </div>

            <button onclick="downloadSVG()" style="margin-top: auto; font-size: 1.1rem; padding: 15px;">ðŸ“¥ Scarica SVG Corrente</button>
        </div>

        <div class="preview-area" id="preview-area" style="flex-direction: column; justify-content: flex-start; gap: 40px; padding-bottom: 50px;">
            </div>
    </div>

    <script>
        const today = new Date();
        const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

        function getDefaultCard(tab) {
            if(tab === 'editoriale') return { brand: 'Poste Italiane', date: todayStr, topic: 'Notizie dal territorio', channels: [], image: '' };
            if(tab === 'influencer') return { brand: '', date: todayStr, channel: 'Facebook', followers: '', source: 'News online', sourceOther: '', image: '' };
            if(tab === 'people') return { channel: 'X', date: todayStr, image: '' };
        }

        let appState = {
            editoriale: [getDefaultCard('editoriale')],
            influencer: [getDefaultCard('influencer')],
            people: [getDefaultCard('people')]
        };
        let currentTab = 'editoriale';
        let currentCardIdx = { editoriale: 0, influencer: 0, people: 0 };
        const AVAILABLE_CHANNELS = ["Facebook", "Linkedin", "Instagram", "X", "YouTube", "WhatsApp"];

        function toggleInfSourceOther() {
            const select = document.getElementById('inf-source');
            const otherInput = document.getElementById('inf-source-other');
            otherInput.style.display = select.value === 'Altro' ? 'block' : 'none';
        }

        window.switchTab = function(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('btn-' + tab).classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
            syncStateToForm();
        };

        window.prevCard = function() {
            if (currentCardIdx[currentTab] > 0) { currentCardIdx[currentTab]--; syncStateToForm(); }
        };
        window.nextCard = function() {
            if (currentCardIdx[currentTab] < appState[currentTab].length - 1) { currentCardIdx[currentTab]++; syncStateToForm(); }
        };
        window.addCard = function() {
            appState[currentTab].push(getDefaultCard(currentTab));
            currentCardIdx[currentTab] = appState[currentTab].length - 1;
            syncStateToForm();
        };
        window.removeCard = function() {
            if (appState[currentTab].length > 1) {
                appState[currentTab].splice(currentCardIdx[currentTab], 1);
                if (currentCardIdx[currentTab] >= appState[currentTab].length) currentCardIdx[currentTab] = appState[currentTab].length - 1;
                syncStateToForm();
            } else alert("Non puoi rimuovere l'unica card.");
        };

        window.syncStateToForm = function() {
            const card = appState[currentTab][currentCardIdx[currentTab]];
            if (currentTab === 'editoriale') {
                document.getElementById('brand').value = card.brand;
                document.getElementById('date').value = card.date;
                document.getElementById('topic').value = card.topic;
                renderChannelList();
            } else if (currentTab === 'influencer') {
                document.getElementById('inf-brand').value = card.brand;
                document.getElementById('inf-date').value = card.date;
                document.getElementById('inf-channel').value = card.channel;
                document.getElementById('inf-followers').value = card.followers;
                document.getElementById('inf-source').value = card.source;
                document.getElementById('inf-source-other').value = card.sourceOther;
                toggleInfSourceOther();
            } else if (currentTab === 'people') {
                document.getElementById('people-channel').value = card.channel;
                document.getElementById('people-date').value = card.date;
            }
            document.getElementById('card-indicator').textContent = `Card ${currentCardIdx[currentTab] + 1} / ${appState[currentTab].length}`;
            renderPlayground();
        };

        window.syncFormToState = function() {
            const card = appState[currentTab][currentCardIdx[currentTab]];
            if (currentTab === 'editoriale') {
                card.brand = document.getElementById('brand').value;
                card.date = document.getElementById('date').value;
                card.topic = document.getElementById('topic').value;
            } else if (currentTab === 'influencer') {
                card.brand = document.getElementById('inf-brand').value;
                card.date = document.getElementById('inf-date').value;
                card.channel = document.getElementById('inf-channel').value;
                card.followers = document.getElementById('inf-followers').value;
                card.source = document.getElementById('inf-source').value;
                card.sourceOther = document.getElementById('inf-source-other').value;
            } else if (currentTab === 'people') {
                card.channel = document.getElementById('people-channel').value;
                card.date = document.getElementById('people-date').value;
            }
            renderPlayground();
        };

        function renderChannelList() {
            const container = document.getElementById('channels-container');
            container.innerHTML = '';
            const card = appState['editoriale'][currentCardIdx['editoriale']];
            if (!card.channels) card.channels = [];

            AVAILABLE_CHANNELS.forEach(channelName => {
                const data = card.channels.find(c => c.name === channelName);
                const count = data ? parseInt(data.count) : 0;
                
                const row = document.createElement('div');
                row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.gap = '5px';
                row.style.background = count > 0 ? '#eef4ff' : '#eee';
                row.style.padding = '6px'; row.style.borderRadius = '4px';

                const nameLabel = document.createElement('span');
                nameLabel.style.width = '75px'; nameLabel.style.fontSize = '0.85rem';
                nameLabel.style.fontWeight = count > 0 ? 'bold' : 'normal';
                nameLabel.textContent = channelName;
                row.appendChild(nameLabel);

                for(let i=1; i<=5; i++) {
                    const btn = document.createElement('button');
                    btn.type = 'button'; btn.textContent = i;
                    btn.style.padding = '4px 8px'; btn.style.fontSize = '0.9rem';
                    btn.style.border = '1px solid #ccc'; btn.style.borderRadius = '3px';
                    btn.style.backgroundColor = (count === i) ? '#0033A0' : 'white';
                    btn.style.color = (count === i) ? 'white' : '#333';
                    btn.onclick = () => setChannelCount(channelName, i);
                    row.appendChild(btn);
                }
                
                const customInput = document.createElement('input');
                customInput.type = 'number'; customInput.min = '1';
                customInput.style.width = '45px'; customInput.style.padding = '4px';
                customInput.value = (count > 5) ? count : '';
                customInput.placeholder = '#';
                customInput.oninput = (e) => {
                    const val = parseInt(e.target.value);
                    if(val > 0) setChannelCount(channelName, val);
                    else if(e.target.value === '') setChannelCount(channelName, 0);
                };
                row.appendChild(customInput);

                const removeBtn = document.createElement('span');
                removeBtn.textContent = 'X'; removeBtn.style.color = 'red';
                removeBtn.style.fontWeight = 'bold'; removeBtn.style.cursor = 'pointer';
                removeBtn.style.marginLeft = 'auto'; removeBtn.style.padding = '0 5px';
                removeBtn.onclick = () => setChannelCount(channelName, 0);
                row.appendChild(removeBtn);

                container.appendChild(row);
            });
        }

        function setChannelCount(name, count) {
            const card = appState['editoriale'][currentCardIdx['editoriale']];
            const index = card.channels.findIndex(c => c.name === name);
            if (count > 0) {
                if (index > -1) card.channels[index].count = count;
                else card.channels.push({ name, count });
            } else {
                if (index > -1) card.channels.splice(index, 1);
            }
            renderChannelList();
            renderPlayground();
        }

        function generateSVG(tab, card) {
            const dateParts = card.date ? card.date.split('-') : ['','',''];
            const formattedDate = card.date ? `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}` : '';
            
            let rectHeight = '150', contentY = '154', imgHeight = '1031', brandY = '45', brandSize = '38';
            let showTopics = true, brandText = card.brand, topicText = '', channelsText = '';

            if (tab === 'editoriale') {
                topicText = card.topic || '';
                const active = card.channels.filter(c => c.count > 0);
                channelsText = active.map(c => `${c.name} ${c.count}`).join(', ');
            } else if (tab === 'influencer') {
                let tText = card.channel || '';
                if (card.followers) tText += ` (${card.followers} Followers)`;
                topicText = tText;
                channelsText = card.source === 'Altro' ? card.sourceOther : card.source;
            } else if (tab === 'people') {
                rectHeight = '75'; contentY = '77'; imgHeight = '1108'; brandY = '50'; brandSize = '36';
                showTopics = false; brandText = card.channel;
            }

            const imageHref = card.image || '';
            const placeholderDisplay = imageHref ? 'none' : 'block';

            return `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1185">
                <rect x="0" y="0" width="63" height="${rectHeight}" fill="#ecdd49" />
                <rect x="0" y="${rectHeight}" width="1200" height="2" fill="#0033A0" />
                <rect x="1000" y="0" width="200" height="40" fill="#f0f4f8" rx="0"/>
                <text x="1100" y="28" font-family="Avenir Next LT Pro, Arial, sans-serif" font-size="28" font-weight="900" fill="#0033A0" text-anchor="middle" letter-spacing="1">${formattedDate}</text>
                <text x="82" y="${brandY}" font-family="Avenir Next LT Pro, Arial, sans-serif" font-size="${brandSize}" font-weight="900" fill="#0033A0" letter-spacing="-0.5">${brandText || ''}</text>
                ${showTopics ? `<text x="82" y="90" font-family="Avenir Next LT Pro, Arial, sans-serif" font-size="36" font-weight="normal" fill="#0033A0">${topicText}</text>
                <text x="82" y="132" font-family="Avenir Next LT Pro, Arial, sans-serif" font-size="30" font-weight="normal" fill="#757575">${channelsText}</text>` : ''}
                <rect x="0" y="${contentY}" width="1200" height="${imgHeight}" fill="#d3d3d3" style="display: ${placeholderDisplay}" />
                <image x="0" y="${contentY}" width="1200" height="${imgHeight}" preserveAspectRatio="xMidYMid meet" href="${imageHref}" />
            </svg>`;
        }

        let isRendering = false;
        function renderPlayground() {
            if (isRendering) return;
            isRendering = true;
            requestAnimationFrame(() => {
                const area = document.getElementById('preview-area');
                area.innerHTML = '';
                const cards = appState[currentTab];
                
                cards.forEach((card, idx) => {
                    const container = document.createElement('div');
                    container.className = 'svg-container';
                    
                    /* Previene il restringimento delle card (bug fix) e aggiunge transizioni fluide */
                    container.style.flexShrink = '0';
                    container.style.transition = 'all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1)';
                    container.style.cursor = 'pointer';
                    container.style.borderRadius = '12px';
                    
                    if (idx === currentCardIdx[currentTab]) {
                        /* Stato Attivo (Premium UI): ombra profonda e morbida, leggero scale up, nessun "bordone" invasivo */
                        container.style.boxShadow = '0 24px 48px rgba(0,0,0,0.12), 0 8px 16px rgba(0,0,0,0.04)';
                        container.style.transform = 'scale(1.02)';
                        container.style.opacity = '1';
                        container.style.border = '1px solid rgba(0,0,0,0.08)';
                    } else {
                        /* Stato Inattivo: si allontana visivamente (effetto depth/coverflow) */
                        container.style.boxShadow = '0 4px 14px rgba(0,0,0,0.03)';
                        container.style.transform = 'scale(0.96)';
                        container.style.opacity = '0.5';
                        container.style.border = '1px solid transparent';
                    }
                    
                    container.innerHTML = generateSVG(currentTab, card);
                    container.onclick = () => { currentCardIdx[currentTab] = idx; syncStateToForm(); };
                    area.appendChild(container);
                });
                
                const containers = area.querySelectorAll('.svg-container');
                if (containers[currentCardIdx[currentTab]]) {
                    containers[currentCardIdx[currentTab]].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                isRendering = false;
            });
        }

        document.addEventListener('paste', function(e) {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.includes('image/')) {
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        appState[currentTab][currentCardIdx[currentTab]].image = event.target.result;
                        renderPlayground();
                    };
                    reader.readAsDataURL(blob);
                }
            }
        });

        function pad(num) { return String(num).padStart(2, '0'); }

        window.downloadSVG = function() {
            const card = appState[currentTab][currentCardIdx[currentTab]];
            const svgString = generateSVG(currentTab, card);
            const source = '<?xml version="1.0" standalone="no"?>\r\n' + svgString;
            const blob = new Blob([source], {type: 'image/svg+xml;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const downloadLink = document.createElement("a");
            
            const dateStr = card.date ? card.date.replace(/\-/g, '') : 'data';
            downloadLink.href = url;
            downloadLink.download = `${pad(currentCardIdx[currentTab]+1)}_Grafica_${dateStr}.svg`;
            
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
        };

        window.downloadAllSVGs = async function() {
            let globalIndex = 1;
            const tabs = ['editoriale', 'influencer', 'people'];
            
            for (const tab of tabs) {
                for (let i = 0; i < appState[tab].length; i++) {
                    const card = appState[tab][i];
                    const svgString = generateSVG(tab, card);
                    const source = '<?xml version="1.0" standalone="no"?>\r\n' + svgString;
                    
                    const blob = new Blob([source], {type: 'image/svg+xml;charset=utf-8'});
                    const url = URL.createObjectURL(blob);
                    const downloadLink = document.createElement("a");
                    
                    let filename = 'grafica';
                    if(tab === 'editoriale') filename = card.topic || 'editoriale';
                    else if(tab === 'influencer') filename = card.brand || 'influencer';
                    else if(tab === 'people') filename = card.channel || 'people';
                    
                    filename = filename.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                    downloadLink.href = url;
                    downloadLink.download = `${pad(globalIndex)}_${filename}.svg`;
                    
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                    
                    globalIndex++;
                    await new Promise(r => setTimeout(r, 150));
                }
            }
        };

        window.saveJSON = function() {
            const projectData = { version: 2, state: appState };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "progetto_grafica.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        window.loadJSON = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const pd = JSON.parse(e.target.result);
                    if (pd.version === 2 && pd.state) {
                        appState = pd.state;
                    } else {
                        // RetrocompatibilitÃ  per i vecchi JSON
                        appState.editoriale[0] = { brand: pd.editoriale?.brand || 'Poste Italiane', date: pd.editoriale?.date || todayStr, topic: pd.editoriale?.topic || '', channels: pd.editoriale?.channels || [], image: pd.images?.editoriale || pd.image || '' };
                        if (pd.influencer) appState.influencer[0] = { brand: pd.influencer.brand, date: pd.influencer.date, channel: pd.influencer.channel, followers: pd.influencer.followers, source: pd.influencer.source, sourceOther: pd.influencer.sourceOther, image: pd.images?.influencer || pd.image || '' };
                        if (pd.people) appState.people[0] = { channel: pd.people.channel, date: pd.people.date, image: pd.images?.people || pd.image || '' };
                    }
                    currentCardIdx = { editoriale: 0, influencer: 0, people: 0 };
                    syncStateToForm();
                } catch (err) {
                    alert("Errore nel caricamento del file JSON.");
                }
            };
            reader.readAsText(file);
            event.target.value = ''; 
        };

        syncStateToForm();
    </script>
</body>
</html>
