<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel to SVG Converter</title>
    <style>
        /* Stili generali ispirati al branding */
        body {
            font-family: 'Avenir Next LT Pro', 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: #1d48b4;
        }
        .header h1 {
            font-size: 32px;
            font-weight: bold;
            color: #1d48b4;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 18px;
            color: #666;
        }
        .section {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .section h2 {
            font-size: 24px;
            color: #1d48b4;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-size: 16px;
            color: #333;
            margin-bottom: 8px;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 4px;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: #1d48b4;
            outline: none;
        }
        .button {
            display: inline-flex;
            align-items: center;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            background-color: #1d48b4;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .button:hover {
            background-color: #163a8f;
        }
        .button:active {
            background-color: #0f2c66;
        }
        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .button .icon {
            margin-right: 8px;
            fill: #fff;
        }
        .output {
            margin-top: 20px;
        }
        .output h3 {
            font-size: 20px;
            color: #1d48b4;
            margin-bottom: 10px;
        }
        .preview {
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #fff;
            overflow-x: auto;
        }
        /* Stili responsivi */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .header h1 {
                font-size: 24px;
            }
            .section h2 {
                font-size: 20px;
            }
            .button {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Converti Excel in Tabelle SVG</h1>
            <p>Carica un file Excel e genera tabelle grafiche in formato SVG.</p>
        </div>
        <div class="section">
            <h2>Carica File e Seleziona Layout</h2>
            <div class="form-group">
                <label for="excel-file">Seleziona file Excel</label>
                <input type="file" id="excel-file" accept=".xlsx, .xls">
            </div>
            <div class="form-group">
                <label for="layout">Seleziona layout</label>
                <select id="layout">
                    <option value="light">Light</option>
                    <option value="strong">Strong</option>
                </select>
            </div>
            <button class="button" id="generate-btn" disabled>
                <svg class="icon" width="16" height="16" viewBox="0 0 24 24"><path fill="#fff" d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm-1-11h2v4h-2zm0 6h2v2h-2z"/></svg>
                Genera SVG
            </button>
        </div>
        <div class="section output" id="output" style="display: none;">
            <h3>Anteprima e Download</h3>
            <div class="preview" id="preview"></div>
            <button class="button" id="download-btn" style="display: none;">
                <svg class="icon" width="16" height="16" viewBox="0 0 24 24"><path fill="#fff" d="M19 9h-4V3H9v6H5l7 7 7-7zm-8 2V5h2v6h1.17L12 13.17 9.83 11H11zm-6 7h14v2H5z"/></svg>
                Scarica SVG
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/3.1.2/svg.min.js"></script>
    <script>
        const excelInput = document.getElementById('excel-file');
        const layoutSelect = document.getElementById('layout');
        const generateBtn = document.getElementById('generate-btn');
        const downloadBtn = document.getElementById('download-btn');
        const outputSection = document.getElementById('output');
        const previewDiv = document.getElementById('preview');
        let svgFiles = [];

        // Abilita il pulsante di generazione quando un file è selezionato
        excelInput.addEventListener('input', () => {
            generateBtn.disabled = !excelInput.files.length;
        });

        // Formatta i numeri con K/M
        function formatNumber(num) {
            if (isNaN(num)) return num;
            num = parseFloat(num);
            if (num >= 1000000) {
                return (num / 1000000).toFixed(num % 1000000 === 0 ? 0 : 2) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(num % 1000 === 0 ? 0 : 2) + 'K';
            }
            return num.toString();
        }

        // Genera SVG
        generateBtn.addEventListener('click', async () => {
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<svg class="icon" width="16" height="16" viewBox="0 0 24 24"><path fill="#fff" d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm-1-11h2v4h-2zm0 6h2v2h-2z"/></svg> Caricamento in corso...';

            const file = excelInput.files[0];
            const layout = layoutSelect.value;
            const reader = new FileReader();

            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                // Pulisci anteprima
                previewDiv.innerHTML = '';
                svgFiles = [];

                // Parametri SVG
                const maxWidth = 2048;
                const maxHeight = 912;
                const cellPadding = 10;
                const fontSizeHeader = 18;
                const fontSizeCell = layout === 'light' ? 18 : 11;
                const lineHeight = 24;
                let currentY = 0;
                let svgIndex = 0;

                // Crea nuovo SVG
                function createNewSVG() {
                    const draw = SVG().size(maxWidth, maxHeight);
                    currentY = 20; // Margine iniziale
                    return draw;
                }

                let draw = createNewSVG();

                // Calcola larghezza colonne
                const colWidths = jsonData[0].map((_, colIndex) => {
                    let maxWidth = 100; // Larghezza minima
                    jsonData.forEach(row => {
                        const cell = row[colIndex] ? formatNumber(row[colIndex]).toString() : '';
                        const textWidth = cell.length * (fontSizeCell * 0.6); // Stima approssimativa
                        maxWidth = Math.max(maxWidth, textWidth);
                    });
                    return Math.min(maxWidth + cellPadding * 2, 300); // Limite massimo
                });

                // Disegna tabella
                function drawTable(startRow, endRow) {
                    const header = jsonData[0];
                    let y = currentY;

                    // Intestazione
                    header.forEach((text, colIndex) => {
                        const x = colWidths.slice(0, colIndex).reduce((a, b) => a + b, 20);
                        const width = colWidths[colIndex];
                        const textElement = draw.text(text.toString().toUpperCase())
                            .font({
                                family: 'Avenir Next LT Pro',
                                size: fontSizeHeader,
                                weight: 'bold'
                            })
                            .fill(layout === 'light' ? '#1d48b4' : '#ffffff')
                            .move(x + cellPadding, y);

                        if (layout === 'strong') {
                            draw.rect(width, lineHeight + cellPadding * 2)
                                .move(x, y - cellPadding)
                                .fill('#1d48b4');
                        }
                        if (layout === 'light') {
                            draw.line(x, y + lineHeight + cellPadding, x + width, y + lineHeight + cellPadding)
                                .stroke({ color: '#1d48b4', width: 1 });
                        }
                    });
                    y += lineHeight + cellPadding * 2;

                    // Righe dati
                    for (let i = startRow; i < endRow; i++) {
                        const row = jsonData[i];
                        let rowHeight = lineHeight + cellPadding * 2;

                        row.forEach((cell, colIndex) => {
                            const x = colWidths.slice(0, colIndex).reduce((a, b) => a + b, 20);
                            const width = colWidths[colIndex];
                            const formattedCell = formatNumber(cell || '');
                            const textElement = draw.text(formattedCell)
                                .font({
                                    family: 'Avenir Next LT Pro',
                                    size: fontSizeCell,
                                    weight: 'normal'
                                })
                                .fill('#4d4c4c')
                                .move(x + cellPadding, y);

                            if (layout === 'strong') {
                                if (i % 2 === 0) {
                                    draw.rect(width, rowHeight)
                                        .move(x, y - cellPadding)
                                        .fill('#c9cbd1');
                                }
                                draw.line(x, y + rowHeight - cellPadding, x + width, y + rowHeight - cellPadding)
                                    .stroke({ color: '#1d48b4', width: 1 });
                                draw.line(x, y - cellPadding, x, y + rowHeight - cellPadding)
                                    .stroke({ color: '#1d48b4', width: 1 });
                            } else {
                                draw.line(x, y + rowHeight - cellPadding, x + width, y + rowHeight - cellPadding)
                                    .stroke({ color: '#4d4c4c', width: 1 });
                            }
                        });

                        y += rowHeight;
                        currentY = y;

                        // Controlla se è necessario creare un nuovo SVG
                        if (currentY + lineHeight + cellPadding * 2 > maxHeight && i < jsonData.length - 1) {
                            const svgData = draw.svg();
                            svgFiles.push({ index: svgIndex, data: svgData });
                            const previewSvg = document.createElement('div');
                            previewSvg.innerHTML = svgData;
                            previewDiv.appendChild(previewSvg);
                            svgIndex++;
                            draw = createNewSVG();
                            currentY = 20;
                            y = currentY;
                            // Ripeti intestazione
                            header.forEach((text, colIndex) => {
                                const x = colWidths.slice(0, colIndex).reduce((a, b) => a + b, 20);
                                const width = colWidths[colIndex];
                                const textElement = draw.text(text.toString().toUpperCase())
                                    .font({
                                        family: 'Avenir Next LT Pro',
                                        size: fontSizeHeader,
                                        weight: 'bold'
                                    })
                                    .fill(layout === 'light' ? '#1d48b4' : '#ffffff')
                                    .move(x + cellPadding, y);

                                if (layout === 'strong') {
                                    draw.rect(width, lineHeight + cellPadding * 2)
                                        .move(x, y - cellPadding)
                                        .fill('#1d48b4');
                                }
                                if (layout === 'light') {
                                    draw.line(x, y + lineHeight + cellPadding, x + width, y + lineHeight + cellPadding)
                                        .stroke({ color: '#1d48b4', width: 1 });
                                }
                            });
                            y += lineHeight + cellPadding * 2;
                            currentY = y;
                        }
                    }
                }

                // Disegna tutte le righe
                drawTable(1, jsonData.length);

                // Aggiungi l'ultimo SVG
                const svgData = draw.svg();
                svgFiles.push({ index: svgIndex, data: svgData });
                const previewSvg = document.createElement('div');
                previewSvg.innerHTML = svgData;
                previewDiv.appendChild(previewSvg);

                // Mostra output
                outputSection.style.display = 'block';
                downloadBtn.style.display = 'inline-flex';
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<svg class="icon" width="16" height="16" viewBox="0 0 24 24"><path fill="#fff" d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm-1-11h2v4h-2zm0 6h2v2h-2z"/></svg> Genera SVG';
            };

            reader.readAsArrayBuffer(file);
        });

        // Scarica SVG
        downloadBtn.addEventListener('click', () => {
            downloadBtn.innerHTML = '<svg class="icon" width="16" height="16" viewBox="0 0 24 24"><path fill="#fff" d="M19 9h-4V3H9v6H5l7 7 7-7zm-8 2V5h2v6h1.17L12 13.17 9.83 11H11zm-6 7h14v2H5z"/></svg> Download in corso...';
            svgFiles.forEach((file, index) => {
                const blob = new Blob([file.data], { type: 'image/svg+xml' });
                const url = document.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `table-${index}.svg`;
                a.click();
                URL.revokeObjectURL(url);
            });
            downloadBtn.innerHTML = '<svg class="icon" width="16" height="16" viewBox="0 0 24 24"><path fill="#fff" d="M19 9h-4V3H9v6H5l7 7 7-7zm-8 2V5h2v6h1.17L12 13.17 9.83 11H11zm-6 7h14v2H5z"/></svg> Fatto!';
            setTimeout(() => {
                downloadBtn.innerHTML = '<svg class="icon" width="16" height="16" viewBox="0 16" viewBox="0 0 24 24"><path fill="#fff" d="M19 9h-4V3H9v6H5l7 7 7-7-7zm-8 2V5h2v6h1.17L12 13.17 9.83 11H11zm-6 7h14v2H5z"/></svg> Scarica SVG';
            }, 2000);
        });
    </script>
</body>
</html>