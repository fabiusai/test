<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report mensile post più visualizzati</title>
  <link rel="icon" href="favicon.ico" type="image/png" />
  <!-- Poste.it palette: blu e giallo -->
  <style>
    :root { --primary: #00529F; --secondary: #FFD700; --bg: #f9f9f9; --text: #333; --card-bg: #fff; }
    body { margin: 0; font-family: "Helvetica Neue", Arial, sans-serif; background: var(--bg); color: var(--text); }
    header { background: var(--primary); color: #fff; padding: 1rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
    .card { background: var(--card-bg); padding: 1.5rem; margin-bottom: 2rem; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .card h2 { margin-top: 0; color: var(--primary); }
    .controls { display: flex; align-items: center; gap: 1rem; margin-top: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.75rem; border-bottom: 1px solid #e0e0e0; text-align: left; vertical-align: middle; }
    th { background: var(--primary); color: #fff; font-weight: normal; }
    button { cursor: pointer; }
    button.copy-btn { margin-left: 0.5rem; background: transparent; color: var(--primary); border: none; font-size: 1rem; }
    button.copy-btn:focus { outline: none; }
    button.save-table, button#process-emplifi, button#process-btn { background: var(--secondary); border: none; padding: 0.6rem 1.2rem; font-weight: bold; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    a.link-btn { color: var(--primary); text-decoration: underline; font-weight: bold; }
    .note { font-size: 0.9rem; font-style: italic; margin-top: 1rem; }
  </style>
</head>
<body>
  <header><h1>Report mensile post più visualizzati</h1></header>
  <div class="container">
    <!-- Sezione Emplifi -->
    <div class="card">
      <h2>Elaborazione Excel esportato da Emplifi</h2>
      <div class="controls">
        <input type="file" id="file-input-emplifi" accept=".xlsx, .xls" />
        <button id="process-emplifi">Elabora dati</button>
      </div>
    </div>
    <!-- Sezione caricamento standard -->
    <div class="card">
      <h2>Carica il file excel già elaborato</h2>
      <div class="controls">
        <input type="file" id="file-input" accept=".xlsx, .xls" />
        <button id="process-btn">Elabora dati</button>
      </div>
    </div>
    <div id="report"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // Emplifi
    let workbookEmplifi = null;
    document.getElementById('file-input-emplifi').addEventListener('change', e => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => { workbookEmplifi = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' }); };
      reader.readAsArrayBuffer(file);
    });
    document.getElementById('process-emplifi').addEventListener('click', () => {
      if (!workbookEmplifi) { alert('Seleziona prima un file Excel Emplifi'); return; }
      const ws = workbookEmplifi.Sheets[workbookEmplifi.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws, { raw: false, defval: '' });
      const out = data.map(r => {
        // Link
        const link = r['View on platform'] || r['Content type'] || '';
        // Dettagli Emplifi
        const detail = r['Post detail URL'] || '';
        // Data parsing
        const dt = new Date(r['Date']);
        const dd = dt.getDate(); const mm = dt.getMonth(); const yy = dt.getFullYear();
        const meseDate = new Date(yy, mm, 1);
        // Canale
        let platform = r['Platform'] || '';
        if (platform.toLowerCase()==='youtube') platform = 'Youtube';
        const author = r['Author name'] || '';
        let canale = platform;
        if (author && author.trim()!=='Poste Italiane') canale = `${platform} ${author}`;
        // Campagna
        const paid = Number(r['Paid impression'])||0;
        const campagna = paid>0 ? 'Campagna' : 'Editoriale';
        // Label e Argomento
        const labels = (r['Labels']||'').split(';').map(x=>x.trim());
        const labelMap = { '#PES':'Prodotti e servizi','#TER':'Territorio','#ISR':'Investor e stakeholder relations','#FIL':'Filatelia','#EB':'Employer branding','#P160':'Poste 160','#NED':'News editoriali','#CET':'CSR e trasparenza','#DEI':'Digital e Innovazione','#ST':'Storici','#RIC':'Ricorrenze' };
        let labelOut = '';
        let argOut = '';
        labels.forEach(l => { if(l.includes('#')){ labelOut = labelMap[l]||l;} else if(l) argOut = l; });
        // Valori numerici
        const inter = r['Total interactions'] || r['Taps forward'] || '';
        const vis = r['Total impressions'] || r['Video view count'] || '';
        const reach = Number(r['Total reach'])||0;
        const reachOut = reach>0?reach:'';
        const clicks = Number(r['Post clicks'])||0;
        const clicksOut = clicks>0?clicks:'';
        const reacts = Number(r['Total reactions'])||0;
        const reactsOut = reacts>0?reacts:'';
        const shares = Number(r['Total shares'])||0;
        const sharesOut = shares>0?shares:'';
        const comments = Number(r['Total comments'])||0;
        const commentsOut = comments>0?comments:'';
        // Copy
        const copy = r['Content']||'';
        // Istituzionale
        const cont = (r['Content']||'').toLowerCase();
        const istit = (/lasco|del fante|rovere/i.test(cont))?1:'';
        return {
          'Link':link,
          'Dettagli Emplifi':detail,
          'Mese':meseDate,
          'Data':new Date(yy,mm,dd),
          'Canale':canale,
          'Interazioni':inter,
          'Visualizzazioni':vis,
          'Persone raggiunte':reachOut,
          'Click':clicksOut,
          'Like e reazioni':reactsOut,
          'Condivisioni':sharesOut,
          'Commenti':commentsOut,
          'Campagna':campagna,
          'Label':labelOut,
          'Argomento':argOut,
          'Copy':copy,
          'Istituzionale':istit
        };
      });
      const wsOut = XLSX.utils.json_to_sheet(out, { dateNF:'dd/mm/yy' });
      // impostazioni colonne data
      wsOut['!cols'] = Array(Object.keys(out[0]).length).fill({});
      const wbOut = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wbOut, wsOut, 'Report');
      XLSX.writeFile(wbOut, 'report_elaborato.xls', { bookType:'xls', bookSST:true });
    });

    // Codice esistente per renderReport e sezioni... (omesso per brevità)
  </script>
</body>
</html>
