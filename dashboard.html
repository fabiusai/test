<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Social Report Unificata + PED</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <style>
    /* --- CSS APP PRINCIPALE --- */
    @font-face {
        font-family: 'Avenir Next LT Pro';
        src: url('https://cdn.jsdelivr.net/gh/hung1001/font-awesome-pro@4cac1a6/fonts/AvenirNextLTPro-Regular.woff2') format('woff2');
        font-weight: normal;
    }

    :root {
      --primary: #00529F;
      --primary-hover: #003e7e;
      --bg: #f4f6f8;
      --text: #2c3e50;
      --text-light: #607d8b;
      --card-bg: #fff;
      --border-radius: 12px;
      --shadow: 0 4px 12px rgba(0,0,0,0.05);
      
      --chart-font: 'Nunito Sans', sans-serif;
      --header-total-grey: #3a3a3a;
      --chart-text-grey: #7b7b7a;
      --chart-title-blue: #0431AE;
      --chart-bar-blue: #bfd7fd;
      --inst-blue: #1b47b4;
      --inst-yellow: #ffcc00;
      --inst-border: #ddd;

      /* Variabili PED */
      --poste-blue: #0146bc;
      --poste-yellow: #ffdd00; 
      --light-gray: #f0f2f5;
      --border-color: #e2e8f0;
    }
    
    body { margin: 0; font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif; background: var(--bg); color: var(--text); font-size: 15px; line-height: 1.5; }
    
    /* Header & Layout */
    header { background: var(--primary); color: #fff; padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
    header h1 { margin: 0; font-size: 1.4rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .header-actions { display: flex; gap: 10px; }
    .container { max-width: 1400px; margin: 2rem auto; padding: 0 1.5rem; }
    
    /* Upload Area */
    .upload-area { background: var(--card-bg); border: 3px dashed #cbd5e0; border-radius: var(--border-radius); padding: 2rem; text-align: center; margin-bottom: 2rem; cursor: pointer; transition: all 0.2s; position: relative; }
    .upload-area:hover { border-color: var(--primary); background: #f0f7ff; }
    .upload-area input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    .upload-text { font-size: 1.1rem; color: var(--text-light); font-weight: 500; }
    .upload-icon { font-size: 2.5rem; color: var(--primary); margin-bottom: 0.5rem; display: block; }

    /* Tabs */
    .tabs-header { display: flex; gap: 10px; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; flex-wrap: wrap; }
    .tab-btn { padding: 10px 20px; background: #fff; border: 1px solid #e2e8f0; border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; color: var(--text-light); font-size: 0.95rem; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
    .tab-btn:hover { background: #f8fafc; color: var(--primary); }
    .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    .tabs-container { display: none; }
    .tab-content { display: none; animation: fadeIn 0.4s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Buttons */
    .btn-header { border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; display: none; font-size: 0.9rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: white; }
    #json-exec-btn { background-color: #27ae60; }
    #json-exec-btn:hover { background-color: #219150; }
    .action-btn { background-color: #fff; border: 1px solid #d1d5db; color: #4b5563; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .action-btn:hover { border-color: var(--primary); color: var(--primary); background: #f8fafc; }
    .action-btn.excel { color: #166534; border-color: #86efac; background: #f0fdf4; }
    .action-btn.excel:hover { background: #dcfce7; }
    .action-btn.yellow { color: #b7950b; border-color: #f1c40f; background: #fef9e7; }
    .action-btn.yellow:hover { background: #fcf3cf; }
    .action-btn.blue-fill { background-color: var(--primary); color: white; border: none; }
    .action-btn.blue-fill:hover { background-color: var(--primary-hover); }
    .action-btn.active { background-color: var(--primary); color: white; border-color: var(--primary); }

    /* Cards */
    .card { background: var(--card-bg); padding: 1.5rem; margin-bottom: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); border: 1px solid #e1e4e8; }
    .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.8rem; margin-bottom: 1.5rem; }
    .card h2 { margin: 0; color: var(--primary); font-size: 1.2rem; }
    
    /* Stats & Tables */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem; }
    .stat-card { background: #fff; border: 1px solid #e2e8f0; border-radius: var(--border-radius); padding: 1rem; position: relative; border-left: 4px solid #ddd; transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-3px); border-left-color: var(--primary); }
    .stat-label { font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; font-weight: 700; display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem; }
    .stat-label i { font-size: 1.2rem; color: var(--primary); }
    .stat-value { font-size: 1.6rem; font-weight: 700; color: var(--text); display: flex; align-items: center; justify-content: space-between; }
    
    .table-wrapper { overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 1rem; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th { background: #f8fafc; color: #4a5568; font-weight: 700; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; }
    td { padding: 12px; border-bottom: 1px solid #edf2f7; vertical-align: middle; font-size: 0.9rem; }
    tr:hover td { background-color: #f7fafc; }
    tfoot tr { background-color: #eff6ff; font-weight: bold; border-top: 2px solid #cbd5e0; }
    tfoot td { color: var(--primary); }

    /* Accordion */
    details.accordion-item { border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 1rem; background: #fff; overflow: hidden; }
    details.accordion-item summary { background: #f8fafc; padding: 1rem; font-weight: 600; cursor: pointer; outline: none; list-style: none; display: flex; justify-content: space-between; align-items: center; color: var(--text); }
    details.accordion-item summary::-webkit-details-marker { display: none; }
    details.accordion-item summary::after { content: '\f078'; font-family: "Font Awesome 6 Free"; font-weight: 900; transition: transform 0.2s; }
    details.accordion-item[open] summary::after { transform: rotate(180deg); }
    details.accordion-item[open] summary { border-bottom: 1px solid #e2e8f0; color: var(--primary); }
    .accordion-content { padding: 1.5rem; animation: fadeIn 0.3s ease; }

    /* Post Cards */
    .post-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
    .post-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s; overflow: hidden; }
    .post-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); border-color: #cbd5e0; }
    .post-header { padding: 12px 16px; background: #fdfdfd; border-bottom: 1px solid #f0f0f0; display: flex; align-items: flex-start; gap: 12px; }
    .post-channel-icon { font-size: 24px; color: var(--primary); margin-top: 2px; }
    .post-meta { flex: 1; display: flex; flex-direction: column; gap: 2px; }
    .post-label { font-weight: 700; color: #2d3748; font-size: 0.95rem; display: flex; align-items: center; justify-content: space-between; text-transform: uppercase; }
    .post-date { font-size: 0.8rem; color: #718096; display: flex; align-items: center; gap: 6px; }
    .post-body { padding: 16px; flex: 1; display: flex; flex-direction: column; gap: 10px; }
    .post-topic { display: inline-flex; align-items: center; gap: 6px; background: #eef2f7; color: var(--primary); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; }
    .post-text { font-size: 0.95rem; color: #4a5568; white-space: pre-wrap; background: #fff; line-height: 1.5; position: relative; max-height: 150px; overflow-y: auto; }
    .post-footer { padding: 12px 16px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; }
    .post-metrics { display: flex; gap: 15px; }
    .metric-item { display: flex; align-items: center; gap: 6px; font-size: 0.9rem; font-weight: 600; color: #4a5568; }
    .metric-item i { color: #a0aec0; }
    .metric-item.views i { color: #3498db; }
    .metric-item.likes i { color: #e74c3c; }
    .post-link-btn { color: #718096; transition: color 0.2s; font-size: 1.1rem; }
    .post-link-btn:hover { color: var(--primary); }
    .post-actions-right { display: flex; gap: 8px; }

    /* Charts */
    .charts-container { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
    .chart-wrapper { position: relative; background-color: #fff; border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 10px; height: auto; display: flex; flex-direction: column; border: 1px solid #e2e8f0; }
    .chart-wrapper svg { width: 100%; height: auto; font-family: var(--chart-font); }
    .chart-buttons { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 10; }
    .chart-btn { background: #f5f5f5; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.3s; position: relative; }
    .chart-btn:hover { background: #e0e0e0; }

    /* Modals */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; }
    .modal-overlay.open { display: flex; }
    .modal-content { background: #fff; padding: 25px; border-radius: 8px; width: 90%; max-width: 600px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
    .modal-header { font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .modal-row { margin-bottom: 15px; }
    .modal-row label { display: block; font-weight: 600; margin-bottom: 5px; color: #555; }
    .modal-row textarea, .modal-row input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; resize: vertical; box-sizing: border-box; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .close-modal { cursor: pointer; background: none; border: none; font-size: 1.2rem; color: #999; }
    
    /* Post Graph Modal */
    .post-graph-modal-content { max-width: 1100px; display: flex; flex-direction: column; height: 85vh; }
    .split-modal { display: flex; gap: 20px; flex: 1; overflow: hidden; }
    .split-left { flex: 1; overflow-y: auto; padding-right: 10px; }
    .split-right { flex: 2; background: #eef2f5; display: flex; align-items: center; justify-content: center; border-radius: 8px; border: 1px solid #dee2e6; overflow: hidden; padding: 10px; }
    .split-right svg { max-width: 100%; height: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: white; }

    /* Filters */
    .filters-card { background: #fff; border: 2px solid var(--primary); border-radius: var(--border-radius); margin-bottom: 2rem; overflow: hidden; box-shadow: var(--shadow); }
    .filters-header { background: var(--primary); color: white; padding: 12px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
    .filters-body { padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; background: #fcfcfc; align-items: flex-start; }
    .filter-group { display: flex; flex-direction: column; gap: 8px; min-width: 0; }
    .filter-group label { font-weight: 700; color: var(--primary); font-size: 0.85rem; text-transform: uppercase; }
    .filter-group select, .filter-group input { padding: 8px; border: 1px solid #cbd5e0; border-radius: 6px; font-family: inherit; }
    .filter-actions { grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 10px; padding-top: 10px; border-top: 1px solid #eee; }
    .multiselect-container { border: 1px solid #cbd5e0; border-radius: 6px; background: white; max-height: 120px; overflow-y: auto; padding: 5px; }
    .multiselect-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; padding: 2px 0; cursor: pointer; }

    /* PED Specifics */
    .btn-primary-ped { background-color: var(--poste-blue); color: white; transition: background-color 0.3s ease, transform 0.1s ease; }
    .btn-primary-ped:hover { background-color: #013aa1; }
    .btn-primary-ped:active { transform: scale(0.98); }
    .btn-secondary-ped { background-color: var(--poste-yellow); color: var(--poste-blue); font-weight: 700; transition: background-color 0.3s ease, transform 0.1s ease; }
    .btn-secondary-ped:hover { background-color: #eac800; }
    .btn-secondary-ped:active { transform: scale(0.98); }
    .btn-outline-ped { background-color: transparent; border: 2px solid var(--poste-blue); color: var(--poste-blue); font-weight: 600; transition: all 0.3s ease; }
    .btn-outline-ped:hover { background-color: #e6f0ff; }
    .card-ped { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: all 0.3s ease-in-out; position: relative; border: 2px solid transparent; margin-bottom: 2rem; }
    .card-ped:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
    .card-ped.is-completed { background-color: #f0fdf4; border-color: #22c55e; opacity: 0.85; }
    .card-ped.is-completed::after { content: "✓ INSERITO"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-10deg); font-size: 3rem; font-weight: 900; color: #22c55e; opacity: 0.2; pointer-events: none; white-space: nowrap; }
    .modal-ped { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .modal-ped.active { opacity: 1; pointer-events: auto; }
    .modal-content-ped { background: white; width: 90%; max-width: 800px; max-height: 90vh; border-radius: 1rem; padding: 2rem; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    .cursor-move { cursor: grab; }
    .cursor-move:active { cursor: grabbing; }
    .sortable-ghost { opacity: 0.4; background-color: #e2e8f0; border: 2px dashed #cbd5e1; }
    .svg-container-ped { width: 100%; overflow-x: auto; border-radius: 0.75rem; background-color: #f8f9fa; margin-bottom: 1rem; }
    .svg-container-ped svg { display: block; width: 100%; height: auto; }
    
    /* Charts Inst */
    .inst-chart-container-wrapper { margin-top: 20px; margin-bottom: 30px; background-color: #fff; border: 1px solid #e2e8f0; border-radius: var(--border-radius); padding: 15px; box-shadow: var(--shadow); }
    .inst-chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
    .inst-chart-title { font-weight: 700; color: var(--inst-blue); font-size: 1.1rem; }
    .inst-chart-controls { display: flex; gap: 10px; }
    .chart-container-inst { border: 1px solid var(--inst-border); border-radius: var(--border-radius); overflow: hidden; background-color: #fcfcfc; display: flex; justify-content: center; }
    .chart-container-inst svg { max-width: 100%; height: auto; display: block; background-color: white; }
    
    /* Label Analysis */
    .tables-row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 30px; }
    .analysis-column { flex: 1; min-width: 400px; display: flex; flex-direction: column; gap: 20px; }
    .table-col { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: var(--shadow); }
    .label-chart-wrapper { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: var(--shadow); position: relative; }
    .label-chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .label-chart-title { font-size: 1.2rem; color: var(--primary); font-weight: 700; font-family: 'Avenir Next LT Pro', sans-serif; }
    .chart-controls-row { padding: 10px 0; margin-bottom: 10px; display: flex; flex-wrap: wrap; align-items: center; gap: 20px; background: #fcfcfc; border-bottom: 1px solid #eee; }
    .control-group { display: flex; flex-direction: column; gap: 5px; }
    .control-group label { font-weight: 600; color: var(--primary); font-size: 0.9rem; display: flex; justify-content: space-between; width: 200px; }
    .range-slider { width: 200px; cursor: pointer; }
    .slider-val { color: #555; font-weight: normal; }
    
    /* Toast */
    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
    .toast { padding: 12px 24px; color: white; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 500; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s; }
    .toast.success { background: #27ae60; }
    .toast.error { background: #e74c3c; }
    .toast.warning { background: #f39c12; }

/* --- INTEGRAZIONE STILI PED NEW --- */
    /* Toggle Switch personalizzato per colori */
    .toggle-checkbox:checked { right: 0; border-color: #68D391; }
    .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
    .toggle-label { width: 40px; height: 24px; background-color: #ccc; border-radius: 9999px; position: relative; cursor: pointer; transition: background-color 0.2s; }
    .toggle-checkbox { position: absolute; right: 16px; top: 2px; width: 20px; height: 20px; border-radius: 50%; background: white; border: 2px solid #ccc; appearance: none; cursor: pointer; transition: all 0.2s; }
    
    /* Stili Drag & Drop nella Modale */
    .modal-row-ped { display: flex; align-items: center; gap: 10px; padding: 10px; background: #fff; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px; transition: border-color 0.2s; }
    .modal-row-ped:hover { border-color: var(--primary); }
    .drag-handle-ped { cursor: grab; color: #9ca3af; padding: 4px; }
    .drag-handle-ped:active { cursor: grabbing; }
    .ped-input-edit { width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-weight: 600; color: #374151; }
    
    /* Checkbox PPT personalizzata */
    .ppt-checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: #16a34a; }
    
    /* Layout Switcher */
    .layout-switcher-container { position: relative; display: flex; background: #f3f4f6; border-radius: 9999px; padding: 4px; width: fit-content; margin: 0 auto; }
    .layout-switcher-container input { display: none; }
    .layout-switcher-label { position: relative; z-index: 10; padding: 8px 20px; font-weight: 600; font-size: 0.9rem; cursor: pointer; color: #6b7280; transition: color 0.3s; }
    .layout-switcher-container input:checked + label { color: var(--primary); }
    .switcher-glider { position: absolute; top: 4px; bottom: 4px; width: 50%; background: white; border-radius: 9999px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.3s ease; left: 0; }
    #layout-con-loghi:checked ~ .switcher-glider { transform: translateX(4px); width: calc(50% - 8px); }
    #layout-senza-loghi:checked ~ .switcher-glider { transform: translateX(100%); width: calc(50% - 4px); }


  </style>
</head>
<body>

  <div class="modal-overlay" id="editModal">
      <div class="modal-content">
          <div class="modal-header"><span>Modifica Testi Grafico</span><button class="close-modal" onclick="closeEditModal()"><i class="fas fa-times"></i></button></div>
          <div id="modal-body-inputs"></div>
          <div class="modal-footer"><button class="action-btn" onclick="closeEditModal()">Annulla</button><button class="action-btn active" onclick="saveModalChanges()">Applica</button></div>
      </div>
  </div>

  <div class="modal-overlay" id="postGraphModal">
      <div class="modal-content post-graph-modal-content">
          <div class="modal-header"><span><i class="fas fa-palette"></i> Generatore Grafico Post</span><button class="close-modal" onclick="closePostGraphModal()"><i class="fas fa-times"></i></button></div>
          <div class="split-modal">
            <div class="split-left">
                <div class="modal-row"><label>Argomento (Editabile)</label><input type="text" id="pg-argomento" oninput="updatePostSvg()"></div>
                <div class="modal-row"><label>Copy (Editabile)</label><textarea id="pg-copy" rows="5" oninput="updatePostSvg()"></textarea></div>
                <div class="modal-row"><label>Visualizzazioni</label><input type="text" id="pg-views" disabled style="background:#f0f0f0"></div>
                <div class="modal-row"><label>Interazioni</label><input type="text" id="pg-inter" disabled style="background:#f0f0f0"></div>
                <div class="modal-row"><label>Info</label><input type="text" id="pg-info" disabled style="background:#f0f0f0; font-size:0.85em;"></div>
            </div>
            <div class="split-right" id="pg-preview-container"></div>
          </div>
          <div class="modal-footer"><button class="action-btn yellow" onclick="downloadPostSvg()"><i class="fas fa-download"></i> Scarica SVG</button><button class="action-btn active" onclick="copyPostSvg()"><i class="far fa-copy"></i> Copia HQ</button></div>
      </div>
  </div>

  <div id="edit-modal-ped" class="modal-ped">
      <div class="modal-content-ped">
          <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold text-gray-800">Modifica e Ordina: <span id="modal-label-title-ped" class="text-blue-700"></span></h3>
              <button onclick="closeModalPed()" class="text-gray-500 hover:text-red-500">
                  <i class="fas fa-times fa-lg"></i>
              </button>
          </div>
          <div class="bg-blue-50 p-3 rounded mb-3 text-sm text-gray-600 flex items-center gap-2">
              <i class="fas fa-info-circle text-blue-600"></i>
              <span>Trascina l'icona a sinistra per riordinare le righe. Modifica il testo per cambiare l'argomento nel grafico.</span>
          </div>
          <div id="modal-body-ped" class="flex-1 overflow-y-auto pr-2 space-y-2"></div>
          <div class="mt-6 pt-4 border-t flex justify-end gap-3">
              <button onclick="closeModalPed()" class="action-btn">Annulla</button>
              <button id="save-edits-btn-ped" class="action-btn active">Salva Modifiche</button>
          </div>
      </div>
  </div>

  <header>
    <h1>
      <a href="index.html" style="color:white; margin-right:15px; text-decoration:none;" title="Torna alla Home"><i class="fas fa-home"></i></a>
      <i class="fas fa-chart-line"></i> Dashboard Report Social Unificata <span style="font-size:0.6em; opacity:0.8; margin-left:10px; font-weight:300;">v3.0 (Con PED)</span>
    </h1>
    <div class="header-actions">
      <button onclick="resetDashboard()" class="btn-header" style="background-color:#c0392b; display:inline-flex; margin-right:10px;" title="Pulisci dati e ricomincia"><i class="fas fa-trash"></i> Nuova Analisi</button>
      <button onclick="pasteFromEditor()" class="btn-header" style="background-color:#27ae60; display:inline-flex; margin-right:10px;" title="Importa i dati copiati dall'Editor"><i class="fas fa-paste"></i> Incolla da Editor</button>
      <button onclick="sendToEditor()" class="btn-header" style="background-color:#f39c12; display:inline-flex; margin-right:10px;"><i class="fas fa-reply"></i> Modifica in Editor</button>
      <button id="json-exec-btn" class="btn-header"><i class="fas fa-file-contract"></i> JSON Executive</button>
    </div>
  </header>
  
  <div id="toast-container"></div>

  <div class="container">
    <div class="upload-area" id="upload-box">
      <input type="file" id="file-input" accept=".xlsx, .xls" />
      <span class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></span>
      <div class="upload-text" id="upload-label">Trascina il file Excel qui o clicca per caricare</div>
    </div>

    <div id="global-filters-area" style="display:none;">
        <div class="filters-card">
            <div class="filters-header" onclick="document.getElementById('filters-content').style.display = document.getElementById('filters-content').style.display === 'none' ? 'grid' : 'none'"><span><i class="fas fa-filter"></i> FILTRI AVANZATI</span><i class="fas fa-chevron-down"></i></div>
            <div class="filters-body" id="filters-content" style="display:none;">
                <div class="filter-group"><label>Date Custom</label><div style="display:flex; flex-direction:column; gap:5px;"><input type="date" id="filter-date-start" onchange="applyGlobalFilters()"><input type="date" id="filter-date-end" onchange="applyGlobalFilters()"></div></div>
                <div class="filter-group"><label>Per Mesi</label><div id="filter-months-list" class="multiselect-container" style="max-height: 100px;"></div></div>
                <div class="filter-group"><label>Canali</label><div id="filter-channels-list" class="multiselect-container" style="max-height: 100px;"></div></div>
                <div class="filter-group"><label>Cerca Argomenti</label><input type="text" id="filter-topic-search" placeholder="Filtra..." oninput="updateTopicList()" style="margin-bottom:5px;"><div id="filter-topics-list" class="multiselect-container" style="max-height: 100px;"></div></div>
                <div class="filter-group"><label>Label</label><div id="filter-labels-list" class="multiselect-container" style="max-height: 100px;"></div></div>
                <div class="filter-actions"><button class="action-btn" onclick="resetGlobalFilters()"><i class="fas fa-undo"></i> Reset</button><button class="action-btn blue-fill" onclick="applyGlobalFilters()"><i class="fas fa-sync"></i> Aggiorna</button></div>
            </div>
        </div>
    </div>

    <div id="main-content" class="tabs-container">
      <div class="tabs-header">
        <button class="tab-btn active" onclick="switchTab('tab-overview')"><i class="fas fa-home"></i> Panoramica</button>
        <button class="tab-btn" onclick="switchTab('tab-instit')"><i class="fas fa-building"></i> Istituzionale</button>
        <button class="tab-btn" onclick="switchTab('tab-labels')"><i class="fas fa-tag"></i> Analisi per Label</button>
        <button class="tab-btn" onclick="switchTab('tab-topics')"><i class="fas fa-tags"></i> Top Argomenti</button>
        <button class="tab-btn" onclick="switchTab('tab-channels')"><i class="fas fa-share-alt"></i> Canali</button>
        <button class="tab-btn" onclick="switchTab('tab-ped')"><i class="fas fa-clipboard-list"></i> Piano Editoriale</button>
      </div>

      <div id="tab-overview" class="tab-content active"></div>
      <div id="tab-instit" class="tab-content"></div>
      <div id="tab-labels" class="tab-content"></div>
      <div id="tab-topics" class="tab-content"></div>
      <div id="tab-channels" class="tab-content"></div>
      
     <div id="tab-ped" class="tab-content">
          <div class="card p-6 md:p-8 max-w-5xl mx-auto">
              <div class="text-center mb-6">
                  <h2 class="text-2xl font-bold" style="color:var(--primary);"><i class="fas fa-pencil-ruler"></i> Generatore Report PED</h2>
                  <p class="mt-2 text-gray-500">Configura la grafica. I dati sono filtrati automaticamente dalla dashboard.</p>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                  <div>
                      <label class="block text-sm font-bold text-gray-700 mb-1">Dimensione Testo (px)</label>
                      <input type="number" id="ped-font-size-input" value="18" min="10" max="40" class="w-full p-2 border rounded border-gray-300 focus:border-blue-500">
                  </div>
                  <div>
                      <label class="block text-sm font-bold text-gray-700 mb-1">Interlinea (px)</label>
                      <input type="number" id="ped-line-height-input" value="23" min="20" max="50" class="w-full p-2 border rounded border-gray-300 focus:border-blue-500">
                  </div>
              </div>

              <div class="border-t pt-6 flex flex-col items-center gap-4">
                  <div class="layout-switcher-container">
                      <input type="radio" name="layout-style" id="layout-con-loghi" value="con-loghi" onchange="togglePedColors(true)">
                      <label for="layout-con-loghi" class="layout-switcher-label">Con Loghi</label>
                      
                      <input type="radio" name="layout-style" id="layout-senza-loghi" value="senza-loghi" checked onchange="togglePedColors(false)">
                      <label for="layout-senza-loghi" class="layout-switcher-label">Senza Loghi</label>
                      
                      <div class="switcher-glider"></div>
                  </div>

                  <div id="ped-color-toggle-container" class="flex items-center gap-3 transition-opacity duration-300" style="opacity:0; pointer-events:none;">
                      <span class="text-sm font-medium text-gray-500">Outline Blu</span>
                      <div class="relative inline-block w-12 h-6">
                          <input type="checkbox" id="ped-logo-color-toggle" class="toggle-checkbox">
                          <label for="ped-logo-color-toggle" class="toggle-label"></label>
                      </div>
                      <span class="text-sm font-bold text-gray-700">Colorati</span>
                  </div>
              </div>

              <div class="mt-8 flex justify-center gap-4">
                  <button onclick="refreshPedView()" class="action-btn blue-fill py-3 px-8 text-lg shadow-lg">
                      <i class="fas fa-sync"></i> Genera / Aggiorna Grafici
                  </button>
                  <button onclick="downloadAllPedZip()" class="action-btn yellow py-3 px-8 text-lg shadow-lg">
                      <i class="fas fa-file-archive"></i> Scarica ZIP Tutto
                  </button>
              </div>
          </div>

          <div id="ped-results-container" class="mt-8 container mx-auto space-y-8"></div>
      </div>
               
      </div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('file-input');
    const uploadLabel = document.getElementById('upload-label');
    const jsonExecBtn = document.getElementById('json-exec-btn');
    const mainContent = document.getElementById('main-content');
    const uploadBox = document.getElementById('upload-box'); // Riferimento al box upload
    let workbookData = null;
    let rawData = [];

    // --- NUOVO: CONTROLLO DATI IN ARRIVO DALL'EDITOR ---
    window.addEventListener('DOMContentLoaded', () => {
        const source = localStorage.getItem('social_dashboard_source');
        const bridgeData = localStorage.getItem('social_dashboard_data');

        if (source === 'bridge' && bridgeData) {
            try {
                // Pulisci subito il flag per evitare ricaricamenti futuri indesiderati
                localStorage.removeItem('social_dashboard_source');
                
                showToast("Dati ricevuti dall'Editor! Elaborazione in corso...", "success");
                
                // Simula il ritardo di lettura file
                setTimeout(() => {
                    rawData = JSON.parse(bridgeData);
                    
                    // Definizione colonne (Dati da Editor sono già puliti con chiavi standard)
                    cols = {
                        data: 'Data', canale: 'Canale', vis: 'Visualizzazioni', inter: 'Interazioni',
                        label: 'Label', campagna: 'Campagna', arg: 'Argomento', copy: 'Copy',
                        link: 'Link', like: 'Like e reazioni', cond: 'Condivisioni',
                        istituzionale: 'Istituzionale'
                    };

                    filteredData = rawData.filter(r => String(r[cols.campagna]).trim().toLowerCase() === 'editoriale');
                    displayData = [...filteredData];

                    // Nascondi Uploader e Mostra contenuto
                    if(uploadBox) uploadBox.style.display = 'none';
                    mainContent.style.display = 'block'; 
                    jsonExecBtn.style.display = 'inline-block';
                    
                    populateFilterUI();
                    renderAll(displayData);
                    
                    showToast("Analisi completata con successo.", "success");
                }, 500);

            } catch (e) {
                console.error("Errore bridge:", e);
                showToast("Errore nel caricamento dati dall'editor.", "error");
            }
        }
    });
    // ---------------------------------------------------
    let filteredData = [];
    let displayData = [];
    let cols = {};
    let activeFilters = { topics: [], channels: [], labels: [], months: [], dateStart: null, dateEnd: null };
    let currentTop5Data = []; 
    let currentPostData = {};

    // PED VARS
    let globalProcessedDataPed = {};
    let currentEditLabelPed = null;
    let sortableInstancePed = null;
    const CHANNELS_ORDER_PED = ["Facebook", "Linkedin", "Instagram", "X", "Youtube", "Whatsapp"];
    const ICON_PATHS_PED = {
        flag: 'M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z',
        facebook: 'M22.675 0h-21.35c-.732 0-1.325.593-1.325 1.325v21.351c0 .731.593 1.324 1.325 1.324h11.495v-9.294h-3.128v-3.622h3.128v-2.671c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.463.099 2.795.142v3.24h-1.918c-1.504 0-1.795.715-1.795 1.763v2.313h3.587l-.467 3.622h-3.12v9.293h6.116c.73 0 1.323-.593 1.323-1.325v-21.35c0-.732-.593-1.325-1.325-1.325z',
        linkedin: 'M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z',
        instagram: 'M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.85s-.011 3.584-.069 4.85c-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07s-3.584-.012-4.85-.07c-3.252-.148-4.771-1.691-4.919-4.919-.058-1.265-.069-1.645-.069-4.85s.011-3.584.069-4.85c.149-3.225 1.664-4.771 4.919-4.919 1.266-.058 1.644-.07 4.85-.07zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948s.014 3.667.072 4.947c.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072s3.667-.014 4.947-.072c4.358-.2 6.78-2.618 6.98-6.98.059-1.281.073-1.689.073-4.948s-.014-3.667-.072-4.947c-.2-4.358-2.618-6.78-6.98-6.98-1.281-.058-1.689-.072-4.948-.072zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44 1.441-.645 1.441-1.44-.645-1.44-1.441-1.44z',
        x: 'M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.931 6.064-6.931zM17.61 20.644h2.039L6.486 3.24H4.298l13.312 17.404z',
        youtube: 'M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z',
        whatsapp: 'M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2 22l5.25-1.38c1.45.79 3.08 1.21 4.79 1.21 5.46 0 9.91-4.45 9.91-9.91S17.5 2 12.04 2zM12.05 20.15c-1.49 0-2.93-.4-4.19-1.15l-.3-.18-3.12.82.83-3.04-.2-.31c-.82-1.31-1.26-2.83-1.26-4.38 0-4.54 3.69-8.23 8.24-8.23 2.22 0 4.31.87 5.82 2.38s2.38 3.6 2.38 5.82c-.01 4.54-3.69 8.23-8.24 8.23zm4.52-6.13c-.25-.12-1.47-.72-1.7-.81-.23-.08-.39-.12-.56.12-.17.25-.64.81-.79.97-.15.17-.29.19-.54.06-.25-.12-1.06-.39-2.02-1.24-.75-.66-1.25-1.48-1.4-1.73-.14-.25-.02-.38.11-.51.11-.11.25-.29.37-.43.13-.14.17-.25.25-.41.08-.17.04-.31-.02-.43s-.56-1.34-.76-1.84c-.2-.48-.41-.42-.56-.42h-.48c-.17 0-.43.06-.66.31-.22.25-.86.85-.86 2.07 0 1.22.88 2.4 1 2.56.12.17 1.74 2.65 4.22 3.72.59.25 1.05.41 1.41.52.6.19 1.14.16 1.56.1.48-.07 1.47-.6 1.67-1.18.21-.58.21-1.07.15-1.18-.07-.1-.17-.16-.42-.28z',
    };
    const BRAND_COLORS_PED = { facebook: '#1877F2', linkedin: '#0A66C2', instagram: '#E4405F', x: '#000000', youtube: '#FF0000', whatsapp: '#25D366' };

    // --- SETUP PED UI ---
    document.querySelectorAll('input[name="layout-style"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const container = document.getElementById('ped-color-toggle-container');
            if(e.target.value === 'con-loghi') {
                container.style.opacity = '1'; container.style.pointerEvents = 'auto';
            } else {
                container.style.opacity = '0'; container.style.pointerEvents = 'none';
            }
        });
    });

    const findCol = (regex, firstRow) => Object.keys(firstRow || {}).find(h => new RegExp(regex, 'i').test(h));

    fileInput.addEventListener('change', e => {
      const file = e.target.files[0]; if (!file) return;
      uploadLabel.innerHTML = `⏳ Elaborazione di <strong>${file.name}</strong>...`;
      const reader = new FileReader();
      
      reader.onload = evt => {
        try {
            workbookData = XLSX.read(new Uint8Array(evt.target.result), { type: 'array', cellDates: true });
            rawData = XLSX.utils.sheet_to_json(workbookData.Sheets[workbookData.SheetNames[0]], { defval: '' });
            
            // LOGICA APP 1
            if (rawData.length > 0) {
                cols = {
                    data: findCol('dat', rawData[0]),
                    canale: findCol('canal', rawData[0]),
                    vis: findCol('visualizz', rawData[0]),
                    inter: findCol('interaz', rawData[0]),
                    label: findCol('label', rawData[0]),
                    campagna: findCol('campagn', rawData[0]),
                    arg: findCol('argoment', rawData[0]) || 'Argomento',
                    copy: findCol('copy', rawData[0]) || 'Copy',
                    link: findCol('link', rawData[0]) || 'Link',
                    like: findCol('like', rawData[0]) || 'Like e reazioni',
                    cond: findCol('condivisioni', rawData[0]) || 'Condivisioni',
                    istituzionale: findCol('istituzionale', rawData[0])
                };
            }
            if (!cols.campagna) throw new Error("Colonna Campagna non trovata");
            filteredData = rawData.filter(r => String(r[cols.campagna]).trim().toLowerCase() === 'editoriale');
            displayData = [...filteredData];
            populateFilterUI();
            renderAll(displayData);

            mainContent.style.display = 'block'; jsonExecBtn.style.display = 'inline-block';
            uploadLabel.innerHTML = `✅ <strong>${file.name}</strong> caricato con successo.`;
            showToast('Dati elaborati correttamente', 'success');

        } catch (err) {
            console.error(err); uploadLabel.innerHTML = `❌ Errore nel file: ${err.message}`; showToast('Errore lettura file Excel', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    });

    // --- FILTERS & UTILS ---
    function populateFilterUI() {
        const topics = [...new Set(filteredData.map(r => r[cols.arg] || 'Generale'))].sort();
        const channels = [...new Set(filteredData.map(r => String(r[cols.canale]).toLowerCase()))].sort();
        const labels = [...new Set(filteredData.map(r => r[cols.label] || 'Nessuna'))].sort();
        const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
        const monthsMap = {};
        filteredData.forEach(r => {
            const d = new Date(formatDateForCompare(r[cols.data]));
            if(!isNaN(d)) {
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = `${monthNames[d.getMonth()]} ${d.getFullYear()}`;
                monthsMap[key] = label;
            }
        });
        renderCheckboxList('filter-topics-list', topics, 'topics');
        renderCheckboxList('filter-channels-list', channels, 'channels');
        renderCheckboxList('filter-labels-list', labels, 'labels');
        const sortedMonthsKeys = Object.keys(monthsMap).sort().reverse();
        const monthsList = sortedMonthsKeys.map(k => ({ val: k, label: monthsMap[k] }));
        const mCon = document.getElementById('filter-months-list');
        if(mCon) mCon.innerHTML = monthsList.map(m => `<div class="multiselect-item"><input type="checkbox" value="${m.val}" data-type="months" onchange="updateFilterState(this)"><span>${m.label}</span></div>`).join('');
        document.getElementById('global-filters-area').style.display = 'block';
    }
    function renderCheckboxList(containerId, items, type) { document.getElementById(containerId).innerHTML = items.map(item => `<div class="multiselect-item"><input type="checkbox" value="${item}" data-type="${type}" onchange="updateFilterState(this)"><span>${item}</span></div>`).join(''); }
    window.updateTopicList = function() { const search = document.getElementById('filter-topic-search').value.toLowerCase(); document.querySelectorAll('#filter-topics-list .multiselect-item').forEach(it => { it.style.display = it.innerText.toLowerCase().includes(search) ? 'flex' : 'none'; }); }
    window.updateFilterState = function(el) { if(el.checked) { if(!activeFilters[el.getAttribute('data-type')].includes(el.value)) activeFilters[el.getAttribute('data-type')].push(el.value); } else { activeFilters[el.getAttribute('data-type')] = activeFilters[el.getAttribute('data-type')].filter(v => v !== el.value); } applyGlobalFilters(); }
    
    // --- FUNCTION CHIAVE: Applica filtri a TUTTO (incluso PED) ---
    window.applyGlobalFilters = function() {
        const start = document.getElementById('filter-date-start').value; const end = document.getElementById('filter-date-end').value;
        displayData = filteredData.filter(r => {
            const rDateStr = formatDateForCompare(r[cols.data]);
            if((start && rDateStr < start) || (end && rDateStr > end)) return false;
            if(activeFilters.months.length > 0 && !activeFilters.months.includes(rDateStr.substring(0, 7))) return false;
            if(activeFilters.topics.length > 0 && !activeFilters.topics.includes(r[cols.arg] || 'Generale')) return false;
            if(activeFilters.channels.length > 0 && !activeFilters.channels.includes(String(r[cols.canale]).toLowerCase())) return false;
            if(activeFilters.labels.length > 0 && !activeFilters.labels.includes(r[cols.label] || 'Nessuna')) return false;
            return true;
        });
        renderAll(displayData);
    }
    
    window.resetGlobalFilters = function() { activeFilters = { topics: [], channels: [], labels: [], months: [], dateStart: null, dateEnd: null }; document.querySelectorAll('.multiselect-container input').forEach(i => i.checked = false); document.getElementById('filter-date-start').value = ''; document.getElementById('filter-date-end').value = ''; displayData = [...filteredData]; renderAll(displayData); }
    function formatDateForCompare(t) { if(!t) return ''; let dateObj; if (t instanceof Date) dateObj = t; else if (typeof t === 'number') dateObj = new Date((t - 25569) * 86400 * 1000); else { if(/^\d{2}\/\d{2}\/\d{2,4}$/.test(t)) { const parts = t.split('/'); const y = parts[2].length === 2 ? '20' + parts[2] : parts[2]; return `${y}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`; } if(/^\d{4}-\d{2}-\d{2}$/.test(t)) return t; dateObj = new Date(t); } if(!isNaN(dateObj.getTime())) { const y = dateObj.getFullYear(); const m = String(dateObj.getMonth() + 1).padStart(2, '0'); const d = String(dateObj.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`; } return ''; }
    function showToast(msg, type) { const c = document.getElementById('toast-container'); const icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : (type === 'warning' ? '<i class="fas fa-exclamation-triangle"></i>' : '<i class="fas fa-exclamation-circle"></i>'); const t = document.createElement('div'); t.className = `toast ${type}`; t.innerHTML = `${icon} ${msg}`; c.appendChild(t); setTimeout(() => t.remove(), 4000); }
    window.switchTab = function(tabId) { document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); document.getElementById(tabId).classList.add('active'); const buttons = document.querySelectorAll('.tab-btn'); const map = {'tab-overview':0, 'tab-instit':1, 'tab-labels':2, 'tab-topics':3, 'tab-channels':4, 'tab-ped':5}; if(map[tabId] !== undefined) buttons[map[tabId]].classList.add('active'); }
    function formatNumber(n) { n=Number(n)||0; if(n<1000)return n.toString(); if(n<1000000)return `${Math.round(n/1000)}K`; return `${(n/1000000).toFixed(2).replace('.',',')}M`; }
    function formatNumberFull(num) { if (typeof num !== 'number') { num = parseFloat(num); if (isNaN(num)) return ''; } if (num >= 1000000) return (num / 1000000).toFixed(1).replace('.', ',') + 'M'; else if (num >= 1000) return (num / 1000).toFixed(1).replace('.', ',') + 'K'; return num.toString().replace('.', ','); }
    function formatNumberItalian(num) { return (+num || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
    function formatDate(t) { if(!t) return ''; let d,m,y; if(/^\d{4}-\d{2}-\d{2}$/.test(t))[y,m,d]=t.split('-'); else if(/^\d{2}\/\d{2}\/\d{4}$/.test(t))[d,m,y]=t.split('/'); else{const dt=new Date(t);if(!isNaN(dt)){d=dt.getDate();m=dt.getMonth()+1;y=dt.getFullYear();}else return t;} return `${d.toString().padStart(2,'0')}/${m.toString().padStart(2,'0')}/${y.toString().slice(-2)}`; }
    function createCopyBtn(textToCopy) { const b = document.createElement('button'); b.className = 'copy-btn'; b.innerHTML = '<i class="far fa-copy"></i>'; b.onclick = (e) => { e.stopPropagation(); navigator.clipboard.writeText(String(textToCopy)).then(() => { b.innerHTML = '<i class="fas fa-check"></i>'; b.style.color = '#27ae60'; setTimeout(() => { b.innerHTML = '<i class="far fa-copy"></i>'; b.style.color = ''; }, 1500); }); }; return b; }
    function getChannelIcon(name) { const n = String(name).toLowerCase(); if(n.includes('facebook')) return '<i class="fab fa-facebook"></i>'; if(n.includes('instagram')) return '<i class="fab fa-instagram"></i>'; if(n.includes('linkedin')) return '<i class="fab fa-linkedin"></i>'; if(n.includes('twitter') || n.includes('x')) return '<i class="fa-brands fa-x-twitter"></i>'; if(n.includes('youtube')) return '<i class="fab fa-youtube"></i>'; if(n.includes('whatsapp')) return '<i class="fab fa-whatsapp"></i>'; return '<i class="fas fa-share-alt"></i>'; }
    function formatKValue(num) { num = +num || 0; if (num >= 1000000) return parseFloat((num/1000000).toFixed(2)).toString().replace('.', ',') + 'M'; if (num >= 1000) return Math.round(num/1000).toString() + 'K'; return num.toString(); }
    function createTableCopyBtn(tableEl) { const btn = document.createElement('button'); btn.className = 'action-btn'; btn.innerHTML = '<i class="far fa-copy"></i> Copia Tabella'; btn.onclick = () => { let txt = ""; const headers = Array.from(tableEl.querySelectorAll("thead th")).map(th => th.textContent.trim()); txt += headers.join("\t") + "\n"; const rows = tableEl.querySelectorAll("tbody tr"); rows.forEach(tr => { const cells = Array.from(tr.querySelectorAll("td")).map(td => td.innerText.replace(/content_copy|Copiato!/g, '').trim()); txt += cells.join("\t") + "\n"; }); navigator.clipboard.writeText(txt).then(() => showToast("Tabella copiata!", "success")); }; return btn; }
    function formatNumberInstChart(num) { const numericValue = Number(num); if (isNaN(numericValue)) return num; if (numericValue >= 1000000) return (numericValue / 1000000).toFixed(1).replace('.', ',') + 'M'; if (numericValue >= 1000) return Math.round(numericValue / 1000).toString() + 'K'; return numericValue.toString(); }
    function downloadSvgDirect(svgElement, filename) { if (!svgElement) return; const serializer = new XMLSerializer(); let source = serializer.serializeToString(svgElement); if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){ source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"'); } source = source.replace('>', '><style>@font-face { font-family: "Avenir Next LT Pro"; src: url("https://cdn.jsdelivr.net/gh/hung1001/font-awesome-pro@4cac1a6/fonts/AvenirNextLTPro-Regular.woff2") format("woff2"); } @font-face { font-family: "Arial"; src: local("Arial"); }</style>'); const blob = new Blob([source], {type: 'image/svg+xml;charset=utf-8'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
    function copySvgHighRes(svgElement) { if (!svgElement) return; showToast("Elaborazione immagine...", "warning"); const serializer = new XMLSerializer(); let source = serializer.serializeToString(svgElement); if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){ source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"'); } const safeFontStyle = `<style> text, tspan { font-family: "Segoe UI", "Arial", sans-serif !important; } </style>`; if (source.indexOf('>') > -1) { source = source.substring(0, source.indexOf('>') + 1) + safeFontStyle + source.substring(source.indexOf('>') + 1); } const scaleFactor = 4; const viewBox = svgElement.getAttribute('viewBox').split(' '); const w = parseFloat(viewBox[2]); const h = parseFloat(viewBox[3]); const canvas = document.createElement('canvas'); canvas.width = w * scaleFactor; canvas.height = h * scaleFactor; const ctx = canvas.getContext('2d'); const img = new Image(); const svgBlob = new Blob([source], {type: 'image/svg+xml;charset=utf-8'}); const url = URL.createObjectURL(svgBlob); img.onload = function() { ctx.clearRect(0,0,canvas.width, canvas.height); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); canvas.toBlob(function(blob) { if (navigator.clipboard && navigator.clipboard.write) { navigator.clipboard.write([new ClipboardItem({'image/png': blob})]) .then(() => { showToast('Copiato con successo! Incolla su PowerPoint.', 'success'); }) .catch((err) => { console.error("Copia fallita:", err); downloadBlob(blob, "grafico-copia-fallback.png"); showToast('Copia bloccata dal browser -> Immagine scaricata!', 'warning'); }); } else { downloadBlob(blob, "grafico-copia-fallback.png"); showToast('Copia non supportata -> Immagine scaricata!', 'warning'); } URL.revokeObjectURL(url); }, 'image/png'); }; img.onerror = function() { showToast("Errore rendering immagine", "error"); URL.revokeObjectURL(url); }; img.src = url; }
    function downloadBlob(blob, filename) { const a = document.createElement('a'); const url = URL.createObjectURL(blob); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
    function formatSmartKM(num) { num = Number(num) || 0; if (num < 1000) return formatNumberItalian(num); let val, suffix; if (num >= 1000000) { val = num / 1000000; suffix = 'M'; } else { val = num / 1000; suffix = 'K'; } let str = val.toFixed(2).replace('.', ','); str = str.replace(/,00$/, '').replace(/,(\d)0$/, ',$1'); return str + suffix; }
    function formatCustomDecimals(num, decimals) { num = Number(num) || 0; decimals = parseInt(decimals); if (isNaN(decimals)) decimals = 2; if (num < 1000) return formatNumberItalian(num); let val, suffix; if (num >= 1000000) { val = num / 1000000; suffix = 'M'; } else { val = num / 1000; suffix = 'K'; } let formatted = parseFloat(val.toFixed(decimals)).toString().replace('.', ','); return formatted + suffix; }
    function downloadTransparentSvg(svgElement, filename) { if (!svgElement) return; const serializer = new XMLSerializer(); let source = serializer.serializeToString(svgElement); if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){ source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"'); } source = source.replace('>', '><style>@font-face { font-family: "Avenir Next LT Pro"; src: url("https://cdn.jsdelivr.net/gh/hung1001/font-awesome-pro@4cac1a6/fonts/AvenirNextLTPro-Regular.woff2") format("woff2"); } text { font-family: "Avenir Next LT Pro", sans-serif; }</style>'); const blob = new Blob([source], {type: 'image/svg+xml;charset=utf-8'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }

    // --- RENDER FUNCTIONS ---
    function renderAll(data) { 
        renderOverview(data); 
        renderInstitutional(data); 
        renderLabels(data); 
        renderTopics(data); 
        renderChannels(data);
        // NUOVO: Aggiorna anche PED con i dati filtrati
        try {
            const pedData = processDataPedFromObjects(data);
            globalProcessedDataPed = pedData; // FIX: Aggiorna la variabile globale per l'editor
            displayResultsPed(pedData);
        } catch(e) { console.error("PED Update Error", e); }
    }

    // 1. Overview
    function renderOverview(data) {
        const container = document.getElementById('tab-overview'); container.innerHTML = '';
        const counts = { fb:0, ig:0, wa:0, tw:0, li:0, yt:0 };
        data.forEach(r => { const c = String(r[cols.canale]).toLowerCase(); if(c.includes('facebook')) counts.fb++; else if(c.includes('instagram')) counts.ig++; else if(c.includes('whatsapp')) counts.wa++; else if(c.includes('twitter') || c.includes('x')) counts.tw++; else if(c.includes('linkedin')) counts.li++; else if(c.includes('youtube')) counts.yt++; });
        const totals = { 'Post Totali': {val: data.length, icon: '<i class="fas fa-layer-group"></i>'}, 'Facebook': {val: counts.fb, icon: getChannelIcon('facebook')}, 'Instagram': {val: counts.ig, icon: getChannelIcon('instagram')}, 'LinkedIn': {val: counts.li, icon: getChannelIcon('linkedin')}, 'X (Twitter)': {val: counts.tw, icon: getChannelIcon('x')}, 'YouTube': {val: counts.yt, icon: getChannelIcon('youtube')}, 'WhatsApp': {val: counts.wa, icon: getChannelIcon('whatsapp')} };
        
        const card = document.createElement('div'); card.className = 'card';
        const header = document.createElement('div'); header.className = 'card-header';
        header.innerHTML = '<h2><i class="fas fa-chart-pie"></i> Volumi di Pubblicazione</h2>';
        const btnExp = document.createElement('button'); btnExp.className = 'action-btn excel';
        btnExp.innerHTML = '<i class="fas fa-file-excel"></i> Scarica Excel';
        btnExp.onclick = () => { const ws = XLSX.utils.json_to_sheet(Object.entries(totals).map(([k, v]) => ({ "Metrica": k, "Valore": v.val }))); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Panoramica"); XLSX.writeFile(wb, "Panoramica.xlsx"); };
        header.appendChild(btnExp); card.appendChild(header);

        const grid = document.createElement('div'); grid.className = 'stats-grid';
        Object.entries(totals).forEach(([k, obj]) => { const sc = document.createElement('div'); sc.className = 'stat-card'; sc.innerHTML = `<span class="stat-label">${obj.icon} ${k}</span><div class="stat-value">${obj.val}</div>`; sc.querySelector('.stat-value').appendChild(createCopyBtn(obj.val)); grid.appendChild(sc); });
        card.appendChild(grid); container.appendChild(card);
    }

    // 2. Istituzionale
    function renderInstitutional(data) {
        const container = document.getElementById('tab-instit'); container.innerHTML = '';
        const colIst = findCol('istituzionale', data[0]) || 'Istituzionale';
        const institData = data.filter(r => String(r[colIst]).trim() === '1');
        const agg={};
        institData.forEach(r=>{ 
            const a=r[cols.arg]||'ND'; 
            if(!agg[a]) agg[a]={v:0, i:0, l:0, c:0, lnk:r[cols.link]}; 
            agg[a].v+=Number(r[cols.vis])||0; agg[a].i+=Number(r[cols.inter])||0; agg[a].l+=Number(r[cols.like])||0; agg[a].c+=Number(r[cols.cond])||0;
        });
        currentTop5Data = Object.entries(agg).map(([a,d])=>({arg:a,...d})).sort((a,b)=>b.v-a.v).slice(0,5);
        const kpi = { 'Numero post': institData.length, 'Visualizzazioni': institData.reduce((s,r)=>s+(Number(r[cols.vis])||0),0), 'Interazioni': institData.reduce((s,r)=>s+(Number(r[cols.inter])||0),0), 'Like': institData.reduce((s,r)=>s+(Number(r[cols.like])||0),0) };
        
        const card = document.createElement('div'); card.className = 'card';
        const header = document.createElement('div'); header.className = 'card-header';
        header.innerHTML = '<h2><i class="fas fa-university"></i> KPI Istituzionali</h2>';
        const btnExp = document.createElement('button'); btnExp.className = 'action-btn excel'; btnExp.innerHTML = '<i class="fas fa-file-excel"></i> Scarica Excel'; btnExp.onclick = () => { const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([kpi]), "KPI"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(currentTop5Data), "Top5"); XLSX.writeFile(wb, "Istituzionali.xlsx"); };
        header.appendChild(btnExp); card.appendChild(header);

        const grid = document.createElement('div'); grid.className = 'stats-grid';
        Object.entries(kpi).forEach(([k,v]) => { const sc = document.createElement('div'); sc.className = 'stat-card'; const fmt = formatNumber(v); sc.innerHTML = `<span class="stat-label">${k}</span><div class="stat-value">${fmt}</div>`; sc.querySelector('.stat-value').appendChild(createCopyBtn(fmt)); grid.appendChild(sc); });
        card.appendChild(grid);

        const tblDiv = document.createElement('div'); tblDiv.style.marginTop='2rem';
        const tblHead = document.createElement('div'); tblHead.className='table-header-actions';
        tblHead.innerHTML = '<h3><i class="fas fa-table"></i> Top 5 Performers</h3>';
        const tbl = document.createElement('table'); tblHead.appendChild(createTableCopyBtn(tbl)); tblDiv.appendChild(tblHead);
        tbl.innerHTML = '<thead><tr><th>Argomento</th><th>Visualizzazioni</th><th>Interazioni</th><th>Like</th><th>Condivisioni</th><th>Link</th></tr></thead><tbody></tbody>';
        currentTop5Data.forEach(o => { tbl.querySelector('tbody').innerHTML += `<tr><td>${o.arg}</td><td>${formatNumber(o.v)}</td><td>${formatNumber(o.i)}</td><td>${formatNumber(o.l)}</td><td>${formatNumber(o.c)}</td><td>${o.lnk?'<a href="'+o.lnk+'" target="_blank">link</a>':''}</td>`; });
        const tw = document.createElement('div'); tw.className='table-wrapper'; tw.appendChild(tbl); tblDiv.appendChild(tw); card.appendChild(tblDiv);

        const editDiv = document.createElement('div'); editDiv.style.marginTop='2rem'; editDiv.style.textAlign='right';
        editDiv.innerHTML = `<button class="action-btn" onclick="openEditModal()"><i class="fas fa-pen"></i> Modifica Testi per Grafici</button>`;
        card.appendChild(editDiv);

        const chartsWrapper = document.createElement('div');
        chartsWrapper.innerHTML = `<div class="inst-chart-container-wrapper"><div class="inst-chart-header"><span class="inst-chart-title">Grafico Prestazioni</span><div class="inst-chart-controls" id="ctrl-chart-1"></div></div><div id="inst-chart-1" class="chart-container-inst"></div></div><div class="inst-chart-container-wrapper"><div class="inst-chart-header"><span class="inst-chart-title">Grafico Best Performers</span><div class="inst-chart-controls" id="ctrl-chart-2"></div></div><div id="inst-chart-2" class="chart-container-inst"></div></div>`;
        card.appendChild(chartsWrapper); container.appendChild(card);
        renderChartsOnly(kpi, currentTop5Data);
    }

    function renderChartsOnly(kpi, top5) {
        const c1H = ["Numero post", "Visualizzazioni", "Interazioni", "Like"];
        const c1V = [kpi['Numero post'], kpi['Visualizzazioni'], kpi['Interazioni'], kpi['Like']];
        const con1 = document.getElementById('inst-chart-1'); con1.innerHTML = '';
        const svg1 = renderInstSvgTop(c1H, c1V); con1.appendChild(svg1);
        const ctrl1 = document.getElementById('ctrl-chart-1'); ctrl1.innerHTML='';
        const bC1 = document.createElement('button'); bC1.className='action-btn'; bC1.innerHTML='<i class="far fa-copy"></i> Copia HQ'; bC1.onclick=()=>copySvgHighRes(svg1);
        const bD1 = document.createElement('button'); bD1.className='action-btn yellow'; bD1.innerHTML='<i class="fas fa-download"></i> SVG'; bD1.onclick=()=>downloadSvgDirect(svg1,'grafico-1.svg');
        ctrl1.append(bC1, bD1);

        const c2H = ["Argomento", "Visualizzazioni", "Interazioni", "Like", "Condivisioni"];
        const c2R = top5.map(i => [i.arg, i.v, i.i, i.l, i.c]);
        const con2 = document.getElementById('inst-chart-2'); con2.innerHTML='';
        const svg2 = renderInstSvgBottom(c2H, c2R); con2.appendChild(svg2);
        const ctrl2 = document.getElementById('ctrl-chart-2'); ctrl2.innerHTML='';
        const bC2 = document.createElement('button'); bC2.className='action-btn'; bC2.innerHTML='<i class="far fa-copy"></i> Copia HQ'; bC2.onclick=()=>copySvgHighRes(svg2);
        const bD2 = document.createElement('button'); bD2.className='action-btn yellow'; bD2.innerHTML='<i class="fas fa-download"></i> SVG'; bD2.onclick=()=>downloadSvgDirect(svg2,'grafico-2.svg');
        ctrl2.append(bC2, bD2);
    }

    function renderInstSvgTop(headers, values) {
        const svgns = "http://www.w3.org/2000/svg"; const svg = document.createElementNS(svgns, 'svg'); svg.setAttribute('viewBox', '0 0 2156 102'); svg.style.fontFamily = "'Avenir Next LT Pro', sans-serif"; svg.style.backgroundColor='white';
        const w=2156, colW=w/headers.length;
        const line = document.createElementNS(svgns, 'line'); line.setAttribute('x1',0); line.setAttribute('y1',45); line.setAttribute('x2',w); line.setAttribute('y2',45); line.setAttribute('stroke','#1b47b4'); line.setAttribute('stroke-width',2); svg.appendChild(line);
        headers.forEach((h,i)=>{ const x=colW*i+colW/2; const t1 = document.createElementNS(svgns,'text'); t1.setAttribute('x',x); t1.setAttribute('y',35); t1.setAttribute('text-anchor','middle'); t1.setAttribute('font-size',34); t1.setAttribute('fill','#1b47b4'); t1.textContent=h; svg.appendChild(t1); const t2 = document.createElementNS(svgns,'text'); t2.setAttribute('x',x); t2.setAttribute('y',80); t2.setAttribute('text-anchor','middle'); t2.setAttribute('font-size',34); t2.setAttribute('fill','black'); t2.textContent=formatNumberInstChart(values[i]); svg.appendChild(t2); });
        return svg;
    }
    
    function renderInstSvgBottom(headers, rows) {
        const svgns = "http://www.w3.org/2000/svg"; const svg = document.createElementNS(svgns, 'svg'); const w=2156, h=135*6; svg.setAttribute('viewBox', `0 0 ${w} ${h}`); svg.style.fontFamily = "'Avenir Next LT Pro', sans-serif"; svg.style.backgroundColor='white';
        const lm=50, rm=50, imgW=350, dataW=w-lm-rm-imgW; const colWs = [dataW*0.45, dataW*0.1375, dataW*0.1375, dataW*0.1375, dataW*0.1375]; let cx=lm+imgW;
        headers.forEach((h,i)=>{ const t=document.createElementNS(svgns,'text'); t.setAttribute('x',cx+colWs[i]/2); t.setAttribute('y',125); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size',34); t.setAttribute('fill','#1b47b4'); t.textContent=h; svg.appendChild(t); cx+=colWs[i]; });
        const l=document.createElementNS(svgns,'line'); l.setAttribute('x1',lm); l.setAttribute('y1',135); l.setAttribute('x2',w-rm); l.setAttribute('y2',135); l.setAttribute('stroke','#1b47b4'); l.setAttribute('stroke-width',2); svg.appendChild(l);
        rows.slice(0,5).forEach((row,ri)=>{ const y=135*(ri+2)-67; cx=lm+imgW; row.forEach((cell,ci)=>{ const t=document.createElementNS(svgns,'text'); t.setAttribute('x',cx+colWs[ci]/2); t.setAttribute('y',y+10); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size',34); t.setAttribute('fill','black'); if(ci===0) { const rawLines = String(cell).split('\n'); let lines = []; const max = 35; rawLines.forEach(rawLine => { const words = rawLine.split(' '); let currentLine = ''; words.forEach(wd => { if((currentLine + wd).length > max) { lines.push(currentLine); currentLine = wd + ' '; } else { currentLine += wd + ' '; } }); lines.push(currentLine); }); t.textContent=''; lines.forEach((ln,li)=>{ const ts=document.createElementNS(svgns,'tspan'); ts.textContent=ln; ts.setAttribute('x',cx+colWs[ci]/2); ts.setAttribute('dy',li===0?(-(lines.length-1)*20):40); t.appendChild(ts); }); } else { t.textContent=formatNumberInstChart(cell); } svg.appendChild(t); cx+=colWs[ci]; }); const l2=document.createElementNS(svgns,'line'); l2.setAttribute('x1',lm); l2.setAttribute('y1',135*(ri+2)); l2.setAttribute('x2',w-rm); l2.setAttribute('y2',135*(ri+2)); l2.setAttribute('stroke','#ccc'); svg.appendChild(l2); });
        return svg;
    }

    function openEditModal() { const m=document.getElementById('editModal'); const b=document.getElementById('modal-body-inputs'); b.innerHTML=''; currentTop5Data.forEach((item,i)=>{ b.innerHTML+=`<div class="modal-row"><label>Argomento ${i+1}</label><textarea id="edit-input-${i}" rows="1">${item.arg}</textarea></div>`; }); m.classList.add('open'); }
    function closeEditModal() { document.getElementById('editModal').classList.remove('open'); }
    function saveModalChanges() { currentTop5Data.forEach((item,i)=>{ item.arg = document.getElementById(`edit-input-${i}`).value; }); const colIst = findCol('istituzionale', filteredData[0])||'Istituzionale'; const institData = filteredData.filter(r => String(r[colIst]).trim() === '1'); const kpi = { 'Numero post': institData.length, 'Visualizzazioni': institData.reduce((s,r)=>s+(Number(r[cols.vis])||0),0), 'Interazioni': institData.reduce((s,r)=>s+(Number(r[cols.inter])||0),0), 'Like': institData.reduce((s,r)=>s+(Number(r[cols.like])||0),0) }; renderChartsOnly(kpi, currentTop5Data); closeEditModal(); showToast("Grafici aggiornati!", "success"); }

    // 3. LABELS
    function renderLabels(data) {
        const container = document.getElementById('tab-labels'); container.innerHTML = '';
        const aggV = {}, aggI = {}; let totalVis = 0; let totalInter = 0;
        data.forEach(r => { const l = r[cols.label] || 'Nessuna'; const v = Number(r[cols.vis] || 0); const i = Number(r[cols.inter] || 0); aggV[l] = (aggV[l] || 0) + v; aggI[l] = (aggI[l] || 0) + i; totalVis += v; totalInter += i; });
        const sortedV = Object.entries(aggV).map(([k, v]) => ({ label: k, val: v })).sort((a, b) => b.val - a.val);
        const sortedI = Object.entries(aggI).map(([k, v]) => ({ label: k, val: v })).sort((a, b) => b.val - a.val);

        const mainRow = document.createElement('div'); mainRow.className = 'tables-row';
        const colVis = document.createElement('div'); colVis.className = 'analysis-column';
        colVis.appendChild(createTableCol('Visualizzazioni', sortedV, '<i class="far fa-eye"></i>', totalVis));
        const chartVWrapper = document.createElement('div'); chartVWrapper.className = 'label-chart-wrapper';
        chartVWrapper.innerHTML = `<div class="label-chart-header"><span class="label-chart-title">Top Label per Visualizzazioni</span><div class="card-actions" id="actions-chart-v"></div></div><div class="chart-controls-row"><div class="control-group"><label><span><i class="fas fa-text-height"></i> Label</span> <span class="slider-val" id="val-v-label">1.0</span></label><input type="range" class="range-slider" id="slider-v-label" min="0.5" max="1.5" step="0.05" value="1.0"></div><div class="control-group"><label><span><i class="fas fa-hashtag"></i> Valori</span> <span class="slider-val" id="val-v-value">1.0</span></label><input type="range" class="range-slider" id="slider-v-value" min="0.5" max="1.5" step="0.05" value="1.0"></div><div class="control-group"><label><span><i class="fas fa-sort-numeric-down"></i> Decimali</span></label><select id="sel-v-decimals" style="width:200px; padding:5px; border-radius:4px; border:1px solid #ccc;"><option value="0">0</option><option value="1">1</option><option value="2" selected>2</option></select></div></div><div id="svg-container-v"></div>`;
        colVis.appendChild(chartVWrapper);

        const colInt = document.createElement('div'); colInt.className = 'analysis-column';
        colInt.appendChild(createTableCol('Interazioni', sortedI, '<i class="far fa-thumbs-up"></i>', totalInter));
        const chartIWrapper = document.createElement('div'); chartIWrapper.className = 'label-chart-wrapper';
        chartIWrapper.innerHTML = `<div class="label-chart-header"><span class="label-chart-title">Top Label per Interazioni</span><div class="card-actions" id="actions-chart-i"></div></div><div class="chart-controls-row"><div class="control-group"><label><span><i class="fas fa-text-height"></i> Label</span> <span class="slider-val" id="val-i-label">1.0</span></label><input type="range" class="range-slider" id="slider-i-label" min="0.5" max="1.5" step="0.05" value="1.0"></div><div class="control-group"><label><span><i class="fas fa-hashtag"></i> Valori</span> <span class="slider-val" id="val-i-value">1.0</span></label><input type="range" class="range-slider" id="slider-i-value" min="0.5" max="1.5" step="0.05" value="1.0"></div><div class="control-group"><label><span><i class="fas fa-sort-numeric-down"></i> Decimali</span></label><select id="sel-i-decimals" style="width:200px; padding:5px; border-radius:4px; border:1px solid #ccc;"><option value="0">0</option><option value="1">1</option><option value="2" selected>2</option></select></div></div><div id="svg-container-i"></div>`;
        colInt.appendChild(chartIWrapper);

        mainRow.appendChild(colVis); mainRow.appendChild(colInt); container.appendChild(mainRow);

        const updateChart = (type) => {
            const isV = type === 'v';
            const scaleLabel = parseFloat(document.getElementById(`slider-${type}-label`).value);
            const scaleValue = parseFloat(document.getElementById(`slider-${type}-value`).value);
            const decimals = parseInt(document.getElementById(`sel-${type}-decimals`).value);
            document.getElementById(`val-${type}-label`).innerText = scaleLabel.toFixed(2);
            document.getElementById(`val-${type}-value`).innerText = scaleValue.toFixed(2);
            const dataSet = isV ? sortedV.slice(0, 10) : sortedI.slice(0, 10);
            const containerId = isV ? 'svg-container-v' : 'svg-container-i';
            const actionId = isV ? 'actions-chart-v' : 'actions-chart-i';
            const metric = isV ? 'Visualizzazioni' : 'Interazioni';
            const filename = `Grafico_Label_${metric}.svg`;
            const containerDiv = document.getElementById(containerId); containerDiv.innerHTML = '';
            const svg = renderLabelSvg(dataSet, metric, scaleLabel, scaleValue, decimals); containerDiv.appendChild(svg);
            const actionDiv = document.getElementById(actionId); actionDiv.innerHTML = '';
            const btnCopy = document.createElement('button'); btnCopy.className = 'action-btn'; btnCopy.innerHTML = '<i class="far fa-copy"></i> Copia HQ'; btnCopy.onclick = () => copySvgHighRes(containerDiv.querySelector('svg')); 
            const btnDown = document.createElement('button'); btnDown.className = 'action-btn yellow'; btnDown.innerHTML = '<i class="fas fa-download"></i> SVG Trasparente'; btnDown.onclick = () => downloadTransparentSvg(containerDiv.querySelector('svg'), filename);
            actionDiv.append(btnCopy, btnDown);
        };
        updateChart('v'); updateChart('i');
        ['v', 'i'].forEach(t => { document.getElementById(`slider-${t}-label`).addEventListener('input', () => updateChart(t)); document.getElementById(`slider-${t}-value`).addEventListener('input', () => updateChart(t)); document.getElementById(`sel-${t}-decimals`).addEventListener('change', () => updateChart(t)); });
    }

    function createTableCol(title, dataList, icon, totalVal) {
        const card = document.createElement('div'); card.className = 'table-col';
        const header = document.createElement('div'); header.className = 'table-header-actions'; header.innerHTML = `<h3>${icon} ${title}</h3>`;
        const tbl = document.createElement('table'); header.appendChild(createTableCopyBtn(tbl)); card.appendChild(header);
        tbl.innerHTML = `<thead><tr><th>Label</th><th>Valore</th></tr></thead><tbody></tbody>`;
        dataList.forEach(item => { tbl.querySelector('tbody').innerHTML += `<tr><td>${item.label}</td><td>${formatNumberItalian(item.val)}</td></tr>`; });
        const tfoot = document.createElement('tfoot'); const formattedTotal = formatSmartKM(totalVal);
        const trTotal = document.createElement('tr'); trTotal.innerHTML = `<td>TOTALE</td><td><div style="display:flex; justify-content:space-between; align-items:center;"><span>${formattedTotal}</span></div></td>`;
        trTotal.querySelector('div').appendChild(createCopyBtn(formattedTotal)); tfoot.appendChild(trTotal); tbl.appendChild(tfoot);
        const tw = document.createElement('div'); tw.className = 'table-wrapper'; tw.style.maxHeight = '400px'; tw.appendChild(tbl); card.appendChild(tw); return card;
    }

    function renderLabelSvg(data, metricName, scaleLabel, scaleValue, decimals) {
        const svgns = "http://www.w3.org/2000/svg"; const svg = document.createElementNS(svgns, 'svg');
        const w = 2800; const h = 2000; const headerH = 20; const footerH = 50; const availableH = h - headerH - footerH; const rowH = availableH / (data.length || 1); const barHeight = rowH * 0.6;
        const fontSizeRaw = Math.min(90, barHeight * 0.45) * scaleLabel; const valueFontSize = Math.min(70, barHeight * 0.55) * scaleValue;
        svg.setAttribute('viewBox', `0 0 ${w} ${h}`); svg.setAttribute('xmlns', svgns); svg.style.fontFamily = "'Avenir Next LT Pro', 'Segoe UI', sans-serif";
        const maxVal = data.length > 0 ? data[0].val : 1; const maxBarW = w * 0.50; const startBarX = w * 0.35; const maxLabelPixelWidth = startBarX - 55; 
        data.forEach((item, i) => {
            const y = headerH + (i * rowH); const centerY = y + (rowH / 2); const barW = (item.val / maxVal) * maxBarW;
            const estimatedTextPixelWidth = item.label.length * (fontSizeRaw * 0.48); const shouldWrap = estimatedTextPixelWidth > maxLabelPixelWidth;
            const labelText = document.createElementNS(svgns, 'text'); labelText.setAttribute('x', 20); labelText.setAttribute('font-size', fontSizeRaw); labelText.setAttribute('fill', '#333');
            if(shouldWrap) {
                 const words = item.label.split(' '); let line1 = '', line2 = ''; const targetLen = item.label.length / 2;
                 for(let wd of words) { if ( (line1.length < targetLen || line1.length === 0) && (line1.length + wd.length) * (fontSizeRaw * 0.48) < maxLabelPixelWidth) { line1 += wd + ' '; } else { line2 += wd + ' '; } }
                 if(!line1 && words.length > 0) { line1 = words[0]; line2 = words.slice(1).join(' '); }
                 const lineHeight = fontSizeRaw * 1.1; const startY = centerY - (fontSizeRaw * 0.2);
                 const ts1 = document.createElementNS(svgns, 'tspan'); ts1.textContent = line1.trim(); ts1.setAttribute('x', 20); ts1.setAttribute('y', startY); 
                 const ts2 = document.createElementNS(svgns, 'tspan'); ts2.textContent = line2.trim(); ts2.setAttribute('x', 20); ts2.setAttribute('dy', lineHeight); labelText.appendChild(ts1); labelText.appendChild(ts2);
            } else { labelText.textContent = item.label; labelText.setAttribute('y', centerY + (fontSizeRaw * 0.35)); }
            svg.appendChild(labelText);
            const rect = document.createElementNS(svgns, 'rect'); rect.setAttribute('x', startBarX); rect.setAttribute('y', centerY - (barHeight / 2)); rect.setAttribute('width', Math.max(barW, 5)); rect.setAttribute('height', barHeight); rect.setAttribute('fill', '#eedc00'); rect.setAttribute('stroke', '#0431ae'); rect.setAttribute('stroke-width', 5); rect.setAttribute('rx', 15); svg.appendChild(rect);
            const valText = document.createElementNS(svgns, 'text'); valText.setAttribute('x', startBarX + Math.max(barW, 5) + 30); valText.setAttribute('y', centerY + (valueFontSize * 0.35)); valText.setAttribute('text-anchor', 'start'); valText.setAttribute('font-size', valueFontSize); valText.setAttribute('fill', '#0431ae'); valText.setAttribute('font-weight', 'bold'); valText.textContent = formatCustomDecimals(item.val, decimals); svg.appendChild(valText);
            if (i < data.length - 1) { const sep = document.createElementNS(svgns, 'line'); sep.setAttribute('x1', 0); sep.setAttribute('y1', y + rowH); sep.setAttribute('x2', w); sep.setAttribute('y2', y + rowH); sep.setAttribute('stroke', '#eee'); sep.setAttribute('stroke-width', 2); svg.appendChild(sep); }
        });
        return svg;
    }

    // 4. TOPICS
    function renderTopics(data) {
        const container = document.getElementById('tab-topics'); container.innerHTML = '';
        const topics={}; data.forEach(r=>{ const a=r[cols.arg]||'Altro'; if(!topics[a]) topics[a]={n:0, v:0}; topics[a].n++; topics[a].v+=Number(r[cols.vis]||0); });
        const top = Object.entries(topics).map(([a,d])=>({arg:a,...d})).sort((a,b)=>b.v-a.v).slice(0,10);
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = '<h2><i class="fas fa-list-ol"></i> Top 10 Argomenti</h2><div class="table-wrapper"><table><thead><tr><th>Argomento</th><th>Post</th><th>Visualizzazioni</th></tr></thead><tbody></tbody></table></div>';
        top.forEach(t=>{ card.querySelector('tbody').innerHTML+=`<tr><td>${t.arg}</td><td>${t.n}</td><td>${formatNumber(t.v)}</td></tr>`; });
        container.appendChild(card);
    }

    // 5. CHANNELS
    function renderChannels(data) {
        const container = document.getElementById('tab-channels'); container.innerHTML = '';
        const counts = {}; data.forEach(r => { const c = String(r[cols.canale]).toLowerCase(); counts[c] = (counts[c]||0) + 1; });
        const sortedChans = Object.entries(counts).sort((a,b) => b[1]-a[1]);
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = '<h2><i class="fas fa-filter"></i> Dettaglio Canale</h2>';
        const sel = document.createElement('select'); sel.id='chan-sel';
        sel.innerHTML = '<option value="">-- Seleziona un Canale --</option>';
        sortedChans.forEach(([k,v]) => { sel.innerHTML += `<option value="${k}">${k.toUpperCase()} (${v})</option>`; });
        card.appendChild(sel);
        const contentArea = document.createElement('div'); contentArea.id = 'chan-content-area'; card.appendChild(contentArea);
        container.appendChild(card);

        let isCappedMode = false; let capLimitVis = 0; let capLimitInt = 0;

        sel.addEventListener('change', (e) => {
            const val = e.target.value; contentArea.innerHTML = ''; if(!val) return;
            const chanData = data.filter(r => String(r[cols.canale]).toLowerCase() === val);
            const sortedForChart = [...chanData].sort((a,b)=>{ const pa=formatDate(a[cols.data]).split('/'), pb=formatDate(b[cols.data]).split('/'); return new Date(2000+parseInt(pa[2]),pa[1]-1,pa[0]) - new Date(2000+parseInt(pb[2]),pb[1]-1,pb[0]); });

            const acc1 = document.createElement('details'); acc1.className='accordion-item'; acc1.open = true;
            acc1.innerHTML = `<summary><i class="fas fa-chart-bar"></i> Analisi Temporale</summary>`;
            const acc1Body = document.createElement('div'); acc1Body.className='accordion-content';
            const toggleDiv = document.createElement('div'); toggleDiv.style.marginBottom = '20px'; toggleDiv.style.display = 'flex'; toggleDiv.style.flexDirection = 'column'; toggleDiv.style.gap = '15px';
            toggleDiv.innerHTML = `<div style="display:flex; align-items:center; flex-wrap:wrap; gap:20px; border-bottom:1px solid #eee; padding-bottom:15px;"><label style="cursor:pointer; font-weight:600; color:var(--primary); display:flex; align-items:center; gap:8px; font-size:0.95rem;"><input type="checkbox" id="cap-axis-toggle" style="transform:scale(1.2);"> Taglia Picchi (Controllo Manuale)</label><div id="manual-caps-container" style="display:none; align-items:center; gap:15px; background:#f9f9f9; padding:5px 10px; border-radius:6px; border:1px solid #eee;"><div style="display:flex; align-items:center; gap:5px;"><label for="cap-input-vis" style="font-size:0.85rem; color:#555; font-weight:600;">Limite Vis:</label><input type="number" id="cap-input-vis" style="width:100px; padding:4px; border:1px solid #ccc; border-radius:4px;"></div><div style="display:flex; align-items:center; gap:5px;"><label for="cap-input-int" style="font-size:0.85rem; color:#555; font-weight:600;">Limite Int:</label><input type="number" id="cap-input-int" style="width:100px; padding:4px; border:1px solid #ccc; border-radius:4px;"></div></div></div><div style="display: flex; gap: 10px; align-items: center;"><span style="font-weight:600; color:var(--text-light); font-size:0.85rem;">RAGGRUPPA PER:</span><button class="action-btn active" id="gran-day" onclick="updateGranularity('day')">Giorno</button><button class="action-btn" id="gran-week" onclick="updateGranularity('week')">Settimana</button><button class="action-btn" id="gran-month" onclick="updateGranularity('month')">Mese</button></div>`;
            acc1Body.appendChild(toggleDiv);

            window.currentGranularity = 'day';
            window.updateGranularity = (mode) => { window.currentGranularity = mode; document.querySelectorAll('[id^="gran-"]').forEach(b => b.classList.remove('active')); document.getElementById('gran-' + mode).classList.add('active'); renderApp2ChartsAndTables(sortedForChart, isCappedMode, capLimitVis, capLimitInt); };

            const chartsDiv = document.createElement('div'); chartsDiv.innerHTML = `<div class="charts-container"><div class="chart-wrapper" id="visChartContainer"></div><div class="chart-wrapper" id="interChartContainer"></div></div>`;
            acc1Body.appendChild(chartsDiv);

            const subAcc = document.createElement('details'); subAcc.className = 'nested-accordion'; subAcc.innerHTML = '<summary>Tabelle Dati Giornalieri</summary>';
            const subContent = document.createElement('div'); subContent.className = 'nested-content panels-row';
            subContent.innerHTML = '<div class="panel-col"><div class="table-wrapper"><table id="tableVisChan"><thead><tr><th>Data</th><th>Vis</th></tr></thead><tbody></tbody></table></div></div><div class="panel-col"><div class="table-wrapper"><table id="tableInterChan"><thead><tr><th>Data</th><th>Int</th></tr></thead><tbody></tbody></table></div></div>';
            subAcc.appendChild(subContent); acc1Body.appendChild(subAcc); acc1.appendChild(acc1Body); contentArea.appendChild(acc1);
            
            const calculateSuggestion = (metricKey) => { const groups = {}; sortedForChart.forEach(d => { const fd = formatDate(d[cols.data]); if(!groups[fd]) groups[fd] = 0; groups[fd] += Number(d[metricKey] || 0); }); const values = Object.values(groups).sort((a,b) => b - a); let base = values.length > 1 ? values[1] : values[0]; if (values.length > 1 && values[0] > values[1] * 1.5) { base = values[1] * 1.2; } else { base = values[0]; } return Math.round(base); };

            const toggleEl = document.getElementById('cap-axis-toggle'); const inputsContainer = document.getElementById('manual-caps-container'); const inputVis = document.getElementById('cap-input-vis'); const inputInt = document.getElementById('cap-input-int');
            toggleEl.addEventListener('change', (evt) => { isCappedMode = evt.target.checked; if (isCappedMode) { capLimitVis = calculateSuggestion(cols.vis); capLimitInt = calculateSuggestion(cols.inter); inputVis.value = capLimitVis; inputInt.value = capLimitInt; inputsContainer.style.display = 'flex'; } else { inputsContainer.style.display = 'none'; } renderApp2ChartsAndTables(sortedForChart, isCappedMode, capLimitVis, capLimitInt); });
            inputVis.addEventListener('input', (e) => { capLimitVis = Number(e.target.value) || 0; renderApp2ChartsAndTables(sortedForChart, isCappedMode, capLimitVis, capLimitInt); });
            inputInt.addEventListener('input', (e) => { capLimitInt = Number(e.target.value) || 0; renderApp2ChartsAndTables(sortedForChart, isCappedMode, capLimitVis, capLimitInt); });
            setTimeout(() => { toggleEl.checked = false; renderApp2ChartsAndTables(sortedForChart, false, 0, 0); }, 50); 

            const acc2 = document.createElement('details'); acc2.className='accordion-item'; acc2.innerHTML = `<summary><i class="fas fa-stream"></i> Feed dei Post</summary>`;
            const acc2Body = document.createElement('div'); acc2Body.className='accordion-content'; renderChannelCards(chanData, acc2Body, val); acc2.appendChild(acc2Body); contentArea.appendChild(acc2);
        });
    }

    function renderApp2ChartsAndTables(data, isCapped, limitVis, limitInt) {
        const tv = document.getElementById('tableVisChan').querySelector('tbody'); const ti = document.getElementById('tableInterChan').querySelector('tbody'); tv.innerHTML=''; ti.innerHTML='';
        if (data.length === 0) return;
        data.forEach(r => { const d = formatDate(r[cols.data]); tv.innerHTML += `<tr><td>${d}</td><td>${formatNumberItalian(r[cols.vis])}</td></tr>`; ti.innerHTML += `<tr><td>${d}</td><td>${formatNumberItalian(r[cols.inter])}</td></tr>`; });
        const visTot = data.reduce((a,c)=>a+Number(c[cols.vis]||0),0); const intTot = data.reduce((a,c)=>a+Number(c[cols.inter]||0),0);
        const mode = window.currentGranularity || 'day'; const grouped = {};
        data.forEach(r => {
            const dStr = formatDateForCompare(r[cols.data]); const dObj = new Date(dStr); let key, label;
            if (mode === 'month') { key = `${dObj.getFullYear()}-${String(dObj.getMonth() + 1).padStart(2, '0')}-01`; const mesi = ["Gen", "Feb", "Mar", "Apr", "Mag", "Giu", "Lug", "Ago", "Set", "Ott", "Nov", "Dic"]; label = `${mesi[dObj.getMonth()]} ${dObj.getFullYear().toString().slice(-2)}`; } else if (mode === 'week') { const day = dObj.getDay(), diff = dObj.getDate() - day + (day === 0 ? -6 : 1); const monday = new Date(dObj.setDate(diff)); key = monday.toISOString().split('T')[0]; label = `Sett ${monday.getDate()}/${monday.getMonth()+1}`; } else { key = dStr; label = formatDate(dStr).split('/').slice(0,2).join('/'); }
            if (!grouped[key]) grouped[key] = { label: label, vis: 0, inter: 0 }; grouped[key].vis += Number(r[cols.vis] || 0); grouped[key].inter += Number(r[cols.inter] || 0);
        });
        const sortedKeys = Object.keys(grouped).sort(); const aggregatedData = sortedKeys.map(k => ({ date: grouped[k].label, vis: grouped[k].vis, inter: grouped[k].inter }));
        drawChart('visChartContainer', aggregatedData, 'vis', 'VISUALIZZAZIONI', visTot, isCapped, limitVis); drawChart('interChartContainer', aggregatedData, 'inter', 'INTERAZIONI', intTot, isCapped, limitInt);
    }

    function drawChart(containerId, aggregatedData, metric, title, total, isCapped, capLimit) {
        const container = d3.select("#" + containerId); container.html("");
        const buttons = container.append('div').attr('class', 'chart-buttons');
        const copyBtn = buttons.append('button').attr('class', 'chart-btn').html('<i class="material-icons" style="font-size: 20px;">content_copy</i>');
        const downloadBtn = buttons.append('button').attr('class', 'chart-btn').html('<i class="material-icons" style="font-size: 20px;">download</i>');
        const margin = {top: 75, right: 20, bottom: 50, left: 55}; const svgWidth = 1200; const svgHeight = 453; const width = svgWidth - margin.left - margin.right; const height = svgHeight - margin.top - margin.bottom;
        const svg = container.append("svg").attr("viewBox", `0 0 ${svgWidth} ${svgHeight}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
        const x = d3.scaleBand().domain(aggregatedData.map(d => d.date)).range([0, width]).padding(0.3);
        let yDomainMax = d3.max(aggregatedData, d => d[metric]) || 1; if (isCapped && capLimit > 0) yDomainMax = capLimit;
        const y = d3.scaleLinear().domain([0, yDomainMax]).range([height, isCapped ? 50 : 0]);
         const xAxis = d3.axisBottom(x).tickSize(0); if (aggregatedData.length > 20) { xAxis.tickValues(x.domain().filter((d,i) => i % Math.ceil(aggregatedData.length/15) === 0)); }
        
        // Asse X con stili Inline per persistenza in export SVG
        svg.append("g").attr("class", "x-axis").attr("transform", `translate(0,${height})`)
           .call(xAxis).call(g => g.select(".domain").remove())
           .selectAll("text")
           .style("font-size", "14px")
           .style("font-family", "'Nunito Sans', sans-serif")
           .style("fill", "#7b7b7a");

        // Asse Y con stili Inline per persistenza in export SVG
        const yAxisG = svg.append("g").attr("class", "y-axis")
           .call(d3.axisLeft(y).ticks(5).tickFormat(d => formatKValue(d))); 
        
        yAxisG.call(g => g.select(".domain").remove()); 
        yAxisG.selectAll(".tick line").clone().attr("x2", width).attr("stroke", "#e0e0e0").attr("stroke-opacity", 0.7);
        
        yAxisG.selectAll("text")
           .style("font-size", "14px")
           .style("font-family", "'Nunito Sans', sans-serif")
           .style("fill", "#7b7b7a");
        const header = svg.append("g").attr("class", "chart-header").attr("transform", `translate(${-40}, 0)`);
        header.append("text").attr("y", -30).html(`<tspan style="font-size:32px; font-weight:800; fill:#0431AE;">${title}</tspan><tspan style="font-size:32px; font-weight:300; fill:#3a3a3a;" dx="20">Totale: ${formatKValue(total)}</tspan>`);
        header.append("line").attr("x1", 0).attr("x2", width / 2).attr("y1", -15).attr("y2", -15).attr("stroke", "#0431AE");
        svg.selectAll(".bar-group").data(aggregatedData).enter().append("g").each(function(d) {
            const val = d[metric]; const isClipped = isCapped && val > yDomainMax; const barHeight = height - y(isClipped ? yDomainMax : val); const barY = y(isClipped ? yDomainMax : val); const bw = x.bandwidth(); const g = d3.select(this);
            if (isClipped) { const xPos = x(d.date); g.append("path").attr("d", `M ${xPos} ${barY + barHeight} L ${xPos} ${barY + bw} L ${xPos + bw} ${barY} L ${xPos + bw} ${barY + barHeight} Z`).style("fill", "#bfd7fd"); g.append("text").attr("x", xPos + bw / 2).attr("y", barY - 5).attr("text-anchor", "middle").style("font-size", "14px").style("font-weight", "bold").style("fill", "#0431AE").text(formatKValue(val)); } 
            else { g.append("rect").attr("x", x(d.date)).attr("y", barY).attr("width", bw).attr("height", barHeight).style("fill", "#bfd7fd"); }
        });
        downloadBtn.on('click', () => downloadSvgDirect(container.select('svg').node(), `grafico-${title}.svg`)); copyBtn.on('click', () => copySvgHighRes(container.select('svg').node()));
    }

    function renderChannelCards(posts, container, channelName) {
        container.innerHTML = '';
        const ctrlDiv = document.createElement('div'); ctrlDiv.className = 'feed-controls';
        const btnView = document.createElement('button'); btnView.className = 'action-btn active'; btnView.innerHTML = '<i class="far fa-eye"></i> Ordina per Visualizzazioni';
        const btnInt = document.createElement('button'); btnInt.className = 'action-btn'; btnInt.innerHTML = '<i class="far fa-thumbs-up"></i> Ordina per Interazioni';
        const btnExp = document.createElement('button'); btnExp.className = 'action-btn excel'; btnExp.innerHTML = '<i class="fas fa-file-excel"></i> Scarica Excel'; btnExp.onclick = () => { const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(posts), "Posts"); XLSX.writeFile(wb, "Feed.xlsx"); };
        ctrlDiv.append(btnView, btnInt, btnExp); container.appendChild(ctrlDiv);
        const gridDiv = document.createElement('div'); gridDiv.className = 'post-grid'; container.appendChild(gridDiv);
        window.currentChannelPosts = posts;
        const render = (sortType) => {
            gridDiv.innerHTML = ''; let sorted = [...posts]; if (sortType === 'views') sorted.sort((a,b) => (Number(b[cols.vis])||0) - (Number(a[cols.vis])||0)); else sorted.sort((a,b) => (Number(b[cols.inter])||0) - (Number(a[cols.inter])||0)); window.currentChannelPosts = sorted;
            sorted.slice(0, 50).forEach((r, idx) => {
                const label = (r[cols.label] || 'Account').toUpperCase(); const arg = r[cols.arg] || 'Generale'; const date = formatDate(r[cols.data]); const copyText = r[cols.copy] || ''; const visF = formatNumber(r[cols.vis]); const intF = formatNumber(r[cols.inter]); const postLink = r[cols.link];
                const card = document.createElement('div'); card.className = 'post-card';
                card.innerHTML = `<div class="post-header"><div class="post-channel-icon">${getChannelIcon(channelName)}</div><div class="post-meta"><div class="post-label">${label}</div><div class="post-date">${date}</div></div></div><div class="post-body"><span class="post-topic">${arg} <button class="copy-btn" style="color:var(--primary); margin-left:6px; font-size:1em;" onclick="event.stopPropagation(); navigator.clipboard.writeText('${arg.replace(/'/g, "\\'")}').then(()=>showToast('Argomento Copiato!','success'))" title="Copia argomento"><i class="far fa-copy"></i></button></span><div class="post-text">${copyText}</div></div><div class="post-footer"><div class="post-metrics"><div class="metric-item views"><i class="far fa-eye"></i> ${visF}</div><div class="metric-item likes"><i class="far fa-thumbs-up"></i> ${intF}</div></div><div class="post-actions-right">${postLink ? `<a href="${postLink}" target="_blank" class="post-link-btn" style="text-decoration:none; margin-right:8px;" title="Vai al post"><i class="fas fa-external-link-alt"></i></a>` : ''}<button class="action-btn blue-fill" onclick="openPostGraphModal(${idx})"><i class="fas fa-image"></i> Crea Grafica</button></div></div>`; gridDiv.appendChild(card);
            });
        };
        btnView.onclick = () => { btnView.classList.add('active'); btnInt.classList.remove('active'); render('views'); }; btnInt.onclick = () => { btnInt.classList.add('active'); btnView.classList.remove('active'); render('inter'); }; render('views');
    }

    function openPostGraphModal(index) {
        const post = window.currentChannelPosts[index]; if(!post) return;
        currentPostData = { label: (post[cols.label] || 'Account').toUpperCase(), data: formatDate(post[cols.data]), argomento: post[cols.arg] || 'Argomento', copy: post[cols.copy] || '', views: Number(post[cols.vis] || 0), inter: Number(post[cols.inter] || 0) };
        document.getElementById('pg-argomento').value = currentPostData.argomento; document.getElementById('pg-copy').value = currentPostData.copy; document.getElementById('pg-views').value = formatNumberFull(currentPostData.views); document.getElementById('pg-inter').value = formatNumberFull(currentPostData.inter); document.getElementById('pg-info').value = `${currentPostData.label} - ${currentPostData.data}`;
        updatePostSvg(); document.getElementById('postGraphModal').classList.add('open');
    }
    function closePostGraphModal() { document.getElementById('postGraphModal').classList.remove('open'); }
    function updatePostSvg() { const arg = document.getElementById('pg-argomento').value; const cpy = document.getElementById('pg-copy').value; const svgString = generatePostSvgString({ ...currentPostData, argomento: arg, copy: cpy }); document.getElementById('pg-preview-container').innerHTML = svgString; }
    function generatePostSvgString(d) {
        const visualizzazioni = formatNumberFull(d.views); const interazioni = formatNumberFull(d.inter); const words = d.copy.split(' '); const lines = []; let currentLine = ''; const maxCharsPerLine = 62; const maxLines = 3;
        for (let i = 0; i < words.length; i++) { const word = words[i]; const testLine = currentLine ? currentLine + ' ' + word : word; if (testLine.length <= maxCharsPerLine) { currentLine = testLine; } else { lines.push(currentLine); currentLine = word; } if (lines.length === maxLines - 1 && i < words.length - 1) { let remainingWords = words.slice(i + 1).join(' '); let lastLineWithEllipsis = currentLine; const ellipsis = ' (...)'; while ((lastLineWithEllipsis + ' ' + remainingWords).length > maxCharsPerLine && remainingWords.includes(' ')) { const lastSpaceIndex = remainingWords.lastIndexOf(' '); if (lastSpaceIndex === -1) break; remainingWords = remainingWords.substring(0, lastSpaceIndex); } lastLineWithEllipsis = (lastLineWithEllipsis ? lastLineWithEllipsis + ' ' : '') + remainingWords; while (lastLineWithEllipsis.length + ellipsis.length > maxCharsPerLine && lastLineWithEllipsis.includes(' ')) { const lastSpaceIndex = lastLineWithEllipsis.lastIndexOf(' '); lastLineWithEllipsis = lastLineWithEllipsis.substring(0, lastSpaceIndex); } lines.push(lastLineWithEllipsis + ellipsis); currentLine = ''; break; } }
        if (currentLine && lines.length < maxLines) lines.push(currentLine);
        const copyTSpan = lines.map((line, index) => `<tspan x="30" dy="${index === 0 ? 0 : 30}">${line}</tspan>`).join('');
        return `<svg width="868" height="441" viewBox="0 0 868 441" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="868" height="77" fill="#E1E9F6"/><text x="434" y="55" font-family="Arial, sans-serif" font-size="40" fill="#0A4BB8" text-anchor="middle" alignment-baseline="middle">${d.label}</text><text x="30" y="125" font-family="Arial, sans-serif" font-size="30" font-weight="bold" fill="#0A4BB8">${d.argomento}</text><text x="130" y="226" font-family="Arial, sans-serif" font-size="30" fill="#666666">Pubblicato il ${d.data}</text><text x="30" y="290" font-family="Arial, sans-serif" font-size="30" fill="#666666">${copyTSpan}</text><text x="30" y="415" font-family="Arial, sans-serif" font-size="32" fill="#0A4BB8" font-weight="bold">Visualizzazioni:</text><text x="270" y="415" font-family="Arial, sans-serif" font-size="32" fill="#666666">${visualizzazioni}</text><text x="410" y="415" font-family="Arial, sans-serif" font-size="32" fill="#0A4BB8" font-weight="bold">Interazioni:</text><text x="590" y="415" font-family="Arial, sans-serif" font-size="32" fill="#666666">${interazioni}</text></svg>`;
    }
    function downloadPostSvg() { const svgEl = document.querySelector('#pg-preview-container svg'); if(!svgEl) return; const filename = `Grafica_${currentPostData.label}_${currentPostData.argomento.substring(0,10)}.svg`; downloadSvgDirect(svgEl, filename); showToast("SVG Scaricato", "success"); }
    function copyPostSvg() { const svgEl = document.querySelector('#pg-preview-container svg'); if(!svgEl) return; copySvgHighRes(svgEl); }

    // --- JSON EXECUTIVE LOGIC UPDATED ---
    jsonExecBtn.addEventListener('click', () => {
        if (!displayData || displayData.length === 0) { showToast("Nessun dato!", "error"); return; }
        
        // 1. CONTEGGI CANALI
        const counts = { fb:0, ig:0, wa:0, tw:0, li:0, yt:0 };
        displayData.forEach(r => { 
            const c = String(r[cols.canale]).toLowerCase(); 
            if(c.includes('facebook')) counts.fb++; 
            else if(c.includes('instagram')) counts.ig++; 
            else if(c.includes('whatsapp')) counts.wa++; 
            else if(c.includes('twitter')||c.includes('x')) counts.tw++; 
            else if(c.includes('linkedin')) counts.li++; 
            else if(c.includes('youtube')) counts.yt++; 
        });

        // 2. BEST PERFORMERS
        const topics = {};
        displayData.forEach(r => {
            const arg = r[cols.arg] || 'ND';
            if(!topics[arg]) topics[arg] = 0;
            topics[arg] += Number(r[cols.vis]) || 0;
        });
        const top3 = Object.entries(topics).sort((a,b) => b[1] - a[1]).slice(0,3);

        // 3. ISTITUZIONALI
        const colIst = findCol('istituzionale', displayData[0]) || 'Istituzionale';
        const institData = displayData.filter(r => String(r[colIst]).trim() === '1');
        const instStats = {
            num: institData.length,
            vis: institData.reduce((s,r) => s + (Number(r[cols.vis])||0), 0),
            inter: institData.reduce((s,r) => s + ((Number(r[cols.like])||0) + (Number(r[cols.inter])||0)), 0)
        };

        // HELPER FORMATTING (Es: 8,19M o 517K)
        const formatK = (n) => {
            if (n >= 1000000) {
                let v = (n / 1000000).toFixed(2).replace('.', ',');
                return v.replace(/,00$/, '') + 'M';
            }
            if (n >= 1000) {
                return Math.round(n / 1000) + 'K';
            }
            return n.toString();
        };

        // COSTRUZIONE OGGETTO JSON
        const exportJson = {
            "__COMMENTO_SEZIONE_VOLUMI__": "--- AMBITO 2: Volumi Post ---",
            "Numero post Facebook": counts.fb.toString(),
            "Numero post Instagram": counts.ig.toString(),
            "Numero post Linkedin": counts.li.toString(),
            "Numero post X (Twitter)": counts.tw.toString(),
            "Numero post Whatsapp": counts.wa.toString(),
            "Numero post Youtube": counts.yt.toString(),
            "__COMMENTO_SEZIONE_BEST__": "--- AMBITO 3: Best Performer ---"
        };

        // Aggiungo Top 3 dinamicamente
        top3.forEach((t, i) => {
            const idx = i + 1;
            exportJson[`Argomenti più visualizzati ${idx}`] = t[0];
            exportJson[`Visualizzazione Argomenti più visualizzati ${idx}`] = formatK(t[1]);
        });

        // Aggiungo Istituzionali
        exportJson["__COMMENTO_SEZIONE_ISTITUZIONALI__"] = "--- DATI ISTITUZIONALI ---";
        exportJson["Numero post istituzionali"] = instStats.num.toString();
        exportJson["Visualizzazione post istituzionali"] = formatK(instStats.vis);
        exportJson["Like + interazioni post istituzionali"] = formatK(instStats.inter);

        // Download
        const d = new Date();
        const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
        const h = String(d.getHours()).padStart(2,'0'), min = String(d.getMinutes()).padStart(2,'0'), s = String(d.getSeconds()).padStart(2,'0');
        const filename = `ES2_${y}_${m}_${day}_${h}_${min}_${s}_editoriale.json`;
        
        const blob = new Blob([JSON.stringify(exportJson, null, 2)], { type: "application/json" });
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob); 
        a.download = filename; 
        document.body.appendChild(a); 
        a.click(); 
        document.body.removeChild(a);
        showToast("JSON Executive scaricato!", "success");
    });

    // --- LOGICA COMPLETA PED (ELABORAZIONE + VISUALIZZAZIONE) ---

    // Helper UI: Gestione visibilità toggle colori
    window.togglePedColors = function(showLogos) {
        const container = document.getElementById('ped-color-toggle-container');
        if (showLogos) {
            container.style.opacity = '1'; container.style.pointerEvents = 'auto';
        } else {
            container.style.opacity = '0'; container.style.pointerEvents = 'none';
        }
    }

    // 1. ELABORAZIONE DATI (Core)
    function processDataPedFromObjects(filteredObjArray) {
        const results = {};
        if(!filteredObjArray || filteredObjArray.length === 0) return {};

        filteredObjArray.forEach(row => {
            const label = row[cols.label]; 
            const canale = row[cols.canale];
            
            if (!label || !canale) return;

            const argomento = row[cols.arg] || "N/D";
            let isIst = false;
            if (cols.istituzionale && row[cols.istituzionale] !== undefined) {
                isIst = String(row[cols.istituzionale]).trim() === '1';
            }

            if (!results[label]) {
                results[label] = { totalPosts: 0, channels: { Facebook: 0, Linkedin: 0, Instagram: 0, X: 0, Youtube: 0, Whatsapp: 0 }, argomenti: {} };
            }
            if (!results[label].argomenti[argomento]) {
                results[label].argomenti[argomento] = { 
                    channels: { Facebook: 0, Linkedin: 0, Instagram: 0, X: 0, Youtube: 0, Whatsapp: 0 }, 
                    totalPosts: 0, 
                    isIstituzionale: false, 
                    displayText: argomento, 
                    customIndex: undefined 
                };
            }
            
            if (isIst) { results[label].argomenti[argomento].isIstituzionale = true; }

            let matchedChannel = null;
            const canalLower = String(canale).toLowerCase();
            for (const channelName of CHANNELS_ORDER_PED) {
                const key = channelName.toLowerCase();
                if (key === 'x') { 
                    if (canalLower.includes('x') || canalLower.includes('twitter')) { matchedChannel = channelName; break; } 
                } else { 
                    if (canalLower.includes(key)) { matchedChannel = channelName; break; } 
                }
            }

            if (matchedChannel) {
                if(!results[label].argomenti[argomento].isIstituzionale && isIst) { results[label].argomenti[argomento].isIstituzionale = true; }
                results[label].argomenti[argomento].channels[matchedChannel]++;
                results[label].argomenti[argomento].totalPosts++;
                results[label].channels[matchedChannel]++;
                results[label].totalPosts++;
            }
        });
        
        for(const label in results) {
            for(const arg in results[label].argomenti) {
                if(results[label].argomenti[arg].totalPosts === 0) delete results[label].argomenti[arg];
            }
            if (results[label].totalPosts === 0) delete results[label];
        }
        return results;
    }

    // 2. REFRESH & DISPLAY
    window.refreshPedView = function() {
        if (!displayData || displayData.length === 0) {
            showToast("Nessun dato disponibile. Carica un file o controlla i filtri.", "warning");
            return;
        }
        
        const newData = processDataPedFromObjects(displayData);
        
        // Merge con eventuali modifiche manuali esistenti (es. ordinamento custom)
        if (globalProcessedDataPed && Object.keys(globalProcessedDataPed).length > 0) {
            for (const lbl in newData) {
                if (globalProcessedDataPed[lbl]) {
                    for (const arg in newData[lbl].argomenti) {
                        if (globalProcessedDataPed[lbl].argomenti[arg]) {
                            newData[lbl].argomenti[arg].displayText = globalProcessedDataPed[lbl].argomenti[arg].displayText;
                            newData[lbl].argomenti[arg].customIndex = globalProcessedDataPed[lbl].argomenti[arg].customIndex;
                        }
                    }
                }
            }
        }
        
        globalProcessedDataPed = newData;
        displayResultsPed(globalProcessedDataPed);
        showToast("Grafici PED aggiornati con i dati filtrati!", "success");
    }

    function displayResultsPed(processedData) {
        const container = document.getElementById('ped-results-container');
        container.innerHTML = '';
        
        if (Object.keys(processedData).length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:2rem; color:#888;"><i class="fas fa-inbox fa-3x" style="margin-bottom:1rem; opacity:0.5;"></i><br>Nessun dato trovato per i filtri correnti.</div>';
            return;
        }

        const layoutStyle = document.querySelector('input[name="layout-style"]:checked').value;
        const useColors = document.getElementById('ped-logo-color-toggle').checked;

        for (const label in processedData) {
            const data = processedData[label];
            const svgString = generatePedSVG(label, data, layoutStyle, useColors);

            const card = document.createElement('div');
            card.className = 'card-ped p-4';
            
            // Header Card
            const headerHtml = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <span style="font-weight:800; color:#aaa; font-size:0.9rem; letter-spacing:1px; text-transform:uppercase;">${label}</span>
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                        <input type="checkbox" class="ppt-checkbox" onchange="this.closest('.card-ped').classList.toggle('is-completed', this.checked)">
                        <span style="font-size:0.85rem; font-weight:600; color:#666;">Inserito nel PPT</span>
                    </label>
                </div>`;
            
            const svgContainer = document.createElement('div');
            svgContainer.className = 'svg-container-ped';
            svgContainer.id = `ped-svg-${label.replace(/[^a-z0-9]/gi, '_')}`;
            svgContainer.innerHTML = svgString;

            // Escape per evitare errori JS con apostrofi nel nome label
            const safeLabel = label.replace(/'/g, "\\'");
            const actionsHtml = `
                <div style="display:flex; justify-content:center; gap:10px; margin-top:1.5rem;">
                    <button class="action-btn" onclick="openEditModalPed('${safeLabel}')"><i class="fas fa-sort"></i> Modifica & Ordina</button>
                    <button class="action-btn yellow" onclick="downloadSinglePed('${safeLabel}')"><i class="fas fa-download"></i> Scarica SVG</button>
                </div>`;

            card.innerHTML = headerHtml;
            card.appendChild(svgContainer);
            card.insertAdjacentHTML('beforeend', actionsHtml);
            container.appendChild(card);
        }
    }

    // 3. MODALE EDIT & SORTING
    window.openEditModalPed = function(label) {
        currentEditLabelPed = label;
        document.getElementById('modal-label-title-ped').textContent = label;
        const mb = document.getElementById('modal-body-ped');
        mb.innerHTML = '';

        const data = globalProcessedDataPed[label];
        const sortedArgs = getSortedEntriesPed(data);

        sortedArgs.forEach(([key, details], idx) => {
            const row = document.createElement('div');
            row.className = 'modal-row-ped';
            row.innerHTML = `
                <div class="drag-handle-ped"><i class="fas fa-grip-vertical"></i></div>
                <div style="flex:1;">
                    <div style="font-size:0.7rem; color:#999; margin-bottom:2px;">Originale: ${key}</div>
                    <input type="text" class="ped-input-edit" value="${details.displayText || key}" data-key="${key}">
                </div>
            `;
            mb.appendChild(row);
        });

        if (sortableInstancePed) sortableInstancePed.destroy();
        sortableInstancePed = new Sortable(mb, { animation: 150, handle: '.drag-handle-ped' });

        document.getElementById('edit-modal-ped').classList.add('active');
    }

    window.closeModalPed = function() {
        document.getElementById('edit-modal-ped').classList.remove('active');
        currentEditLabelPed = null;
    }

    document.getElementById('save-edits-btn-ped').addEventListener('click', () => {
        if (!currentEditLabelPed) return;
        const rows = document.querySelectorAll('#modal-body-ped .modal-row-ped');
        rows.forEach((row, index) => {
            const input = row.querySelector('input');
            const key = input.getAttribute('data-key');
            const val = input.value;
            if (globalProcessedDataPed[currentEditLabelPed].argomenti[key]) {
                globalProcessedDataPed[currentEditLabelPed].argomenti[key].displayText = val;
                globalProcessedDataPed[currentEditLabelPed].argomenti[key].customIndex = index;
            }
        });
        displayResultsPed(globalProcessedDataPed); // Ridisegna
        closeModalPed();
        showToast("Modifiche applicate!", "success");
    });

    // 4. GENERATORE SVG
    function getSortedEntriesPed(data) {
        const entries = Object.entries(data.argomenti);
        const hasCustom = entries.some(([_, v]) => v.customIndex !== undefined);
        if (hasCustom) {
            return entries.sort((a, b) => (a[1].customIndex ?? 9999) - (b[1].customIndex ?? 9999));
        }
        // Fallback Logic (Istituzionale prima, poi per volume)
        return entries.sort(([kA, vA], [kB, vB]) => {
            if (vA.isIstituzionale !== vB.isIstituzionale) return vA.isIstituzionale ? -1 : 1;
            return vB.totalPosts - vA.totalPosts;
        });
    }

    function escapeXML(str) {
        return str.replace(/[<>&'"]/g, c => {
            switch(c) { case '<': return '&lt;'; case '>': return '&gt;'; case '&': return '&amp;'; case '\'': return '&apos;'; case '"': return '&quot;'; }
        });
    }

    function generatePedSVG(label, data, layoutStyle, useColors) {
        const fontSize = parseInt(document.getElementById('ped-font-size-input').value) || 18;
        const rowH = parseInt(document.getElementById('ped-line-height-input').value) || 28;
        
        const argW = 850, flagW = 30, chanW = 80, totW = 100, padX = 30;
        const width = padX + argW + (chanW * CHANNELS_ORDER_PED.length) + totW + padX;
        
        const sorted = getSortedEntriesPed(data);
        const contentH = sorted.length * rowH;
        
        let headerH = 40, padY = 25, curY = padY;
        let svgHtml = '';
        const blue = '#0146bc', dark = '#101827';

        if (layoutStyle === 'senza-loghi') {
            const titleY = curY + 20;
            // Modifica: label.toUpperCase() per maiuscolo forzato
            svgHtml += `<text x="${padX}" y="${titleY}" font-size="${fontSize+4}" font-weight="700" fill="${blue}">${escapeXML(label.toUpperCase())}</text>`;
            
            let cx = padX + argW;
            CHANNELS_ORDER_PED.forEach(ch => {
                const c = data.channels[ch] || 0;
                if (c > 0) svgHtml += `<text x="${cx + chanW/2}" y="${titleY}" text-anchor="middle" font-size="${fontSize}" fill="${blue}">${c}</text>`;
                cx += chanW;
            });
            svgHtml += `<text x="${cx + totW/2}" y="${titleY}" text-anchor="middle" font-weight="700" font-size="${fontSize}" fill="${blue}">${data.totalPosts}</text>`;
            svgHtml += `<line x1="${padX}" y1="${curY+32}" x2="${width-padX}" y2="${curY+32}" stroke="${blue}" stroke-width="1.5"/>`;
            curY += headerH;
        } else {
            const tblHeadH = fontSize + 20;
            
            // Modifica: label.toUpperCase() per maiuscolo forzato
            svgHtml += `<text x="${padX}" y="${curY+20}" font-size="${fontSize+4}" font-weight="700" fill="${blue}">${escapeXML(label.toUpperCase())}</text>`;
            svgHtml += `<line x1="${padX}" y1="${curY+32}" x2="${padX+500}" y2="${curY+32}" stroke="${blue}" stroke-width="1.5"/>`;
            curY += headerH;

            // Table Header
            svgHtml += `<rect x="${padX}" y="${curY}" width="${width-2*padX}" height="${tblHeadH}" fill="#f8f9fa"/>`;
            // Testo "Argomento" rimosso come richiesto
            
            let cx = padX + argW;
            CHANNELS_ORDER_PED.forEach(ch => {
                const col = useColors ? (BRAND_COLORS_PED[ch.toLowerCase()] || '#000') : blue;
                svgHtml += `<g transform="translate(${cx+chanW/2-11}, ${curY+tblHeadH/2-11})"><path d="${ICON_PATHS_PED[ch.toLowerCase()]}" fill="${col}" transform="scale(1.1)"/></g>`;
                cx += chanW;
            });
            svgHtml += `<text x="${cx+totW/2}" y="${curY+tblHeadH/2+6}" font-weight="600" text-anchor="middle" font-size="${fontSize+2}" fill="${dark}">Totale</text>`;
            curY += tblHeadH;
        }

        // Rows
        sorted.forEach(([key, det], idx) => {
            const rowY = curY + (idx * rowH);
            svgHtml += `<line x1="${padX}" y1="${rowY+rowH}" x2="${width-padX}" y2="${rowY+rowH}" stroke="#e2e8f0" stroke-width="1.5"/>`;
            
            const txt = det.displayText || key;
            const maxL = 95;
            const trunc = txt.length > maxL ? txt.substring(0, maxL)+'...' : txt;
            
            let txtX = padX + 20;
            const txtY = rowY + rowH/2 + fontSize/2.5;

            if (det.isIstituzionale) {
                svgHtml += `<g transform="translate(${txtX}, ${rowY+rowH/2-9})"><path d="${ICON_PATHS_PED.flag}" fill="${blue}"/></g>`;
                txtX += flagW;
            }
            svgHtml += `<text x="${txtX}" y="${txtY}" font-size="${fontSize}" fill="${dark}">${escapeXML(trunc)}</text>`;

            let cx = padX + argW;
            CHANNELS_ORDER_PED.forEach(ch => {
                const c = det.channels[ch] || 0;
                if (c > 0) svgHtml += `<text x="${cx+chanW/2}" y="${txtY}" text-anchor="middle" font-size="${fontSize}" fill="${dark}">${c}</text>`;
                cx += chanW;
            });
            svgHtml += `<text x="${cx+totW/2}" y="${txtY}" text-anchor="middle" font-weight="700" font-size="${fontSize}" fill="${blue}">${det.totalPosts}</text>`;
        });

        // Footer (Only Con Loghi)
        if (layoutStyle !== 'senza-loghi') {
            const footH = fontSize + 30;
            const footY = curY + contentH;
            svgHtml += `<rect x="${padX}" y="${footY}" width="${width-2*padX}" height="${footH}" fill="#f0f2f5"/>`;
            let cx = padX + argW;
            CHANNELS_ORDER_PED.forEach(ch => {
                const c = data.channels[ch] || 0;
                if (c > 0) svgHtml += `<text x="${cx+chanW/2}" y="${footY+footH/2+7}" text-anchor="middle" font-weight="700" font-size="${fontSize+2}" fill="${blue}">${c}</text>`;
                cx += chanW;
            });
            svgHtml += `<text x="${cx+totW/2}" y="${footY+footH/2+7}" text-anchor="middle" font-weight="700" font-size="${fontSize+2}" fill="${blue}">${data.totalPosts}</text>`;
            curY = footY + footH + padY; 
        } else {
            curY += contentH + padY;
        }

        return `<svg width="${width}" height="${curY}" viewBox="0 0 ${width} ${curY}" xmlns="http://www.w3.org/2000/svg" style="font-family: 'Nunito Sans', sans-serif;">${svgHtml}</svg>`;
    }

    // 5. DOWNLOAD UTILS
    window.downloadSinglePed = function(label) {
        const svgEl = document.querySelector(`#ped-svg-${label.replace(/[^a-z0-9]/gi, '_')} svg`);
        if (svgEl) downloadSvgDirect(svgEl, `Report_PED_${label}.svg`);
    }

    window.downloadAllPedZip = function() {
        if (!globalProcessedDataPed || Object.keys(globalProcessedDataPed).length === 0) return;
        const zip = new JSZip();
        const layoutStyle = document.querySelector('input[name="layout-style"]:checked').value;
        const useColors = document.getElementById('ped-logo-color-toggle').checked;
        
        for (const label in globalProcessedDataPed) {
            const svgStr = generatePedSVG(label, globalProcessedDataPed[label], layoutStyle, useColors);
            zip.file(`${label}.svg`, svgStr);
        }
        
        zip.generateAsync({type:"blob"}).then(content => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(content);
            a.download = "Report_PED_Completo.zip";
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        });
    }

    // --- FUNZIONE RESET ---
    window.resetDashboard = function() {
        if(confirm("Vuoi davvero cancellare i dati attuali e iniziare una nuova analisi?")) {
            localStorage.removeItem('social_dashboard_data');
            localStorage.removeItem('social_dashboard_source');
            window.location.reload();
        }
    }

    // --- NUOVO: INCOLLA DA EDITOR ---
    window.pasteFromEditor = async function() {
        try {
            // Leggi dagli appunti
            const text = await navigator.clipboard.readText();
            if (!text) return alert("Gli appunti sembrano vuoti.");
            
            let pastedData;
            try { 
                pastedData = JSON.parse(text); 
            } catch(e) { 
                return alert("Il contenuto degli appunti non è valido (non è un JSON corretto)."); 
            }

            if (!Array.isArray(pastedData) || pastedData.length === 0) {
                return alert("Nessun dato valido trovato negli appunti.");
            }

            // Carica i dati in memoria
            rawData = pastedData;
            
            // Configura le colonne (i dati dall'Editor hanno chiavi standard)
            cols = {
                data: 'Data', canale: 'Canale', vis: 'Visualizzazioni', inter: 'Interazioni',
                label: 'Label', campagna: 'Campagna', arg: 'Argomento', copy: 'Copy',
                link: 'Link', like: 'Like e reazioni', cond: 'Condivisioni',
                istituzionale: 'Istituzionale'
            };

            // Filtra solo editoriale e aggiorna
            filteredData = rawData.filter(r => String(r[cols.campagna]).trim().toLowerCase() === 'editoriale');
            displayData = [...filteredData];

            // Aggiorna Interfaccia
            if(uploadBox) uploadBox.style.display = 'none';
            mainContent.style.display = 'block'; 
            jsonExecBtn.style.display = 'inline-block';
            
            populateFilterUI();
            renderAll(displayData);
            
            showToast("✅ Dati incollati e caricati con successo!", "success");

        } catch(err) {
            console.error("Errore Incolla:", err);
            alert("Impossibile leggere dagli appunti. Assicurati di aver dato i permessi al browser.\nErrore: " + err.message);
        }
    }

    // --- FUNZIONE BRIDGE VERSO EDITOR (ROBUSTA) ---
    window.sendToEditor = function() {
        if (typeof rawData === 'undefined' || rawData.length === 0) {
            alert('Nessun dato caricato da trasferire.');
            return;
        }
        
        try {
            // Usa le colonne mappate globalmente (cols) che sono già corrette
            const standardData = rawData.map(r => {
                let argVal = r[cols.arg];
                let copyVal = r[cols.copy] || '';
                
                // Fallback: Se argomento manca, usa il copy
                if (!argVal) { argVal = copyVal ? (copyVal.substring(0, 40) + '...') : 'Nuovo Argomento'; }
                
                let labelVal = r[cols.label];
                if (!labelVal) labelVal = 'Da Categorizzare';

                // Cerca etichette originali (potrebbero non essere in cols)
                const rawLabels = r['OriginalLabels'] || r['Labels'] || r[cols.label] || '';

                return {
                    'Data': r[cols.data] || '',
                    'Canale': r[cols.canale] || '',
                    'Visualizzazioni': r[cols.vis] || '',
                    'Interazioni': r[cols.inter] || '',
                    'Label': labelVal,
                    'Campagna': r[cols.campagna] || '',
                    'Argomento': argVal,
                    'Copy': copyVal,
                    'Link': r[cols.link] || '',
                    'Dettagli Emplifi': r['Dettagli Emplifi'] || '',
                    'Like e reazioni': r[cols.like] || '',
                    'Condivisioni': r[cols.cond] || '',
                    'Commenti': r['Commenti'] || '', 
                    'Istituzionale': r[cols.istituzionale] || '',
                    'OriginalLabels': rawLabels
                };
            });

            const jsonStr = JSON.stringify(standardData);
            
            // --- MODIFICA: SALVATAGGIO IN LOCAL STORAGE ---
            localStorage.setItem('social_dashboard_data', jsonStr);
            localStorage.setItem('social_dashboard_source', 'bridge');
            window.location.href = 'editor.html';

        } catch(e) {
            console.error("Errore export verso editor", e);
            alert("Errore tecnico durante l'invio dati all'Editor: " + e.message);
        }
    }
  </script>
</body>
</html>
